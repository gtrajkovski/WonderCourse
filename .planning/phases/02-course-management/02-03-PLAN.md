---
phase: 02-course-management
plan: 03
type: execute
wave: 2
depends_on: ["02-02"]
files_modified:
  - src/api/lessons.py
  - src/api/activities.py
  - tests/test_lessons_api.py
  - tests/test_activities_api.py
autonomous: true

must_haves:
  truths:
    - "User can add a lesson to a module"
    - "User can remove a lesson from a module"
    - "User can reorder lessons within a module"
    - "User can add an activity to a lesson"
    - "User can remove an activity from a lesson"
    - "User can reorder activities within a lesson"
    - "Deleting a lesson cleans up learning outcome mappings for its activities"
  artifacts:
    - path: "src/api/lessons.py"
      provides: "Lesson CRUD endpoints as Flask Blueprint"
      exports: ["lessons_bp"]
    - path: "src/api/activities.py"
      provides: "Activity CRUD endpoints as Flask Blueprint"
      exports: ["activities_bp"]
    - path: "tests/test_lessons_api.py"
      provides: "Lesson API endpoint tests"
    - path: "tests/test_activities_api.py"
      provides: "Activity API endpoint tests"
  key_links:
    - from: "src/api/lessons.py"
      to: "src/core/project_store.py"
      via: "Atomic load-modify-save"
      pattern: "project_store\\.save"
    - from: "src/api/activities.py"
      to: "src/core/project_store.py"
      via: "Atomic load-modify-save"
      pattern: "project_store\\.save"
---

<objective>
Create lesson and activity CRUD API endpoints following the Blueprint pattern established in 02-02. Lessons nest under modules, activities nest under lessons. Use 2-level URL nesting per research recommendations.

Purpose: COURSE-08 (lesson management) and COURSE-09 (activity management) require adding, removing, and reordering these nested structures.
Output: Lesson and Activity API Blueprints with CRUD + reorder, registered in app.py, with tests.
</objective>

<execution_context>
@C:\Users\gpt30\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\gpt30\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-course-management/02-RESEARCH.md
@.planning/phases/02-course-management/02-02-SUMMARY.md
@src/core/models.py
@src/api/modules.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create lesson API Blueprint with CRUD and reorder</name>
  <files>src/api/lessons.py, app.py, tests/test_lessons_api.py</files>
  <action>
Create `src/api/lessons.py` with Blueprint `lessons_bp` following the same init pattern as modules.py.

Endpoints:

1. `GET /api/courses/<course_id>/modules/<module_id>/lessons` — List all lessons in a module, sorted by order.

2. `POST /api/courses/<course_id>/modules/<module_id>/lessons` — Create lesson. Body: `{"title": str, "description": str (optional)}`. Auto-assigns order. Returns 201.

3. `PUT /api/lessons/<lesson_id>` — Update lesson title/description. Uses direct resource route (not nested 3-level). Must find lesson by traversing course structure. Body: `{"course_id": str, "title": str, "description": str}`. The course_id is needed to load the course. Returns updated lesson dict.

   Alternative simpler approach: Keep 2-level nesting but include course_id in the URL:
   `PUT /api/courses/<course_id>/lessons/<lesson_id>` — This avoids needing course_id in body and keeps URL clean.

4. `DELETE /api/courses/<course_id>/lessons/<lesson_id>` — Delete lesson. Find lesson across all modules. Collect activity IDs from lesson. Clean outcome mappings. Remove lesson. Renumber remaining lessons in that module. Returns 200.

5. `PUT /api/courses/<course_id>/modules/<module_id>/lessons/reorder` — Reorder lessons within module. Body: `{"old_index": int, "new_index": int}`. Validates indices. Renumbers all lessons. Returns updated lessons list.

Helper function to find lesson and its parent module:
```python
def _find_lesson(course, lesson_id):
    for module in course.modules:
        for lesson in module.lessons:
            if lesson.id == lesson_id:
                return lesson, module
    return None, None
```

Register in app.py alongside modules_bp.

Create tests/test_lessons_api.py with:
- test_create_lesson: Create module first, then lesson, verify 201
- test_list_lessons: Create 2 lessons, GET list, verify count and order
- test_update_lesson: Create lesson, PUT update, verify new title
- test_delete_lesson: Create lesson, DELETE, verify removed
- test_delete_lesson_cleans_outcome_mappings: Lesson with activity mapped to outcome, delete lesson, verify mapping cleaned
- test_reorder_lessons: Create 3 lessons, reorder, verify new order values
- test_create_lesson_module_not_found: POST to invalid module, verify 404
  </action>
  <verify>Run `py -3 -m pytest tests/test_lessons_api.py -v` — all 7 tests pass</verify>
  <done>Lesson Blueprint has list, create, update, delete, reorder endpoints. 7+ tests pass.</done>
</task>

<task type="auto">
  <name>Task 2: Create activity API Blueprint with CRUD and reorder</name>
  <files>src/api/activities.py, app.py, tests/test_activities_api.py</files>
  <action>
Create `src/api/activities.py` with Blueprint `activities_bp` following same init pattern.

Endpoints:

1. `GET /api/courses/<course_id>/lessons/<lesson_id>/activities` — List all activities in a lesson, sorted by order.

2. `POST /api/courses/<course_id>/lessons/<lesson_id>/activities` — Create activity. Body: `{"title": str, "content_type": str (optional, default "video"), "activity_type": str (optional, default "video_lecture")}`. Auto-assigns order. Returns 201 with activity dict.

3. `PUT /api/courses/<course_id>/activities/<activity_id>` — Update activity fields. Body can include any Activity fields: title, content_type, activity_type, wwhaa_phase, content, bloom_level, word_count, estimated_duration_minutes. Enum fields accept string values. Returns updated activity dict.

4. `DELETE /api/courses/<course_id>/activities/<activity_id>` — Delete activity. Find activity across all modules/lessons. Clean outcome mappings (remove activity_id from all mapped_activity_ids). Remove activity. Renumber remaining activities in that lesson. Returns 200.

5. `PUT /api/courses/<course_id>/lessons/<lesson_id>/activities/reorder` — Reorder activities within lesson. Body: `{"old_index": int, "new_index": int}`. Returns updated activities list.

Helper function to find activity and its parent lesson:
```python
def _find_activity(course, activity_id):
    for module in course.modules:
        for lesson in module.lessons:
            for activity in lesson.activities:
                if activity.id == activity_id:
                    return activity, lesson
    return None, None
```

For enum field updates in PUT, convert string values to enum:
```python
if 'content_type' in data:
    activity.content_type = ContentType(data['content_type'])
if 'activity_type' in data:
    activity.activity_type = ActivityType(data['activity_type'])
if 'wwhaa_phase' in data:
    activity.wwhaa_phase = WWHAAPhase(data['wwhaa_phase'])
if 'bloom_level' in data:
    activity.bloom_level = BloomLevel(data['bloom_level']) if data['bloom_level'] else None
```

Register in app.py alongside other blueprints.

Create tests/test_activities_api.py with:
- test_create_activity: Create module+lesson first, then activity, verify 201
- test_create_activity_with_types: Create with content_type="reading", activity_type="reading_material"
- test_list_activities: Create 2 activities, GET list, verify count and order
- test_update_activity: Update title and content_type, verify changes
- test_update_activity_wwhaa_phase: Update wwhaa_phase to "hook", verify enum stored correctly
- test_delete_activity: Delete activity, verify removed
- test_delete_activity_cleans_outcome_mappings: Activity mapped to outcome, delete, verify mapping cleaned
- test_reorder_activities: Create 3 activities, reorder, verify new order
  </action>
  <verify>Run `py -3 -m pytest tests/test_activities_api.py -v` — all 8 tests pass</verify>
  <done>Activity Blueprint has list, create, update, delete, reorder endpoints. Enum fields correctly handled. 8+ tests pass.</done>
</task>

</tasks>

<verification>
```bash
py -3 -m pytest tests/test_lessons_api.py tests/test_activities_api.py tests/test_modules_api.py tests/test_app.py -v
```
All tests pass across all API test files. No regressions.
</verification>

<success_criteria>
- Lesson CRUD + reorder endpoints work under /api/courses/<id>/modules/<mid>/lessons
- Activity CRUD + reorder endpoints work under /api/courses/<id>/lessons/<lid>/activities
- Cascading cleanup on delete (outcome mappings)
- All enum fields correctly serialized/deserialized in activity updates
- 15+ new tests pass across both files
</success_criteria>

<output>
After completion, create `.planning/phases/02-course-management/02-03-SUMMARY.md`
</output>
