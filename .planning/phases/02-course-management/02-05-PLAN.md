---
phase: 02-course-management
plan: 05
type: execute
wave: 3
depends_on: ["02-03", "02-04"]
files_modified:
  - src/api/learning_outcomes.py
  - src/api/activities.py
  - tests/test_outcome_mapping_api.py
autonomous: true

must_haves:
  truths:
    - "User can map a learning outcome to one or more activities"
    - "User can unmap a learning outcome from an activity"
    - "User can view which activities are mapped to each outcome"
    - "User can view which outcomes are mapped to each activity"
    - "Mapping is idempotent (mapping same pair twice has no effect)"
    - "Mapping validates that both outcome and activity exist"
  artifacts:
    - path: "src/api/learning_outcomes.py"
      provides: "Mapping endpoints added to existing outcome Blueprint"
      contains: "map"
    - path: "tests/test_outcome_mapping_api.py"
      provides: "Outcome mapping API tests"
      contains: "def test_"
  key_links:
    - from: "src/api/learning_outcomes.py"
      to: "src/core/models.py"
      via: "LearningOutcome.mapped_activity_ids list manipulation"
      pattern: "mapped_activity_ids"
---

<objective>
Add outcome-to-activity mapping endpoints that allow users to link learning outcomes to activities and query the alignment. Mapping is stored unidirectionally in LearningOutcome.mapped_activity_ids with query helpers for reverse lookups.

Purpose: COURSE-12 requires mapping learning outcomes to activities for alignment tracking.
Output: Mapping/unmapping endpoints, alignment query endpoints, with tests.
</objective>

<execution_context>
@C:\Users\gpt30\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\gpt30\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-course-management/02-03-SUMMARY.md
@.planning/phases/02-course-management/02-04-SUMMARY.md
@src/core/models.py
@src/api/learning_outcomes.py
@src/api/activities.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add mapping and alignment query endpoints</name>
  <files>src/api/learning_outcomes.py</files>
  <action>
Add these endpoints to the existing learning_outcomes_bp Blueprint:

1. `POST /api/courses/<course_id>/outcomes/<outcome_id>/map` — Map outcome to activity. Body: `{"activity_id": str}`. Validates outcome exists. Validates activity exists by traversing course modules/lessons/activities. Adds activity_id to outcome.mapped_activity_ids if not already present (idempotent). Returns 200 with updated outcome dict.

2. `DELETE /api/courses/<course_id>/outcomes/<outcome_id>/map/<activity_id>` — Unmap outcome from activity. Removes activity_id from outcome.mapped_activity_ids. Returns 200. Returns 404 if outcome not found. Returns 200 even if activity_id wasn't in mapping (idempotent).

3. `GET /api/courses/<course_id>/alignment` — Get full alignment matrix. Returns JSON object:
   ```json
   {
     "outcomes": [
       {
         "id": "lo_xxx",
         "behavior": "implement a REST API",
         "bloom_level": "apply",
         "mapped_activities": [
           {"id": "act_xxx", "title": "Build API", "content_type": "video"}
         ]
       }
     ],
     "unmapped_outcomes": ["lo_yyy"],
     "unmapped_activities": ["act_zzz"],
     "coverage_score": 0.75
   }
   ```
   - `unmapped_outcomes`: outcome IDs with empty mapped_activity_ids
   - `unmapped_activities`: activity IDs not appearing in any outcome's mapping
   - `coverage_score`: ratio of mapped outcomes to total outcomes (0.0 to 1.0)

   Helper to get all activities from course:
   ```python
   def _get_all_activities(course):
       activities = []
       for module in course.modules:
           for lesson in module.lessons:
               activities.extend(lesson.activities)
       return activities
   ```

4. `GET /api/courses/<course_id>/activities/<activity_id>/outcomes` — Get outcomes mapped to a specific activity (reverse lookup). Returns JSON array of outcome dicts where activity_id is in mapped_activity_ids.

All endpoints use atomic load-modify-save via project_store.
  </action>
  <verify>Verify endpoints exist: `py -3 -c "from src.api.learning_outcomes import learning_outcomes_bp; print(len(learning_outcomes_bp.deferred_functions))"`</verify>
  <done>Mapping endpoints (map, unmap) and alignment query endpoints (alignment matrix, reverse lookup) added to learning_outcomes_bp.</done>
</task>

<task type="auto">
  <name>Task 2: Add tests for outcome mapping and alignment</name>
  <files>tests/test_outcome_mapping_api.py</files>
  <action>
Create tests/test_outcome_mapping_api.py with fixture that sets up a course with:
- 1 module with 2 lessons, each lesson with 2 activities (4 activities total)
- 2 learning outcomes

Helper fixture:
```python
@pytest.fixture
def seeded_course(client):
    """Create course with modules, lessons, activities, and outcomes."""
    # Create course
    resp = client.post('/api/courses', json={"title": "Test Course"})
    course_id = resp.get_json()['id']

    # Create module
    resp = client.post(f'/api/courses/{course_id}/modules', json={"title": "Module 1"})
    module_id = resp.get_json()['id']

    # Create 2 lessons with 2 activities each
    # ... (create lesson, create activities)

    # Create 2 outcomes
    # ... (POST outcomes)

    return course_id, module_id, lesson_ids, activity_ids, outcome_ids
```

Tests:

1. test_map_outcome_to_activity: Map outcome to activity, verify 200, verify activity_id in outcome's mapped_activity_ids
2. test_map_idempotent: Map same pair twice, verify mapped_activity_ids has no duplicates
3. test_map_invalid_outcome: Map with nonexistent outcome_id, verify 404
4. test_map_invalid_activity: Map with nonexistent activity_id, verify 404 or 400
5. test_unmap_outcome_from_activity: Map then unmap, verify activity_id removed
6. test_unmap_nonexistent_mapping: Unmap activity that wasn't mapped, verify 200 (idempotent)
7. test_alignment_matrix: Map 1 outcome to 2 activities, leave 1 outcome unmapped, verify alignment response has correct mapped_activities, unmapped_outcomes, unmapped_activities, and coverage_score
8. test_alignment_empty_course: Get alignment for course with no outcomes, verify empty response with coverage_score 0
9. test_reverse_lookup: Map outcome to activity, GET /activities/<id>/outcomes, verify outcome returned
10. test_reverse_lookup_no_mappings: GET outcomes for unmapped activity, verify empty list
  </action>
  <verify>Run `py -3 -m pytest tests/test_outcome_mapping_api.py -v` — all 10 tests pass</verify>
  <done>10 tests covering mapping, unmapping, idempotency, validation, alignment matrix, and reverse lookup all pass.</done>
</task>

</tasks>

<verification>
```bash
py -3 -m pytest tests/ -v
```
All tests pass (88 existing + new module/lesson/activity/outcome/mapping tests). Total should be ~130+ tests.
</verification>

<success_criteria>
- POST .../outcomes/<oid>/map maps outcome to activity (idempotent)
- DELETE .../outcomes/<oid>/map/<aid> unmaps outcome from activity
- GET .../alignment returns coverage matrix with score
- GET .../activities/<aid>/outcomes returns reverse lookup
- Mapping validates both outcome and activity exist
- 10+ new tests pass
- All existing tests still pass
</success_criteria>

<output>
After completion, create `.planning/phases/02-course-management/02-05-SUMMARY.md`
</output>
