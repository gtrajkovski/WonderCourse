---
phase: 08-export-publishing
plan: 06
type: execute
wave: 3
depends_on: ["08-02", "08-03", "08-04", "08-05"]
files_modified:
  - src/api/export.py
  - src/exporters/__init__.py
  - app.py
  - tests/test_export_api.py
autonomous: true

must_haves:
  truths:
    - "User can download instructor package via API"
    - "User can download LMS manifest via API"
    - "User can download DOCX textbook via API"
    - "User can download SCORM package via API"
    - "User can preview export contents before downloading"
  artifacts:
    - path: "src/api/export.py"
      provides: "Export API Blueprint"
      exports: ["export_bp", "init_export_bp"]
    - path: "tests/test_export_api.py"
      provides: "API integration tests"
      min_lines: 100
  key_links:
    - from: "src/api/export.py"
      to: "src/exporters/__init__.py"
      via: "Exporter imports"
      pattern: "from src.exporters import"
    - from: "src/api/export.py"
      to: "flask.send_file"
      via: "File streaming"
      pattern: "from flask import.*send_file"
    - from: "app.py"
      to: "src/api/export.py"
      via: "Blueprint registration"
      pattern: "init_export_bp"
---

<objective>
Create Export API endpoints for all export formats with preview functionality, wire to Flask app.

Purpose: Requirements PUB-01 through PUB-05 - Complete export API with preview before download.
Output: Working API endpoints for all export formats with preview.
</objective>

<execution_context>
@C:\Users\gpt30\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\gpt30\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-export-publishing/08-RESEARCH.md
@.planning/phases/08-export-publishing/08-01-SUMMARY.md
@.planning/phases/08-export-publishing/08-02-SUMMARY.md
@.planning/phases/08-export-publishing/08-03-SUMMARY.md
@.planning/phases/08-export-publishing/08-04-SUMMARY.md
@.planning/phases/08-export-publishing/08-05-SUMMARY.md
@src/api/build_state.py
@app.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Export API Blueprint with all endpoints</name>
  <files>src/api/export.py</files>
  <action>
Create `src/api/export.py` following the Flask Blueprint pattern from src/api/build_state.py:

1. Module-level structure:
```python
from flask import Blueprint, send_file, jsonify
from src.exporters import (
    ExportValidator,
    InstructorPackageExporter,
    LMSManifestExporter,
    DOCXTextbookExporter,
    SCORMPackageExporter
)

export_bp = Blueprint('export', __name__)
_project_store = None
_export_validator = None

def init_export_bp(project_store):
    global _project_store, _export_validator
    _project_store = project_store
    _export_validator = ExportValidator()
```

2. Preview endpoint:
```
GET /api/courses/<course_id>/export/preview?format=instructor|lms|docx|scorm

Returns:
{
  "format": "instructor",
  "course_id": "...",
  "course_title": "...",
  "ready": true|false,
  "files": ["syllabus.txt", "lesson_plans/...", ...],
  "missing_content": [],
  "validation_errors": [],
  "warnings": []
}
```

3. Download endpoints (all use same pattern):
```
GET /api/courses/<course_id>/export/instructor  -> ZIP download
GET /api/courses/<course_id>/export/lms         -> JSON download
GET /api/courses/<course_id>/export/docx        -> DOCX download
GET /api/courses/<course_id>/export/scorm       -> ZIP download
```

Each download endpoint:
- Load course from project_store
- Return 404 if not found
- Run ExportValidator.validate_for_export()
- If not ready and ?force=true not in query, return 400 with validation result
- If ready or force=true, run exporter.export(course)
- Return send_file(buffer, mimetype=exporter.content_type, as_attachment=True, download_name=filename)

4. Helper function:
```python
def _get_exporter(format: str):
    """Return exporter for format, or None if invalid."""
    exporters = {
        'instructor': InstructorPackageExporter(),
        'lms': LMSManifestExporter(),
        'docx': DOCXTextbookExporter(),
        'scorm': SCORMPackageExporter()
    }
    return exporters.get(format)
```

5. Error handling:
- 404: Course not found
- 400: Invalid format, or not ready without force=true
- 500: Export error (catch exceptions, return error message)
  </action>
  <verify>
`python -c "from src.api.export import export_bp, init_export_bp; print('OK')"`
  </verify>
  <done>Export API Blueprint with preview and 4 download endpoints</done>
</task>

<task type="auto">
  <name>Task 2: Register Blueprint in app.py and update exporters __init__</name>
  <files>app.py, src/exporters/__init__.py</files>
  <action>
1. Update `src/exporters/__init__.py` to export all classes:
```python
from src.exporters.base_exporter import BaseExporter
from src.exporters.export_validator import ExportValidator
from src.exporters.instructor_package import InstructorPackageExporter
from src.exporters.lms_manifest import LMSManifestExporter
from src.exporters.docx_textbook import DOCXTextbookExporter
from src.exporters.scorm_package import SCORMPackageExporter

__all__ = [
    'BaseExporter',
    'ExportValidator',
    'InstructorPackageExporter',
    'LMSManifestExporter',
    'DOCXTextbookExporter',
    'SCORMPackageExporter'
]
```

2. Update `app.py` to register export_bp:
- Add import: `from src.api.export import export_bp, init_export_bp`
- In the blueprint registration section (after other init_*_bp calls):
  ```python
  init_export_bp(project_store)
  app.register_blueprint(export_bp)
  ```
  </action>
  <verify>
`python -c "from app import app; print('Routes:', [r.rule for r in app.url_map.iter_rules() if 'export' in r.rule])"`
  </verify>
  <done>Export Blueprint registered, routes visible</done>
</task>

<task type="auto">
  <name>Task 3: Write API integration tests</name>
  <files>tests/test_export_api.py</files>
  <action>
Create `tests/test_export_api.py` with comprehensive API tests:

1. Fixtures:
- Use client, tmp_store from conftest.py
- Create course_with_content fixture: Course with modules, lessons, activities that have content

2. Preview endpoint tests:
- test_preview_instructor_format: GET /api/courses/.../export/preview?format=instructor returns files list
- test_preview_invalid_format: GET with invalid format returns 400
- test_preview_missing_course: GET for non-existent course returns 404
- test_preview_shows_missing_content: Course with empty content shows missing_content list
- test_preview_shows_ready_when_complete: Complete course shows ready=true

3. Download endpoint tests:
- test_download_instructor_package: GET /api/courses/.../export/instructor returns ZIP
- test_download_lms_manifest: GET /api/courses/.../export/lms returns JSON
- test_download_docx_textbook: GET /api/courses/.../export/docx returns DOCX
- test_download_scorm_package: GET /api/courses/.../export/scorm returns ZIP
- test_download_missing_course: Returns 404
- test_download_not_ready_without_force: Returns 400 when validation fails
- test_download_with_force_flag: ?force=true bypasses validation

4. Content-Type verification:
- test_instructor_content_type: application/zip
- test_lms_content_type: application/json
- test_docx_content_type: application/vnd.openxmlformats-officedocument.wordprocessingml.document
- test_scorm_content_type: application/zip

Use pytest fixtures and client.get() pattern from other API tests.
  </action>
  <verify>
`pytest tests/test_export_api.py -v`
  </verify>
  <done>15+ API tests passing for all export endpoints</done>
</task>

</tasks>

<verification>
```bash
# All exports work
python -c "from src.exporters import BaseExporter, ExportValidator, InstructorPackageExporter, LMSManifestExporter, DOCXTextbookExporter, SCORMPackageExporter; print('OK')"

# API routes registered
python -c "from app import app; routes = [r.rule for r in app.url_map.iter_rules() if 'export' in r.rule]; print('Export routes:', routes); assert len(routes) >= 5"

# Tests pass
pytest tests/test_export_api.py -v

# Full test suite still passes
pytest --tb=short
```
</verification>

<success_criteria>
- Export API Blueprint with init_export_bp(project_store)
- Preview endpoint returns file list and validation status
- 4 download endpoints (instructor, lms, docx, scorm)
- force=true query param bypasses validation
- Blueprint registered in app.py
- All exporters in __init__.py
- 15+ API tests passing
- Full test suite passing
</success_criteria>

<output>
After completion, create `.planning/phases/08-export-publishing/08-06-SUMMARY.md`
</output>
