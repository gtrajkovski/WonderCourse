---
phase: 08-export-publishing
plan: 04
type: tdd
wave: 2
depends_on: ["08-01"]
files_modified:
  - src/exporters/docx_textbook.py
  - tests/test_docx_textbook.py
autonomous: true

must_haves:
  truths:
    - "User can export textbook as DOCX file"
    - "DOCX contains chapters with proper heading hierarchy"
    - "DOCX includes references and glossary sections"
  artifacts:
    - path: "src/exporters/docx_textbook.py"
      provides: "DOCX textbook exporter"
      exports: ["DOCXTextbookExporter"]
    - path: "tests/test_docx_textbook.py"
      provides: "TDD tests for DOCX textbook"
      min_lines: 80
  key_links:
    - from: "src/exporters/docx_textbook.py"
      to: "src/exporters/base_exporter.py"
      via: "BaseExporter inheritance"
      pattern: "class DOCXTextbookExporter\\(BaseExporter\\)"
    - from: "src/exporters/docx_textbook.py"
      to: "docx"
      via: "python-docx import"
      pattern: "from docx import Document"
---

<objective>
Implement DOCXTextbookExporter using TDD to create formatted Word documents from textbook chapters.

Purpose: Requirement PUB-03 - User can export textbook as DOCX.
Output: Working exporter with comprehensive test coverage.
</objective>

<execution_context>
@C:\Users\gpt30\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\gpt30\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-export-publishing/08-RESEARCH.md
@.planning/phases/08-export-publishing/08-01-SUMMARY.md
@src/exporters/base_exporter.py
@src/core/models.py
@src/generators/schemas/textbook.py
</context>

<feature>
  <name>DOCXTextbookExporter</name>
  <files>src/exporters/docx_textbook.py, tests/test_docx_textbook.py</files>
  <behavior>
DOCXTextbookExporter.export(course) -> (BytesIO, filename)

Uses course.textbook_chapters (List[TextbookChapter]) to generate DOCX.

TextbookChapter structure (from models.py):
- title: str
- sections: List[Dict[str, str]] with {"heading": str, "content": str}
- glossary_terms: List[Dict[str, str]] with {"term": str, "definition": str}
- references: List[Dict[str, str]] with {"authors": str, "year": str, "title": str, "source": str}
- image_placeholders: List[Dict[str, str]] with {"figure_number": str, "caption": str, "alt_text": str}
- word_count: int
- learning_outcome_id: Optional[str]

DOCX Structure:
```
Title Page:
  {course.title}
  Textbook

Table of Contents (built-in TOC field)

Chapter 1: {chapter.title}
  {introduction paragraph - from first section or generate}

  {section.heading} (Heading 2)
  {section.content}

  [Figure X.X: {caption}] (image placeholder as italic text)

  ...more sections...

  Glossary (Heading 2)
  {term}: {definition}

  References (Heading 2)
  {APA formatted reference}

Page Break

Chapter 2: ...
```

Image placeholder format (since we don't have actual images):
"[Figure {figure_number}: {caption}]" in italic

Reference format (APA 7):
"{authors} ({year}). {title}. {source}."

Test cases:
- export_creates_valid_docx: Verify DOCX is valid and readable by python-docx
- export_contains_title_page: Course title appears in document
- export_contains_chapters: Each textbook chapter creates chapter content
- export_contains_sections: Sections with heading + content for each chapter
- export_contains_glossary: Glossary terms appear in each chapter
- export_contains_references: APA references appear in each chapter
- export_contains_image_placeholders: Placeholder text for images (italic)
- export_handles_empty_textbook: Course with no chapters produces minimal DOCX
- export_handles_chapter_page_breaks: Page breaks between chapters
  </behavior>
  <implementation>
1. RED: Write failing tests first
2. GREEN: Implement DOCXTextbookExporter
   - Inherit from BaseExporter
   - content_type = "application/vnd.openxmlformats-officedocument.wordprocessingml.document"
   - file_extension = ".docx"
   - export() method:
     a. Create Document()
     b. Add title page (course title as Heading 0/Title style)
     c. For each TextbookChapter:
        - Add chapter title as Heading 1
        - Add each section: heading as Heading 2, content as paragraph
        - Add image placeholders as italic paragraphs
        - Add Glossary section (Heading 2) with term: definition paragraphs
        - Add References section (Heading 2) with APA formatted references
        - Add page break (except after last chapter)
     d. Save to BytesIO, seek(0), return
   - Helper methods: _add_title_page(), _add_chapter(), _add_section(), _add_glossary(), _add_references(), _format_reference_apa()
   - Use: from docx import Document
   - Use: from docx.shared import Pt, Inches (if needed for formatting)
3. REFACTOR if needed

Note: TextbookChapter is a dataclass in models.py, sections/glossary_terms/references are List[Dict[str, str]]
  </implementation>
</feature>

<verification>
```bash
# TDD cycle
pytest tests/test_docx_textbook.py -v

# Import check
python -c "from src.exporters import DOCXTextbookExporter; print('OK')"

# Quick integration test
python -c "
from src.exporters import DOCXTextbookExporter
from src.core.models import Course, TextbookChapter
from docx import Document
from io import BytesIO

chapter = TextbookChapter(
    title='Chapter 1: Introduction',
    sections=[{'heading': 'Overview', 'content': 'This is the overview section.'}],
    glossary_terms=[{'term': 'API', 'definition': 'Application Programming Interface'}],
    references=[{'authors': 'Smith, J.', 'year': '2024', 'title': 'Testing Guide', 'source': 'Publisher'}],
    image_placeholders=[{'figure_number': 'Figure 1.1', 'caption': 'Architecture diagram', 'alt_text': 'System architecture'}],
    word_count=500
)
course = Course(title='Test Course')
course.textbook_chapters.append(chapter)

exporter = DOCXTextbookExporter()
buffer, filename = exporter.export(course)

# Verify it's a valid DOCX
doc = Document(BytesIO(buffer.getvalue()))
print('Paragraphs:', len(doc.paragraphs))
print('OK')
"
```
</verification>

<success_criteria>
- DOCXTextbookExporter extends BaseExporter
- export() returns valid DOCX in BytesIO
- DOCX contains title page, chapters, sections, glossary, references
- Image placeholders rendered as italic text
- Page breaks between chapters
- 9+ TDD tests passing
</success_criteria>

<output>
After completion, create `.planning/phases/08-export-publishing/08-04-SUMMARY.md`
</output>
