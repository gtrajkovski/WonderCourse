---
phase: 09-user-authentication
plan: 03
type: execute
wave: 2
depends_on: ["09-01", "09-02"]
files_modified:
  - src/auth/routes.py
  - tests/test_auth_api.py
autonomous: true

must_haves:
  truths:
    - "User can register with email and password via POST /api/auth/register"
    - "User can log in via POST /api/auth/login and receives session cookie"
    - "User can log out via POST /api/auth/logout and session is invalidated"
    - "Invalid credentials return 401 with generic error message"
    - "Duplicate email registration returns 400"
  artifacts:
    - path: "src/auth/routes.py"
      provides: "Auth API endpoints (register, login, logout)"
      exports: ["auth_bp", "init_auth_bp"]
    - path: "tests/test_auth_api.py"
      provides: "API tests for auth endpoints"
      min_lines: 100
  key_links:
    - from: "src/auth/routes.py"
      to: "src/auth/models.py"
      via: "User.create, User.get_by_email"
      pattern: "User\\.(create|get_by_email)"
    - from: "src/auth/routes.py"
      to: "flask_login"
      via: "login_user, logout_user"
      pattern: "(login_user|logout_user)"
---

<objective>
Create registration, login, and logout API endpoints that fulfill AUTH-01, AUTH-02, and AUTH-03 requirements.

Purpose: These endpoints are the entry points for user authentication. Registration creates users with hashed passwords, login establishes sessions, logout invalidates them.

Output:
- Auth blueprint with register/login/logout endpoints
- Rate limiting on login endpoint (brute-force protection)
- Comprehensive API tests
</objective>

<execution_context>
@C:\Users\gpt30\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\gpt30\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/09-user-authentication/09-RESEARCH.md
@.planning/phases/09-user-authentication/09-01-SUMMARY.md
@.planning/phases/09-user-authentication/09-02-SUMMARY.md

# API pattern reference
@src/api/modules.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create auth routes blueprint</name>
  <files>src/auth/routes.py</files>
  <action>
Create `src/auth/routes.py` with auth_bp Blueprint:

```python
from flask import Blueprint, request, jsonify
from flask_login import login_user, logout_user, login_required, current_user
from flask_limiter import Limiter
from flask_limiter.util import get_remote_address

from src.auth.models import User

auth_bp = Blueprint('auth', __name__)

# Rate limiter (will be initialized with app)
limiter = None

def init_auth_bp(app):
    """Initialize auth blueprint with app context."""
    global limiter
    limiter = Limiter(
        key_func=get_remote_address,
        app=app,
        default_limits=["200 per day", "50 per hour"],
        storage_uri="memory://"
    )
```

Endpoints:

**POST /api/auth/register**
- Accept: {email, password, name (optional)}
- Validate: email and password required, email format (basic check)
- Create user with User.create()
- Handle IntegrityError for duplicate email -> 400
- Return: {message, user: {id, email, name}} with 201

**POST /api/auth/login**
- Rate limit: 5 per minute (use @limiter.limit decorator)
- Accept: {email, password, remember (optional bool)}
- Get user by email
- Verify password with user.check_password()
- IMPORTANT: Return same "Invalid credentials" error for both user not found AND wrong password (prevents user enumeration)
- On success: login_user(user, remember=remember)
- Return: {message, user: {id, email, name}} with 200

**POST /api/auth/logout**
- Require: @login_required
- Call logout_user()
- Return: {message} with 200

**GET /api/auth/me**
- Require: @login_required
- Return: current_user.to_dict()

Export auth_bp and init_auth_bp from src/auth/__init__.py.
  </action>
  <verify>
`python -c "from src.auth.routes import auth_bp, init_auth_bp; print('Auth routes imported')"` succeeds
  </verify>
  <done>Auth blueprint with register, login, logout, and me endpoints</done>
</task>

<task type="auto">
  <name>Task 2: Create auth API tests</name>
  <files>tests/test_auth_api.py</files>
  <action>
Create `tests/test_auth_api.py`:

Fixtures:
- `client`: Flask test client with auth blueprint registered
- `init_db`: Initialize database before tests

Tests:

Registration tests:
- `test_register_success`: Valid email/password returns 201 with user data
- `test_register_missing_email`: Returns 400
- `test_register_missing_password`: Returns 400
- `test_register_duplicate_email`: Returns 400 with appropriate error

Login tests:
- `test_login_success`: Valid credentials return 200, sets session cookie
- `test_login_wrong_password`: Returns 401 "Invalid credentials"
- `test_login_unknown_email`: Returns 401 "Invalid credentials" (same as wrong password!)
- `test_login_remember_me`: remember=true sets longer session

Logout tests:
- `test_logout_success`: Logged-in user can logout, returns 200
- `test_logout_unauthenticated`: Returns 401

Me endpoint tests:
- `test_me_authenticated`: Returns current user data
- `test_me_unauthenticated`: Returns 401

Session persistence tests:
- `test_session_persists`: After login, subsequent requests are authenticated
- `test_session_cleared_after_logout`: After logout, me endpoint returns 401

Follow existing test patterns (see tests/test_app.py for Flask client usage).
  </action>
  <verify>
`pytest tests/test_auth_api.py -v` passes with all tests green
  </verify>
  <done>Comprehensive API tests for registration, login, and logout</done>
</task>

<task type="auto">
  <name>Task 3: Register auth blueprint with Flask app</name>
  <files>app.py</files>
  <action>
Update `app.py` to integrate auth:

1. Import and configure:
```python
from src.auth import init_app as init_auth
from src.auth.routes import auth_bp, init_auth_bp
from src.auth.login_manager import init_login_manager
from src.auth.db import init_db
```

2. Add config settings:
```python
app.config['SECRET_KEY'] = Config.SECRET_KEY
app.config['DATABASE'] = str(Config.DATABASE)
```

3. Initialize auth infrastructure (before blueprint registration):
```python
# Initialize auth
init_auth(app)  # Register db teardown
init_login_manager(app)  # Configure Flask-Login
init_auth_bp(app)  # Configure rate limiter

# Register auth blueprint
app.register_blueprint(auth_bp)
```

4. Add CLI command for database initialization:
```python
@app.cli.command('init-db')
def init_db_command():
    """Initialize the database."""
    init_db()
    print('Initialized the database.')
```
  </action>
  <verify>
`python -c "from app import app; print('App configured with auth')"` succeeds
Flask app starts without errors: `python app.py` (Ctrl+C to stop)
  </verify>
  <done>Auth blueprint registered with Flask app, init-db CLI command available</done>
</task>

</tasks>

<verification>
1. Register endpoint creates user with hashed password
2. Login endpoint authenticates and sets session
3. Logout endpoint clears session
4. Login returns same error for wrong password and unknown email
5. All 14+ auth API tests pass
6. Rate limiting works on login endpoint
</verification>

<success_criteria>
- POST /api/auth/register creates users (AUTH-01)
- POST /api/auth/login sets session cookie (AUTH-02)
- POST /api/auth/logout clears session (AUTH-03)
- Invalid login attempts return generic "Invalid credentials"
- Flask app runs with auth integration
</success_criteria>

<output>
After completion, create `.planning/phases/09-user-authentication/09-03-SUMMARY.md`
</output>
