---
phase: 09-user-authentication
plan: 04
type: execute
wave: 3
depends_on: ["09-03"]
files_modified:
  - src/api/modules.py
  - src/api/lessons.py
  - src/api/activities.py
  - src/api/learning_outcomes.py
  - src/api/blueprint.py
  - src/api/content.py
  - src/api/build_state.py
  - src/api/textbook.py
  - src/api/validation.py
  - src/api/export.py
  - app.py
  - tests/test_auth_middleware.py
autonomous: true

must_haves:
  truths:
    - "All API endpoints (except /api/auth/* and /api/system/health) require authentication"
    - "Unauthenticated requests to protected endpoints return 401"
    - "Authenticated requests proceed normally"
    - "Health endpoint remains public"
  artifacts:
    - path: "tests/test_auth_middleware.py"
      provides: "Tests verifying 401 on unauthenticated requests"
      min_lines: 60
  key_links:
    - from: "src/api/modules.py"
      to: "flask_login"
      via: "@login_required decorator on all routes"
      pattern: "@login_required"
---

<objective>
Add @login_required decorator to all existing API endpoints except auth and health, fulfilling AUTH-04 requirement.

Purpose: Every API endpoint that manages course data must require authentication. This prevents unauthorized access to course content.

Output:
- All 10 API blueprints protected with @login_required
- Tests verifying 401 response on unauthenticated requests
</objective>

<execution_context>
@C:\Users\gpt30\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\gpt30\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/09-user-authentication/09-03-SUMMARY.md

# API blueprints to modify
@src/api/modules.py
@src/api/lessons.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add @login_required to all API endpoints</name>
  <files>src/api/modules.py, src/api/lessons.py, src/api/activities.py, src/api/learning_outcomes.py, src/api/blueprint.py, src/api/content.py, src/api/build_state.py, src/api/textbook.py, src/api/validation.py, src/api/export.py</files>
  <action>
For each API blueprint file, add:

1. Import at top:
```python
from flask_login import login_required, current_user
```

2. Add `@login_required` decorator to EVERY route function, placed AFTER @blueprint.route():
```python
@modules_bp.route('/api/courses/<course_id>/modules', methods=['GET'])
@login_required  # Add this line
def list_modules(course_id):
    ...
```

Files to update and their route counts:
- `src/api/modules.py`: 5 routes (list, create, get, update, delete, reorder)
- `src/api/lessons.py`: 5 routes
- `src/api/activities.py`: 5 routes
- `src/api/learning_outcomes.py`: 7+ routes (CRUD + mapping)
- `src/api/blueprint.py`: 3 routes (generate, accept, refine)
- `src/api/content.py`: 3+ routes (generate, regenerate, update)
- `src/api/build_state.py`: 3 routes (progress, state, approve)
- `src/api/textbook.py`: routes for textbook generation
- `src/api/validation.py`: 2 routes (validate, publishable)
- `src/api/export.py`: 5 routes (preview + 4 download formats)

DO NOT add @login_required to:
- /api/auth/* routes (handled in auth blueprint)
- /api/system/health (public endpoint)
  </action>
  <verify>
`grep -r "@login_required" src/api/ | wc -l` shows 35+ occurrences (one per protected route)
  </verify>
  <done>All API endpoints protected with @login_required</done>
</task>

<task type="auto">
  <name>Task 2: Update app.py course endpoints</name>
  <files>app.py</files>
  <action>
Add @login_required to course endpoints in app.py:

1. Add import:
```python
from flask_login import login_required, current_user
```

2. Add @login_required to these routes:
- GET /api/courses
- POST /api/courses
- GET /api/courses/<course_id>
- PUT /api/courses/<course_id>
- DELETE /api/courses/<course_id>

3. DO NOT add to:
- / (root redirect)
- /dashboard (will need auth in Phase 11 UI)
- /api/system/health (must remain public)

Note: The dashboard route will get proper protection in Phase 11 when we build the UI. For now, API endpoints are the priority.
  </action>
  <verify>
`grep "@login_required" app.py | wc -l` shows 5 occurrences
  </verify>
  <done>Course API endpoints in app.py protected with @login_required</done>
</task>

<task type="auto">
  <name>Task 3: Create auth middleware tests</name>
  <files>tests/test_auth_middleware.py</files>
  <action>
Create `tests/test_auth_middleware.py`:

Fixtures:
- `client`: Flask test client with all blueprints
- `authenticated_client`: Client with logged-in user session
- `sample_course`: Create a course for authenticated user

Tests for unauthenticated access (all should return 401):
- `test_get_courses_unauthenticated`: GET /api/courses -> 401
- `test_create_course_unauthenticated`: POST /api/courses -> 401
- `test_get_modules_unauthenticated`: GET /api/courses/{id}/modules -> 401
- `test_generate_content_unauthenticated`: POST /api/.../generate -> 401
- `test_export_unauthenticated`: GET /api/courses/{id}/export/preview -> 401

Tests for public endpoints (should NOT return 401):
- `test_health_endpoint_public`: GET /api/system/health -> 200
- `test_register_public`: POST /api/auth/register -> 201 (or 400)
- `test_login_public`: POST /api/auth/login -> (any status, not 401 for no session)

Tests for authenticated access:
- `test_get_courses_authenticated`: GET /api/courses -> 200
- `test_create_course_authenticated`: POST /api/courses -> 201

Sample at least one endpoint from each blueprint to verify protection.
  </action>
  <verify>
`pytest tests/test_auth_middleware.py -v` passes with all tests green
  </verify>
  <done>Middleware tests verify 401 on protected endpoints</done>
</task>

</tasks>

<verification>
1. All API routes have @login_required (except auth/* and health)
2. Unauthenticated requests return 401
3. Authenticated requests work normally
4. Health endpoint remains public
5. All middleware tests pass
</verification>

<success_criteria>
- 35+ routes protected with @login_required
- Unauthenticated GET /api/courses returns 401
- Authenticated GET /api/courses returns 200
- GET /api/system/health returns 200 without auth
- AUTH-04 requirement satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/09-user-authentication/09-04-SUMMARY.md`
</output>
