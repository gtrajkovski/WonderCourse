---
phase: 09-user-authentication
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/auth/login_manager.py
  - tests/test_auth_models.py
autonomous: true

must_haves:
  truths:
    - "Flask-Login LoginManager is configured with user_loader callback"
    - "user_loader retrieves User from SQLite by ID"
    - "User model tests verify password hashing and database operations"
  artifacts:
    - path: "src/auth/login_manager.py"
      provides: "LoginManager configuration and user_loader"
      exports: ["login_manager", "init_login_manager"]
    - path: "tests/test_auth_models.py"
      provides: "Tests for User model and database operations"
      min_lines: 80
  key_links:
    - from: "src/auth/login_manager.py"
      to: "src/auth/models.py"
      via: "User.get_by_id in user_loader"
      pattern: "User.get_by_id"
---

<objective>
Configure Flask-Login's LoginManager with the user_loader callback and create comprehensive tests for the auth foundation.

Purpose: Flask-Login manages session state and provides @login_required decorator. The user_loader callback is how Flask-Login retrieves users from the database on each request.

Output:
- LoginManager configured and ready to integrate with Flask app
- Test suite for User model and database operations
</objective>

<execution_context>
@C:\Users\gpt30\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\gpt30\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/09-user-authentication/09-RESEARCH.md
@tests/conftest.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create LoginManager configuration</name>
  <files>src/auth/login_manager.py</files>
  <action>
Create `src/auth/login_manager.py`:

```python
from flask_login import LoginManager
from src.auth.models import User

login_manager = LoginManager()

def init_login_manager(app):
    """Initialize Flask-Login with the Flask app.

    Args:
        app: Flask application instance
    """
    login_manager.init_app(app)
    login_manager.login_view = 'auth.login'  # Redirect for @login_required
    login_manager.login_message = 'Please log in to access this page.'
    login_manager.login_message_category = 'info'

    @login_manager.user_loader
    def load_user(user_id):
        """Load user from database by ID.

        This callback is called on every request to restore the user
        from the session.

        Args:
            user_id: String user ID from session

        Returns:
            User object or None if not found
        """
        return User.get_by_id(user_id)
```

Export login_manager and init_login_manager from `src/auth/__init__.py`.
  </action>
  <verify>
`python -c "from src.auth.login_manager import login_manager, init_login_manager; print('LoginManager configured')"` succeeds
  </verify>
  <done>Flask-Login LoginManager configured with user_loader callback</done>
</task>

<task type="auto">
  <name>Task 2: Create auth model tests</name>
  <files>tests/test_auth_models.py</files>
  <action>
Create `tests/test_auth_models.py` with tests:

Fixtures:
- `test_app`: Create Flask app with test config (in-memory SQLite or temp database)
- `test_db`: Initialize database schema before each test, clean up after

User model tests:
- `test_user_create`: Create user with email, password, name; verify stored with hashed password
- `test_password_hashing`: Password is not stored plain text; verify with check_password
- `test_check_password_correct`: Correct password returns True
- `test_check_password_wrong`: Wrong password returns False
- `test_get_by_id`: Retrieve user by ID
- `test_get_by_id_not_found`: Return None for non-existent ID
- `test_get_by_email`: Retrieve user by email
- `test_get_by_email_not_found`: Return None for non-existent email
- `test_user_to_dict`: to_dict excludes password_hash
- `test_duplicate_email`: Creating user with duplicate email raises error
- `test_get_id_returns_string`: Flask-Login requires string ID

Use pytest fixtures for test app context and database initialization.
Follow existing test patterns in `tests/conftest.py`.
  </action>
  <verify>
`pytest tests/test_auth_models.py -v` passes with all tests green
  </verify>
  <done>Comprehensive tests for User model and database operations</done>
</task>

</tasks>

<verification>
1. LoginManager imports and initializes without errors
2. user_loader callback returns User from database
3. All auth model tests pass
4. Password hashing verified in tests (never plain text)
</verification>

<success_criteria>
- LoginManager configured with user_loader
- 11+ tests for User model all passing
- Password hashing verified (stored hash != password)
</success_criteria>

<output>
After completion, create `.planning/phases/09-user-authentication/09-02-SUMMARY.md`
</output>
