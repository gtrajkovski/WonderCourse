---
phase: 09-user-authentication
plan: 06
type: execute
wave: 4
depends_on: ["09-04", "09-05"]
files_modified:
  - src/auth/routes.py
  - tests/test_profile_api.py
autonomous: true

must_haves:
  truths:
    - "User can view their profile via GET /api/auth/profile"
    - "User can update their name and email via PUT /api/auth/profile"
    - "User can change password via POST /api/auth/password"
    - "Password change requires current password verification"
    - "Email update checks for uniqueness"
  artifacts:
    - path: "src/auth/routes.py"
      provides: "Profile and password change endpoints"
      exports: ["auth_bp"]
    - path: "tests/test_profile_api.py"
      provides: "Tests for profile management"
      min_lines: 80
  key_links:
    - from: "src/auth/routes.py"
      to: "src/auth/models.py"
      via: "User.update_profile, User.update_password"
      pattern: "current_user\\.(update|set_password|check_password)"
---

<objective>
Create profile management endpoints for viewing and updating user profile and changing password, fulfilling AUTH-06 requirement.

Purpose: Users need to manage their account information. Profile updates allow name/email changes, and password changes require current password verification for security.

Output:
- Profile view/update endpoints
- Password change endpoint with verification
- Comprehensive tests
</objective>

<execution_context>
@C:\Users\gpt30\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\gpt30\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/09-user-authentication/09-03-SUMMARY.md
@.planning/phases/09-user-authentication/09-04-SUMMARY.md

@src/auth/routes.py
@src/auth/models.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add User model update methods</name>
  <files>src/auth/models.py</files>
  <action>
Add methods to User class:

```python
def update_profile(self, name=None, email=None):
    """Update user profile fields.

    Args:
        name: New name (optional)
        email: New email (optional, checked for uniqueness)

    Returns:
        Updated User object

    Raises:
        ValueError: If email already in use by another user
    """
    db = get_db()

    if email and email != self.email:
        # Check email uniqueness
        existing = db.execute(
            "SELECT id FROM user WHERE email = ? AND id != ?",
            (email, self.id)
        ).fetchone()
        if existing:
            raise ValueError("Email already in use")
        self.email = email

    if name is not None:
        self.name = name

    # Update in database
    db.execute(
        "UPDATE user SET email = ?, name = ? WHERE id = ?",
        (self.email, self.name, self.id)
    )
    db.commit()
    return self

def update_password(self, current_password, new_password):
    """Change user password.

    Args:
        current_password: Current password for verification
        new_password: New password to set

    Returns:
        True if password changed

    Raises:
        ValueError: If current password is incorrect
    """
    if not self.check_password(current_password):
        raise ValueError("Current password is incorrect")

    self.set_password(new_password)

    db = get_db()
    db.execute(
        "UPDATE user SET password_hash = ? WHERE id = ?",
        (self.password_hash, self.id)
    )
    db.commit()
    return True
```
  </action>
  <verify>
`python -c "from src.auth.models import User; print(hasattr(User, 'update_profile'), hasattr(User, 'update_password'))"` prints "True True"
  </verify>
  <done>User model has update_profile and update_password methods</done>
</task>

<task type="auto">
  <name>Task 2: Add profile endpoints to auth routes</name>
  <files>src/auth/routes.py</files>
  <action>
Add to `src/auth/routes.py`:

**GET /api/auth/profile**
```python
@auth_bp.route('/api/auth/profile', methods=['GET'])
@login_required
def get_profile():
    """Get current user's profile."""
    return jsonify(current_user.to_dict()), 200
```

**PUT /api/auth/profile**
```python
@auth_bp.route('/api/auth/profile', methods=['PUT'])
@login_required
def update_profile():
    """Update current user's profile.

    Request JSON:
        {
            "name": str (optional),
            "email": str (optional)
        }
    """
    data = request.get_json()
    if not data:
        return jsonify({"error": "Request body must be JSON"}), 400

    try:
        current_user.update_profile(
            name=data.get('name'),
            email=data.get('email')
        )
        return jsonify(current_user.to_dict()), 200
    except ValueError as e:
        return jsonify({"error": str(e)}), 400
```

**POST /api/auth/password**
```python
@auth_bp.route('/api/auth/password', methods=['POST'])
@login_required
def change_password():
    """Change current user's password.

    Request JSON:
        {
            "current_password": str,
            "new_password": str
        }
    """
    data = request.get_json()
    if not data:
        return jsonify({"error": "Request body must be JSON"}), 400

    current_password = data.get('current_password')
    new_password = data.get('new_password')

    if not current_password or not new_password:
        return jsonify({"error": "Current and new password required"}), 400

    if len(new_password) < 8:
        return jsonify({"error": "New password must be at least 8 characters"}), 400

    try:
        current_user.update_password(current_password, new_password)
        return jsonify({"message": "Password changed successfully"}), 200
    except ValueError as e:
        return jsonify({"error": str(e)}), 400
```
  </action>
  <verify>
`python -c "from src.auth.routes import auth_bp; print(len([r for r in auth_bp.url_map.iter_rules() if 'profile' in r.rule or 'password' in r.rule]))"` shows routes exist
  </verify>
  <done>Profile view, update, and password change endpoints added</done>
</task>

<task type="auto">
  <name>Task 3: Create profile API tests</name>
  <files>tests/test_profile_api.py</files>
  <action>
Create `tests/test_profile_api.py`:

Fixtures:
- `authenticated_client`: Logged-in test client
- `user`: Created user with known credentials

Profile view tests:
- `test_get_profile_authenticated`: Returns user data
- `test_get_profile_unauthenticated`: Returns 401

Profile update tests:
- `test_update_name`: Update name successfully
- `test_update_email`: Update email successfully
- `test_update_email_duplicate`: Returns 400 if email exists
- `test_update_profile_partial`: Can update just name or just email
- `test_update_profile_unauthenticated`: Returns 401

Password change tests:
- `test_change_password_success`: New password works for login
- `test_change_password_wrong_current`: Returns 400
- `test_change_password_too_short`: Returns 400 for <8 char password
- `test_change_password_missing_fields`: Returns 400
- `test_change_password_unauthenticated`: Returns 401

Verification tests:
- `test_old_password_invalid_after_change`: Old password no longer works
- `test_can_login_with_new_password`: New password works
  </action>
  <verify>
`pytest tests/test_profile_api.py -v` passes with all tests green
  </verify>
  <done>Profile and password change API tests comprehensive</done>
</task>

</tasks>

<verification>
1. GET /api/auth/profile returns current user data
2. PUT /api/auth/profile updates name and email
3. PUT /api/auth/profile rejects duplicate email
4. POST /api/auth/password requires correct current password
5. POST /api/auth/password enforces minimum length
6. All profile tests pass
</verification>

<success_criteria>
- User can view profile (AUTH-06)
- User can update name and email (AUTH-06)
- User can change password with verification
- Email uniqueness enforced
- All 13+ profile tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/09-user-authentication/09-06-SUMMARY.md`
</output>
