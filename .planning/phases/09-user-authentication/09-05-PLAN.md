---
phase: 09-user-authentication
plan: 05
type: execute
wave: 3
depends_on: ["09-03"]
files_modified:
  - src/core/project_store.py
  - app.py
  - src/api/modules.py
  - src/api/lessons.py
  - src/api/activities.py
  - src/api/learning_outcomes.py
  - src/api/blueprint.py
  - src/api/content.py
  - src/api/build_state.py
  - src/api/textbook.py
  - src/api/validation.py
  - src/api/export.py
  - tests/test_user_isolation.py
autonomous: true

must_haves:
  truths:
    - "Courses are stored under projects/{user_id}/{course_id}/"
    - "User can only see their own courses in list"
    - "User cannot access another user's course by ID"
    - "Existing tests continue to pass with updated signatures"
  artifacts:
    - path: "src/core/project_store.py"
      provides: "User-scoped course storage"
      exports: ["ProjectStore"]
    - path: "tests/test_user_isolation.py"
      provides: "Tests verifying course isolation between users"
      min_lines: 80
  key_links:
    - from: "src/api/modules.py"
      to: "src/core/project_store.py"
      via: "_project_store.load(current_user.id, course_id)"
      pattern: "_project_store\\.(load|save|list_courses|delete)\\(current_user\\.id"
---

<objective>
Modify ProjectStore to namespace courses by user_id, fulfilling AUTH-05 requirement for course isolation.

Purpose: Each user should only see and modify their own courses. The file structure changes from `projects/{course_id}/` to `projects/{user_id}/{course_id}/`.

Output:
- ProjectStore with user_id parameter on all methods
- All API endpoints pass current_user.id to ProjectStore
- Tests verifying cross-user access is blocked
</objective>

<execution_context>
@C:\Users\gpt30\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\gpt30\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/09-user-authentication/09-03-SUMMARY.md

# Current implementation
@src/core/project_store.py
@src/api/modules.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update ProjectStore for user scoping</name>
  <files>src/core/project_store.py</files>
  <action>
Modify `src/core/project_store.py` to add user_id parameter:

1. Add `_user_dir(self, user_id: str) -> Path` method:
```python
def _user_dir(self, user_id: str) -> Path:
    """Get user's project directory.

    Args:
        user_id: User identifier (sanitized).

    Returns:
        Path to user's project directory.
    """
    safe_user_id = self._sanitize_id(str(user_id))
    user_path = self.base_dir / safe_user_id
    user_path.mkdir(parents=True, exist_ok=True)
    return user_path
```

2. Update `_course_dir(self, user_id: str, course_id: str) -> Path`:
```python
def _course_dir(self, user_id: str, course_id: str) -> Path:
    """Get course directory scoped to user."""
    safe_course_id = self._sanitize_id(course_id)
    return self._user_dir(user_id) / safe_course_id
```

3. Update ALL methods to accept user_id as first parameter:
- `save(self, user_id: str, course: Course) -> Path`
- `load(self, user_id: str, course_id: str) -> Optional[Course]`
- `list_courses(self, user_id: str) -> List[dict]`
- `delete(self, user_id: str, course_id: str) -> bool`

4. Update `_course_file` to use user_id:
```python
def _course_file(self, user_id: str, course_id: str) -> Path:
    return self._course_dir(user_id, course_id) / "course_data.json"
```

5. Update `list_courses` to only iterate user's directory:
```python
def list_courses(self, user_id: str) -> List[dict]:
    """List only this user's courses."""
    user_dir = self._user_dir(user_id)
    courses = []
    for course_dir in user_dir.iterdir():
        if course_dir.is_dir():
            # ... existing logic
```

New directory structure: `projects/{user_id}/{course_id}/course_data.json`
  </action>
  <verify>
`python -c "from src.core.project_store import ProjectStore; ps = ProjectStore(); print('ProjectStore updated')"` succeeds
  </verify>
  <done>ProjectStore methods accept user_id for scoped storage</done>
</task>

<task type="auto">
  <name>Task 2: Update all API blueprints to pass user_id</name>
  <files>app.py, src/api/modules.py, src/api/lessons.py, src/api/activities.py, src/api/learning_outcomes.py, src/api/blueprint.py, src/api/content.py, src/api/build_state.py, src/api/textbook.py, src/api/validation.py, src/api/export.py</files>
  <action>
For EVERY call to _project_store methods, add current_user.id as first argument:

1. In each API file, ensure import exists:
```python
from flask_login import login_required, current_user
```

2. Update ALL ProjectStore method calls:

Before:
```python
course = _project_store.load(course_id)
_project_store.save(course)
courses = _project_store.list_courses()
_project_store.delete(course_id)
```

After:
```python
course = _project_store.load(current_user.id, course_id)
_project_store.save(current_user.id, course)
courses = _project_store.list_courses(current_user.id)
_project_store.delete(current_user.id, course_id)
```

Files to update (search for "project_store" or "_project_store"):
- app.py: get_courses, create_course, get_course, update_course, delete_course
- src/api/modules.py: all module CRUD operations
- src/api/lessons.py: all lesson CRUD operations
- src/api/activities.py: all activity CRUD operations
- src/api/learning_outcomes.py: all outcome operations
- src/api/blueprint.py: generate, accept, refine
- src/api/content.py: generate, regenerate, update
- src/api/build_state.py: progress, state transitions
- src/api/textbook.py: textbook operations
- src/api/validation.py: validate, publishable
- src/api/export.py: preview and download endpoints

IMPORTANT: Be thorough. Missing a single call will cause runtime errors.
  </action>
  <verify>
`grep -r "project_store\.(load|save|list_courses|delete)" src/api/ app.py | grep -v "current_user.id" | wc -l` returns 0 (all calls updated)
  </verify>
  <done>All API endpoints pass current_user.id to ProjectStore</done>
</task>

<task type="auto">
  <name>Task 3: Create user isolation tests</name>
  <files>tests/test_user_isolation.py</files>
  <action>
Create `tests/test_user_isolation.py`:

Fixtures:
- `user_a`: Create and log in user A
- `user_b`: Create and log in user B
- `course_a`: Course created by user A
- `course_b`: Course created by user B

Tests:
- `test_user_sees_only_own_courses`: User A's list doesn't include user B's courses
- `test_user_cannot_get_other_user_course`: User A GET /api/courses/{course_b.id} -> 404
- `test_user_cannot_update_other_user_course`: User A PUT /api/courses/{course_b.id} -> 404
- `test_user_cannot_delete_other_user_course`: User A DELETE /api/courses/{course_b.id} -> 404
- `test_user_cannot_access_other_user_modules`: User A GET /api/courses/{course_b.id}/modules -> 404
- `test_user_cannot_generate_content_for_other_user`: User A POST to course_b activity -> 404
- `test_course_stored_in_user_directory`: Verify file path is projects/{user_id}/{course_id}/

Test isolation verification:
- Create course as user A
- Switch to user B session
- Verify course not visible and not accessible
- Switch back to user A
- Verify course still accessible
  </action>
  <verify>
`pytest tests/test_user_isolation.py -v` passes with all tests green
  </verify>
  <done>User isolation tests verify cross-user access is blocked</done>
</task>

</tasks>

<verification>
1. ProjectStore creates directories under projects/{user_id}/
2. User A cannot see or access User B's courses
3. All existing tests pass with updated signatures
4. User isolation tests pass
5. Course list only shows current user's courses
</verification>

<success_criteria>
- Courses stored in projects/{user_id}/{course_id}/
- User list shows only own courses
- 404 returned for other user's course_id
- AUTH-05 requirement satisfied
- All isolation tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/09-user-authentication/09-05-SUMMARY.md`
</output>
