---
phase: 09-user-authentication
plan: 07
type: execute
wave: 4
depends_on: ["09-04", "09-05"]
files_modified:
  - src/auth/routes.py
  - src/auth/tokens.py
  - src/config.py
  - tests/test_password_reset.py
autonomous: true
user_setup:
  - service: email
    why: "Password reset emails"
    env_vars:
      - name: MAIL_SERVER
        source: "SMTP server (e.g., smtp.gmail.com)"
      - name: MAIL_PORT
        source: "SMTP port (e.g., 587)"
      - name: MAIL_USERNAME
        source: "SMTP username/email"
      - name: MAIL_PASSWORD
        source: "SMTP password or app password"
      - name: MAIL_DEFAULT_SENDER
        source: "From email address"
    dashboard_config: []

must_haves:
  truths:
    - "User can request password reset via POST /api/auth/forgot-password"
    - "Reset token is time-limited (1 hour by default)"
    - "User can reset password via POST /api/auth/reset-password with valid token"
    - "Invalid or expired token returns 400"
    - "Token is single-use (invalidated after use)"
  artifacts:
    - path: "src/auth/tokens.py"
      provides: "Token generation and verification with itsdangerous"
      exports: ["generate_reset_token", "verify_reset_token"]
    - path: "tests/test_password_reset.py"
      provides: "Tests for password reset flow"
      min_lines: 80
  key_links:
    - from: "src/auth/routes.py"
      to: "src/auth/tokens.py"
      via: "generate_reset_token, verify_reset_token"
      pattern: "(generate_reset_token|verify_reset_token)"
    - from: "src/auth/routes.py"
      to: "flask_mail"
      via: "Mail.send for reset emails"
      pattern: "mail\\.send"
---

<objective>
Implement password reset flow with time-limited tokens and email delivery, fulfilling AUTH-07 requirement.

Purpose: Users need to recover their accounts when they forget passwords. The flow uses secure, time-limited tokens sent via email.

Output:
- Token generation/verification utilities using itsdangerous
- Forgot-password and reset-password endpoints
- Flask-Mail integration for sending reset emails
- Comprehensive tests (mocking email sending)
</objective>

<execution_context>
@C:\Users\gpt30\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\gpt30\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/09-user-authentication/09-RESEARCH.md
@.planning/phases/09-user-authentication/09-03-SUMMARY.md

@src/auth/routes.py
@src/config.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create token generation utilities</name>
  <files>src/auth/tokens.py</files>
  <action>
Create `src/auth/tokens.py`:

```python
"""Password reset token generation and verification.

Uses itsdangerous URLSafeTimedSerializer for secure, time-limited tokens.
"""

from itsdangerous import URLSafeTimedSerializer, SignatureExpired, BadSignature
from flask import current_app


def generate_reset_token(email: str) -> str:
    """Generate a time-limited password reset token.

    Args:
        email: User's email address to encode in token

    Returns:
        URL-safe token string
    """
    s = URLSafeTimedSerializer(current_app.config['SECRET_KEY'])
    return s.dumps(email, salt='password-reset')


def verify_reset_token(token: str, max_age: int = 3600) -> str | None:
    """Verify a password reset token.

    Args:
        token: Token string to verify
        max_age: Maximum token age in seconds (default: 1 hour)

    Returns:
        Email address if valid, None if invalid or expired
    """
    s = URLSafeTimedSerializer(current_app.config['SECRET_KEY'])
    try:
        email = s.loads(token, salt='password-reset', max_age=max_age)
        return email
    except (SignatureExpired, BadSignature):
        return None
```

Export from `src/auth/__init__.py`.
  </action>
  <verify>
`python -c "from src.auth.tokens import generate_reset_token, verify_reset_token; print('Tokens imported')"` succeeds
  </verify>
  <done>Token utilities using itsdangerous created</done>
</task>

<task type="auto">
  <name>Task 2: Configure Flask-Mail</name>
  <files>src/config.py, src/auth/mail.py</files>
  <action>
Add to `src/config.py`:
```python
# Email configuration
MAIL_SERVER = os.getenv("MAIL_SERVER", "localhost")
MAIL_PORT = int(os.getenv("MAIL_PORT", "25"))
MAIL_USE_TLS = os.getenv("MAIL_USE_TLS", "true").lower() == "true"
MAIL_USERNAME = os.getenv("MAIL_USERNAME")
MAIL_PASSWORD = os.getenv("MAIL_PASSWORD")
MAIL_DEFAULT_SENDER = os.getenv("MAIL_DEFAULT_SENDER", "noreply@coursebuilder.local")
PASSWORD_RESET_TOKEN_MAX_AGE = int(os.getenv("PASSWORD_RESET_TOKEN_MAX_AGE", "3600"))
```

Create `src/auth/mail.py`:
```python
"""Email utilities for auth module."""

from flask_mail import Mail, Message
from flask import current_app

mail = Mail()


def init_mail(app):
    """Initialize Flask-Mail with app."""
    mail.init_app(app)


def send_password_reset_email(to_email: str, reset_token: str):
    """Send password reset email.

    Args:
        to_email: Recipient email address
        reset_token: Password reset token
    """
    reset_url = f"{current_app.config.get('APP_URL', 'http://localhost:5003')}/reset-password?token={reset_token}"

    msg = Message(
        subject="Password Reset Request",
        recipients=[to_email],
        body=f"""You requested a password reset.

Click the following link to reset your password:
{reset_url}

This link will expire in 1 hour.

If you did not request this reset, please ignore this email.
"""
    )

    # Only send if mail server is configured
    if current_app.config.get('MAIL_SERVER') != 'localhost':
        mail.send(msg)
    else:
        # Log for development
        current_app.logger.info(f"Password reset email would be sent to {to_email}")
        current_app.logger.info(f"Reset URL: {reset_url}")
```

Export from `src/auth/__init__.py`.
  </action>
  <verify>
`python -c "from src.auth.mail import mail, init_mail, send_password_reset_email; print('Mail configured')"` succeeds
  </verify>
  <done>Flask-Mail configured with reset email function</done>
</task>

<task type="auto">
  <name>Task 3: Add password reset endpoints</name>
  <files>src/auth/routes.py, app.py</files>
  <action>
Add to `src/auth/routes.py`:

**POST /api/auth/forgot-password**
```python
@auth_bp.route('/api/auth/forgot-password', methods=['POST'])
def forgot_password():
    """Request password reset email.

    Request JSON:
        {"email": str}

    Returns 200 even if email not found (prevents user enumeration).
    """
    data = request.get_json()
    email = data.get('email') if data else None

    if not email:
        return jsonify({"error": "Email required"}), 400

    # Always return success to prevent user enumeration
    user = User.get_by_email(email)
    if user:
        from src.auth.tokens import generate_reset_token
        from src.auth.mail import send_password_reset_email

        token = generate_reset_token(email)
        send_password_reset_email(email, token)

    return jsonify({"message": "If that email exists, a reset link has been sent"}), 200
```

**POST /api/auth/reset-password**
```python
@auth_bp.route('/api/auth/reset-password', methods=['POST'])
def reset_password():
    """Reset password using token.

    Request JSON:
        {
            "token": str,
            "new_password": str
        }
    """
    data = request.get_json()
    if not data:
        return jsonify({"error": "Request body must be JSON"}), 400

    token = data.get('token')
    new_password = data.get('new_password')

    if not token or not new_password:
        return jsonify({"error": "Token and new password required"}), 400

    if len(new_password) < 8:
        return jsonify({"error": "Password must be at least 8 characters"}), 400

    from src.auth.tokens import verify_reset_token
    from src.config import Config

    email = verify_reset_token(token, Config.PASSWORD_RESET_TOKEN_MAX_AGE)
    if not email:
        return jsonify({"error": "Invalid or expired reset token"}), 400

    user = User.get_by_email(email)
    if not user:
        return jsonify({"error": "User not found"}), 400

    # Update password
    user.set_password(new_password)
    db = get_db()
    db.execute(
        "UPDATE user SET password_hash = ? WHERE id = ?",
        (user.password_hash, user.id)
    )
    db.commit()

    return jsonify({"message": "Password reset successfully"}), 200
```

Update `app.py` to initialize mail:
```python
from src.auth.mail import init_mail
# After app creation:
init_mail(app)
```

Update `.env.example` with mail settings.
  </action>
  <verify>
`python -c "from src.auth.routes import auth_bp; print('Reset endpoints added')"` succeeds
  </verify>
  <done>Forgot-password and reset-password endpoints added</done>
</task>

<task type="auto">
  <name>Task 4: Create password reset tests</name>
  <files>tests/test_password_reset.py</files>
  <action>
Create `tests/test_password_reset.py`:

Fixtures:
- `client`: Test client with mail mocked
- `user`: User with known email for testing
- Mock `send_password_reset_email` to capture calls

Token tests:
- `test_generate_token`: Token is URL-safe string
- `test_verify_valid_token`: Returns email for valid token
- `test_verify_expired_token`: Returns None after max_age
- `test_verify_invalid_token`: Returns None for tampered token

Forgot-password tests:
- `test_forgot_password_valid_email`: Returns 200, sends email
- `test_forgot_password_unknown_email`: Returns 200 (no user enumeration)
- `test_forgot_password_missing_email`: Returns 400

Reset-password tests:
- `test_reset_password_success`: Valid token resets password
- `test_reset_password_invalid_token`: Returns 400
- `test_reset_password_expired_token`: Returns 400
- `test_reset_password_short_password`: Returns 400
- `test_reset_password_missing_fields`: Returns 400

Integration tests:
- `test_full_reset_flow`: Request reset -> get token -> reset -> login with new password
- `test_old_password_fails_after_reset`: Old password no longer works
  </action>
  <verify>
`pytest tests/test_password_reset.py -v` passes with all tests green
  </verify>
  <done>Comprehensive password reset tests with mocked email</done>
</task>

</tasks>

<verification>
1. Token generation produces URL-safe string
2. Token verification respects max_age
3. Forgot-password doesn't reveal user existence
4. Reset-password works with valid token
5. Invalid/expired tokens rejected
6. All password reset tests pass
</verification>

<success_criteria>
- POST /api/auth/forgot-password sends reset email (AUTH-07)
- POST /api/auth/reset-password accepts valid token
- Tokens expire after 1 hour
- Same response for valid/invalid email (no enumeration)
- All 13+ password reset tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/09-user-authentication/09-07-SUMMARY.md`
</output>
