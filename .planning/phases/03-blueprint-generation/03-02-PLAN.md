---
phase: 03-blueprint-generation
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/validators/__init__.py
  - src/validators/course_validator.py
  - src/generators/blueprint_converter.py
  - tests/test_course_validator.py
  - tests/test_blueprint_converter.py
autonomous: true

must_haves:
  truths:
    - "CourseraValidator detects invalid module counts (not 2-3)"
    - "CourseraValidator detects out-of-range durations (not 30-180 min)"
    - "CourseraValidator warns about content distribution imbalance"
    - "CourseraValidator warns about low Bloom's taxonomy diversity"
    - "Blueprint converter transforms Pydantic CourseBlueprint into Course/Module/Lesson/Activity dataclasses"
  artifacts:
    - path: "src/validators/course_validator.py"
      provides: "CourseraValidator with deterministic validation"
      contains: "class CourseraValidator"
    - path: "src/generators/blueprint_converter.py"
      provides: "Blueprint-to-Course dataclass conversion"
      contains: "def blueprint_to_course"
    - path: "tests/test_course_validator.py"
      provides: "Validator tests with valid and invalid blueprints"
      contains: "test_valid_blueprint"
    - path: "tests/test_blueprint_converter.py"
      provides: "Converter tests verifying dataclass output"
      contains: "test_blueprint_to_course"
  key_links:
    - from: "src/validators/course_validator.py"
      to: "src/generators/blueprint_generator.py"
      via: "Pydantic CourseBlueprint type"
      pattern: "from src.generators.blueprint_generator import CourseBlueprint"
    - from: "src/generators/blueprint_converter.py"
      to: "src/core/models.py"
      via: "Course, Module, Lesson, Activity dataclasses"
      pattern: "from src.core.models import"
---

<objective>
Create the CourseraValidator for deterministic blueprint validation and the blueprint-to-course converter for transforming AI-generated blueprints into actual Course dataclasses.

Purpose: Validation ensures AI output meets Coursera short course requirements before the user accepts it. The converter bridges the Pydantic blueprint schema with the existing Course/Module/Lesson/Activity dataclasses from Phase 1, enabling seamless integration with ProjectStore.

Output: `src/validators/course_validator.py` (CourseraValidator + BlueprintValidation dataclass), `src/generators/blueprint_converter.py` (blueprint_to_course function), plus comprehensive tests for both.
</objective>

<execution_context>
@C:\Users\gpt30\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\gpt30\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-blueprint-generation/03-RESEARCH.md
@src/core/models.py
@src/config.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create CourseraValidator with deterministic validation rules</name>
  <files>src/validators/__init__.py, src/validators/course_validator.py</files>
  <action>
1. Create `src/validators/__init__.py` as empty package init.

2. Create `src/validators/course_validator.py` with:

**BlueprintValidation dataclass:**
```python
@dataclass
class BlueprintValidation:
    is_valid: bool
    errors: List[str]       # Blockers that prevent acceptance
    warnings: List[str]     # Non-blocking suggestions
    suggestions: List[str]  # Optional improvements
    metrics: Dict[str, Any] # Computed metrics for display
```

**CourseraValidator class:**
```python
class CourseraValidator:
    """Validates course blueprints against Coursera short course requirements.

    All validation is deterministic Python logic - never uses AI.
    """

    # Constants (from Coursera requirements)
    MIN_DURATION = 30
    MAX_DURATION = 180
    MIN_MODULES = 2
    MAX_MODULES = 3
    MIN_LESSONS_PER_MODULE = 3
    MAX_LESSONS_PER_MODULE = 5
    MIN_ACTIVITIES_PER_LESSON = 2
    MAX_ACTIVITIES_PER_LESSON = 4
    TARGET_VIDEO_PCT = 0.30
    TARGET_READING_PCT = 0.20
    TARGET_PRACTICE_PCT = 0.30
    TARGET_ASSESSMENT_PCT = 0.20
    DISTRIBUTION_TOLERANCE = 0.15  # Allow 15% deviation from targets

    def validate(self, blueprint: CourseBlueprint, target_duration: Optional[int] = None) -> BlueprintValidation:
        """Run all validation checks. Returns BlueprintValidation."""
        # Collect errors, warnings, suggestions

        # ERROR checks (blockers):
        # 1. Module count: must be 2-3
        # 2. Total duration: must be 30-180 min
        # 3. If target_duration provided: actual must be within 20% of target

        # WARNING checks (non-blocking):
        # 4. Lessons per module: should be 3-5
        # 5. Activities per lesson: should be 2-4
        # 6. Video content percentage vs target (~30%)
        # 7. Bloom's taxonomy diversity: should have 3+ levels
        # 8. WWHAA phase present on video activities

        # SUGGESTION checks (optional):
        # 9. If no assessment activities, suggest adding quiz
        # 10. If all same Bloom level, suggest variety

        # METRICS:
        # total_duration, module_count, total_lessons, total_activities,
        # content_distribution (dict of content_type -> percentage),
        # bloom_diversity (number of unique levels),
        # activities_per_lesson_avg

    def _flatten_activities(self, blueprint: CourseBlueprint) -> List[ActivityBlueprint]:
        """Extract all activities from nested structure."""
```

Import CourseBlueprint and ActivityBlueprint from `src.generators.blueprint_generator`. Use `from __future__ import annotations` to handle potential circular import if needed.
  </action>
  <verify>Run `py -3 -c "from src.validators.course_validator import CourseraValidator, BlueprintValidation; print('Import OK')"` to confirm imports work.</verify>
  <done>CourseraValidator class exists with validate() method returning BlueprintValidation. All validation is deterministic Python.</done>
</task>

<task type="auto">
  <name>Task 2: Create blueprint-to-course converter</name>
  <files>src/generators/blueprint_converter.py</files>
  <action>
Create `src/generators/blueprint_converter.py` with:

```python
def blueprint_to_course(
    blueprint: CourseBlueprint,
    course: Course
) -> Course:
    """Apply blueprint structure to an existing Course, replacing its modules.

    Converts Pydantic blueprint models to Course/Module/Lesson/Activity dataclasses.
    Preserves the course's existing ID, title, description, and other metadata.
    Replaces modules list entirely with the blueprint's structure.

    Args:
        blueprint: AI-generated CourseBlueprint (Pydantic model)
        course: Existing Course object to apply structure to

    Returns:
        The modified Course with new modules/lessons/activities
    """
```

**Conversion logic:**
- For each ModuleBlueprint, create a Module with generated ID (mod_xxx), title, description, order
- For each LessonBlueprint, create a Lesson with generated ID (les_xxx), title, description, order
- For each ActivityBlueprint, create an Activity with:
  - Generated ID (act_xxx)
  - title from blueprint
  - content_type: map string to ContentType enum (e.g., "video" -> ContentType.VIDEO)
  - activity_type: map string to ActivityType enum (e.g., "video_lecture" -> ActivityType.VIDEO_LECTURE)
  - wwhaa_phase: map string to WWHAAPhase enum if not None, default to WWHAAPhase.CONTENT
  - bloom_level: map string to BloomLevel enum
  - estimated_duration_minutes from blueprint
  - build_state: BuildState.DRAFT (all new activities start as draft)
  - order from loop index

**Helper functions:**
- `_map_content_type(type_str: str) -> ContentType` with fallback to ContentType.VIDEO
- `_map_activity_type(type_str: str) -> ActivityType` with fallback to ActivityType.VIDEO_LECTURE
- `_map_bloom_level(level_str: str) -> BloomLevel` with fallback to BloomLevel.APPLY
- `_map_wwhaa_phase(phase_str: Optional[str]) -> WWHAAPhase` with fallback to WWHAAPhase.CONTENT

All mapping functions should use try/except with enum value lookup and fallback on ValueError. This mirrors the pattern from `Activity.from_dict()` in models.py.

Also update the course's `target_duration_minutes` to match `blueprint.total_duration_minutes` (rounded to int).
  </action>
  <verify>Run `py -3 -c "from src.generators.blueprint_converter import blueprint_to_course; print('Import OK')"` to confirm import works.</verify>
  <done>blueprint_to_course function converts Pydantic blueprint models to Course dataclasses with proper enum mapping.</done>
</task>

<task type="auto">
  <name>Task 3: Create tests for validator and converter</name>
  <files>tests/test_course_validator.py, tests/test_blueprint_converter.py</files>
  <action>
**tests/test_course_validator.py** - Test CourseraValidator with various blueprint scenarios:

Create helper function `make_blueprint(**overrides)` that builds a valid CourseBlueprint for testing (2 modules, 3 lessons each, 2-3 activities per lesson, ~90 min total). Then test:

1. `test_valid_blueprint_passes()` - Default blueprint passes validation (is_valid=True, no errors)
2. `test_too_few_modules_error()` - Blueprint with 1 module produces error
3. `test_too_many_modules_error()` - Blueprint with 4 modules produces error
4. `test_duration_below_minimum_error()` - Blueprint with total_duration=20 produces error
5. `test_duration_above_maximum_error()` - Blueprint with total_duration=200 produces error
6. `test_few_lessons_warning()` - Module with 2 lessons produces warning (not error)
7. `test_bloom_diversity_warning()` - All activities same Bloom level produces warning
8. `test_metrics_computed()` - Validate metrics dict includes total_duration, module_count, total_activities, content_distribution, bloom_diversity
9. `test_video_distribution_warning()` - Blueprint with 80% video activities produces warning
10. `test_validation_with_target_duration()` - When target_duration provided, validates actual is within 20%

**tests/test_blueprint_converter.py** - Test blueprint-to-course conversion:

1. `test_blueprint_to_course_creates_modules()` - 2-module blueprint creates 2 Module objects
2. `test_blueprint_to_course_creates_lessons()` - Each module's lessons are created with correct order
3. `test_blueprint_to_course_creates_activities()` - Activities have correct content_type, activity_type, bloom_level enums
4. `test_blueprint_to_course_maps_wwhaa_phase()` - Video activities get WWHAAPhase from blueprint, non-video activities get default
5. `test_blueprint_to_course_preserves_course_metadata()` - Course ID, title, description unchanged after conversion
6. `test_blueprint_to_course_updates_duration()` - Course target_duration_minutes updated from blueprint total
7. `test_blueprint_to_course_all_activities_draft()` - All activities have BuildState.DRAFT
8. `test_blueprint_to_course_generates_unique_ids()` - All module, lesson, activity IDs are unique

Both test files should construct Pydantic models directly (no mocking needed for these). Import from `src.generators.blueprint_generator` for Pydantic models and from `src.core.models` for dataclass types.
  </action>
  <verify>
Run `py -3 -m pytest tests/test_course_validator.py tests/test_blueprint_converter.py -v` and confirm all tests pass.
Run `py -3 -m pytest tests/ -v` and confirm all 142+ existing tests still pass.
  </verify>
  <done>18+ tests pass for validator and converter. No regressions in existing tests.</done>
</task>

</tasks>

<verification>
1. `py -3 -c "from src.validators.course_validator import CourseraValidator"` succeeds
2. `py -3 -c "from src.generators.blueprint_converter import blueprint_to_course"` succeeds
3. `py -3 -m pytest tests/test_course_validator.py tests/test_blueprint_converter.py -v` — all tests pass
4. `py -3 -m pytest tests/ -v` — all existing tests still pass (no regressions)
</verification>

<success_criteria>
- CourseraValidator detects module count errors (not 2-3), duration range errors (not 30-180), content distribution warnings, Bloom diversity warnings
- BlueprintValidation includes is_valid, errors, warnings, suggestions, and metrics
- blueprint_to_course converts Pydantic models to Course dataclasses with proper enum mapping
- 18+ tests pass covering validation rules and conversion logic
- No regressions in existing tests
</success_criteria>

<output>
After completion, create `.planning/phases/03-blueprint-generation/03-02-SUMMARY.md`
</output>
