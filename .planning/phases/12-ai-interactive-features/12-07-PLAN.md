---
phase: 12-ai-interactive-features
plan: 07
type: execute
wave: 2
depends_on: [12-05]
files_modified:
  - src/editing/history.py
  - src/editing/version_store.py
  - src/api/edit_bp.py
  - tests/test_editing_history.py
autonomous: true

must_haves:
  truths:
    - "User can undo AI-applied changes"
    - "User can redo undone changes"
    - "User can save named versions of content"
    - "User can restore previous versions"
  artifacts:
    - path: "src/editing/history.py"
      provides: "Undo/redo stack management"
      exports: ["EditHistory"]
    - path: "src/editing/version_store.py"
      provides: "Named version storage"
      exports: ["VersionStore"]
  key_links:
    - from: "src/api/edit_bp.py"
      to: "EditHistory"
      via: "session storage"
      pattern: "history\\.push|history\\.undo"
    - from: "src/editing/version_store.py"
      to: "ProjectStore"
      via: "file persistence"
      pattern: "store\\.save"
---

<objective>
Build undo/redo stack and version history for AI edits.

Purpose: Enable users to undo/redo AI changes and save/restore named versions (EDIT-08). Essential for safe experimentation with AI suggestions.
Output: EditHistory for command pattern undo/redo and VersionStore for named snapshots.
</objective>

<execution_context>
@C:\Users\gpt30\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\gpt30\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/12-ai-interactive-features/12-RESEARCH.md

# Session storage pattern
@src/core/project_store.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create EditHistory and VersionStore</name>
  <files>
    src/editing/history.py
    src/editing/version_store.py
    src/editing/__init__.py
  </files>
  <action>
1. Create `src/editing/history.py`:
   - EditCommand dataclass:
     - id: str (unique command ID)
     - action: str (what was done)
     - before: str (content before)
     - after: str (content after)
     - timestamp: str (ISO format)
     - metadata: dict (action type, context)

   - EditHistory class (per-session, in-memory):
     - __init__(max_size: int = 100)
     - push(command: EditCommand) - add to undo stack, clear redo
     - undo() -> Optional[EditCommand] - pop from undo, push to redo, return command
     - redo() -> Optional[EditCommand] - pop from redo, push to undo, return command
     - can_undo() -> bool
     - can_redo() -> bool
     - get_undo_stack() -> List[EditCommand] (for UI display)
     - get_redo_stack() -> List[EditCommand]
     - clear() - reset both stacks

   - SessionHistoryManager (manages histories per session):
     - get_history(session_id: str, activity_id: str) -> EditHistory
     - Uses dict storage keyed by (session_id, activity_id)
     - Auto-creates new history if not exists
     - cleanup_old_sessions(max_age_hours: int = 24)

2. Create `src/editing/version_store.py`:
   - Version dataclass:
     - id: str (version ID)
     - name: str (user-provided name)
     - activity_id: str
     - content: dict (full content snapshot)
     - created_at: str
     - created_by: str (user ID)

   - VersionStore class:
     - __init__(project_store: ProjectStore)
     - save_version(course_id: str, activity_id: str, name: str, content: dict, user_id: str) -> Version
     - list_versions(course_id: str, activity_id: str) -> List[Version]
     - get_version(course_id: str, activity_id: str, version_id: str) -> Version
     - restore_version(course_id: str, activity_id: str, version_id: str) -> dict
     - delete_version(course_id: str, activity_id: str, version_id: str) -> bool
     - compare_versions(v1_id: str, v2_id: str) -> DiffResult

   - Store versions in course_data.json under activity.versions array
   - Limit to 20 versions per activity, delete oldest when exceeded

3. Update `src/editing/__init__.py` to export new classes
  </action>
  <verify>
    python -c "from src.editing import EditHistory, VersionStore; print('Imports OK')"
  </verify>
  <done>
    EditHistory and VersionStore importable with undo/redo and version management
  </done>
</task>

<task type="auto">
  <name>Task 2: Add history and version endpoints with tests</name>
  <files>
    src/api/edit_bp.py
    tests/test_editing_history.py
  </files>
  <action>
1. Add to `src/api/edit_bp.py`:

   POST /api/edit/history/push
   - Accepts: JSON with {activity_id: str, command: EditCommand}
   - Pushes command to session's undo stack
   - Session ID from Flask session

   POST /api/edit/history/undo
   - Accepts: JSON with {activity_id: str}
   - Returns: {command: EditCommand, content_before: str} or 404 if nothing to undo

   POST /api/edit/history/redo
   - Accepts: JSON with {activity_id: str}
   - Returns: {command: EditCommand, content_after: str} or 404 if nothing to redo

   GET /api/edit/history/<activity_id>
   - Returns: {undo_stack: [...], redo_stack: [...], can_undo, can_redo}

   POST /api/courses/<course_id>/activities/<activity_id>/versions
   - Accepts: JSON with {name: str}
   - Saves current content as named version
   - Returns: {version: Version}

   GET /api/courses/<course_id>/activities/<activity_id>/versions
   - Returns: {versions: List[Version]}

   POST /api/courses/<course_id>/activities/<activity_id>/versions/<version_id>/restore
   - Restores version content to activity
   - Returns: {restored: true, content: dict}

   DELETE /api/courses/<course_id>/activities/<activity_id>/versions/<version_id>
   - Deletes version
   - Returns: {deleted: true}

   GET /api/courses/<course_id>/activities/<activity_id>/versions/compare
   - Query params: v1, v2
   - Returns: {diff: DiffResult}

2. Create `tests/test_editing_history.py`:
   - Test push/undo/redo cycle
   - Test undo stack limit (100)
   - Test redo cleared on new push
   - Test session isolation
   - Test version save and list
   - Test version restore
   - Test version comparison
   - Test version limit (20)
  </action>
  <verify>
    pytest tests/test_editing_history.py -v
  </verify>
  <done>
    Undo/redo and version history endpoints work correctly
  </done>
</task>

</tasks>

<verification>
- EditHistory maintains separate undo/redo stacks
- Undo/redo works correctly with command pattern
- Named versions persist to course data
- Version restore replaces activity content
- Version comparison shows diff
- All tests pass (target: 15+ tests)
</verification>

<success_criteria>
- POST /api/edit/history/undo returns previous state
- POST /api/edit/history/redo returns next state
- Versions save and restore correctly
- Stack size limits enforced
- Session isolation works
- All tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/12-ai-interactive-features/12-07-SUMMARY.md`
</output>
