---
phase: 12-ai-interactive-features
plan: 10
type: execute
wave: 3
depends_on: [12-03, 12-04]
files_modified:
  - templates/import.html
  - templates/partials/import-modal.html
  - static/js/pages/import.js
  - static/css/components/import.css
  - src/import/url_fetcher.py
  - src/api/import_bp.py
autonomous: false

user_setup:
  - service: google-oauth
    why: "Google Docs import via OAuth"
    env_vars:
      - name: GOOGLE_CLIENT_ID
        source: "Google Cloud Console -> APIs & Services -> Credentials -> OAuth 2.0 Client IDs"
      - name: GOOGLE_CLIENT_SECRET
        source: "Google Cloud Console -> APIs & Services -> Credentials -> OAuth 2.0 Client IDs"
    dashboard_config:
      - task: "Create OAuth 2.0 credentials"
        location: "Google Cloud Console -> APIs & Services -> Credentials"
      - task: "Enable Google Docs API"
        location: "Google Cloud Console -> APIs & Services -> Library"
      - task: "Add authorized redirect URI: http://localhost:5003/api/import/oauth/google/callback"
        location: "Google Cloud Console -> OAuth Client -> Authorized redirect URIs"

must_haves:
  truths:
    - "User can paste content into import modal"
    - "User can upload files via drag-and-drop"
    - "User can import from public URLs"
    - "User can authenticate with Google to import Google Docs"
    - "User sees format detection and AI analysis"
    - "User can confirm or adjust import settings"
  artifacts:
    - path: "templates/import.html"
      provides: "Import page layout"
      contains: "import-dropzone"
    - path: "static/js/pages/import.js"
      provides: "Import UI controller"
      contains: "ImportController"
    - path: "src/import/url_fetcher.py"
      provides: "URL fetching with OAuth support"
      exports: ["URLFetcher", "GoogleDocsClient"]
  key_links:
    - from: "static/js/pages/import.js"
      to: "/api/import/analyze"
      via: "fetch"
      pattern: "fetch.*api/import"
    - from: "src/import/url_fetcher.py"
      to: "Google OAuth"
      via: "OAuth2 flow"
      pattern: "oauth2.*google"
---

<objective>
Build the import UI with paste, file upload, URL fetch, and Google Docs OAuth integration.

Purpose: Enable users to import content via a dedicated UI with drag-drop file upload, paste support, public URL fetch, and Google Docs OAuth (IMPORT-01, IMPORT-02, IMPORT-03). Frontend for the import pipeline with full URL authentication per CONTEXT.md decisions.
Output: Import page with dropzone, URL fetch with OAuth, format detection display, and import confirmation flow.
</objective>

<execution_context>
@C:\Users\gpt30\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\gpt30\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/12-ai-interactive-features/12-CONTEXT.md

# Existing UI patterns
@templates/base.html
@static/js/utils/api.js
@static/css/main.css

# Import blueprint (to add OAuth endpoints)
@src/api/import_bp.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create import page, modal, and URL fetcher with OAuth</name>
  <files>
    templates/import.html
    templates/partials/import-modal.html
    static/css/components/import.css
    src/import/url_fetcher.py
    src/import/__init__.py
  </files>
  <action>
1. Create `templates/import.html`:
   - Extends base.html with sidebar
   - Full-page import interface with three sections:
     a) Source selection: Paste | Upload | URL tabs
     b) Preview area: Shows parsed content preview
     c) Action bar: Import button, cancel, settings

   - Paste section:
     - Large textarea with placeholder "Paste your content here..."
     - Character count display
     - Format auto-detection indicator

   - Upload section:
     - Drag-and-drop zone with visual feedback
     - File type indicators (icons for DOCX, JSON, etc.)
     - Multiple file support with list display
     - Supported formats help text

   - URL section (FULL IMPLEMENTATION per CONTEXT.md):
     - URL input field
     - Fetch button for public URLs
     - "Connect Google" button for Google Docs OAuth
     - Status indicator showing connection state
     - Google Docs picker UI after authentication

2. Create `templates/partials/import-modal.html`:
   - Modal version for in-page import (Planner/Studio)
   - Compact layout with paste and upload only
   - Quick import action

3. Create `static/css/components/import.css`:
   - Dark theme matching existing design
   - Dropzone styling:
     - Dashed border default
     - Highlight border on drag-over
     - Success/error state colors
   - Preview pane styling with syntax highlighting placeholder
   - Format badge styling (JSON, DOCX, etc.)
   - Progress indicator for analysis
   - OAuth button styling (Google brand colors)

Match colors from main.css: #1a1a2e background, #16213e cards, #4da6ff accent

4. Create `src/import/url_fetcher.py`:
   - URLFetcher class:
     - fetch(url: str) -> FetchResult
       - Fetch content from public URLs
       - Handle redirects, timeouts, errors
       - Detect content type from headers
     - FetchResult dataclass: content, content_type, source_url, fetched_at

   - GoogleDocsClient class:
     - __init__(client_id, client_secret, redirect_uri)
     - get_auth_url() -> str
       - Generate OAuth authorization URL with docs.readonly scope
     - exchange_code(code: str) -> TokenData
       - Exchange auth code for access token
     - fetch_document(doc_id: str, access_token: str) -> str
       - Fetch Google Doc content as plain text or HTML
     - TokenData dataclass: access_token, refresh_token, expires_at

   - Use requests-oauthlib or google-auth-oauthlib for OAuth flow

5. Update `src/import/__init__.py` to export URLFetcher, GoogleDocsClient
  </action>
  <verify>
    python -c "from flask import Flask; app = Flask(__name__, template_folder='templates'); app.jinja_env.get_template('import.html'); print('Template OK')"
    python -c "from src.import import URLFetcher, GoogleDocsClient; print('Imports OK')"
  </verify>
  <done>
    Import page templates and URL fetcher with Google OAuth support ready
  </done>
</task>

<task type="auto">
  <name>Task 2: Create import JavaScript controller and OAuth endpoints</name>
  <files>
    static/js/pages/import.js
    src/api/import_bp.py
    app.py
  </files>
  <action>
1. Create `static/js/pages/import.js`:
   - ImportController class:
     - constructor(containerEl) - initialize with container
     - setupDropzone() - drag-and-drop handlers
     - setupPaste() - paste event handler
     - setupURLFetch() - URL input and fetch handlers
     - setupGoogleOAuth() - Google connect button handlers
     - analyzeContent(content, filename) - call /api/import/analyze
     - displayAnalysis(result) - show format, suggestions, warnings
     - confirmImport(settings) - call /api/courses/{id}/import
     - showProgress(stage) - update progress indicator

   - Dropzone features:
     - dragenter/dragover/dragleave visual feedback
     - drop handler reads file content
     - Validate file types before upload
     - Show file list for multiple files

   - URL fetch features:
     - Public URL: input + fetch button -> /api/import/fetch-url
     - Google Docs: Connect button -> redirect to OAuth flow
     - After OAuth callback: show Google Doc picker or paste doc URL
     - Fetch Google Doc content via /api/import/google-doc

   - Analysis display:
     - Format detection badge
     - Bloom's level indicator
     - Word count and duration estimate
     - Structure suggestions
     - Warnings for issues

   - Import confirmation:
     - Target selection (which activity/blueprint)
     - Conflict resolution if exists (replace/merge/cancel)
     - Progress indicator during import

   - Error handling:
     - Network errors with retry
     - Parse errors with details
     - OAuth errors with re-auth prompt
     - Toast notifications for status

2. Add OAuth endpoints to existing `src/api/import_bp.py`:

   POST /api/import/fetch-url
   - Accepts: JSON with {url: str}
   - Fetches public URL content
   - Returns: {content, content_type, source_url}

   GET /api/import/oauth/google
   - Initiates Google OAuth flow
   - Redirects to Google authorization URL

   GET /api/import/oauth/google/callback
   - Handles OAuth callback from Google
   - Exchanges code for tokens
   - Stores tokens in session
   - Redirects back to import page with success indicator

   POST /api/import/google-doc
   - Accepts: JSON with {doc_id: str} or {doc_url: str}
   - Uses stored OAuth token to fetch Google Doc
   - Returns: {content, title, source_url}

   GET /api/import/oauth/status
   - Returns: {google_connected: bool, ...}
   - Shows which OAuth providers are connected

3. Add route in app.py:
   - GET /import - renders import.html
   - GET /courses/<id>/import - renders import.html with course context

4. Register route and ensure CSS/JS loaded in base.html
  </action>
  <verify>
    python -c "from app import app; client = app.test_client(); r = client.get('/import'); assert r.status_code == 200"
  </verify>
  <done>
    Import page loads with functional dropzone, paste, URL fetch, and Google OAuth
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Import UI with paste/upload/URL/OAuth functionality</what-built>
  <how-to-verify>
    1. Run `python app.py`
    2. Navigate to http://localhost:5003/import
    3. Test paste: Paste some text, see format detection
    4. Test upload: Drag a file onto dropzone, see preview
    5. Test URL: Enter a public URL, click fetch, see content
    6. Test Google OAuth (if configured):
       a. Click "Connect Google"
       b. Complete OAuth flow
       c. Paste a Google Doc URL and fetch
    7. Verify dark theme styling matches rest of app
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues</resume-signal>
</task>

</tasks>

<verification>
- Import page accessible at /import
- Paste area accepts text and triggers analysis
- Dropzone accepts files with visual feedback
- Public URL fetch works for accessible URLs
- Google OAuth flow initiates and completes
- Google Doc fetch works after OAuth
- Format detection displays correctly
- Analysis shows Bloom's level and suggestions
- Dark theme styling consistent
</verification>

<success_criteria>
- Paste text shows format detection and analysis
- Drag-drop file upload works with multiple files
- Public URL fetch retrieves content
- Google OAuth connects and persists in session
- Google Docs import works via OAuth
- Preview shows parsed content structure
- Import confirmation flow complete
- Styling matches existing dark theme
- Human verification passes
</success_criteria>

<output>
After completion, create `.planning/phases/12-ai-interactive-features/12-10-SUMMARY.md`
</output>
