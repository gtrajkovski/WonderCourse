---
phase: 12-ai-interactive-features
plan: 11
type: execute
wave: 3
depends_on: [12-05, 12-06, 12-07]
files_modified:
  - templates/partials/ai-toolbar.html
  - static/js/components/ai-toolbar.js
  - static/css/components/ai-toolbar.css
  - templates/studio.html
autonomous: false

must_haves:
  truths:
    - "Floating toolbar appears on text selection"
    - "All AI action buttons trigger suggestions"
    - "Suggestions display with diff preview"
    - "Undo/redo buttons work for AI changes"
  artifacts:
    - path: "templates/partials/ai-toolbar.html"
      provides: "Toolbar HTML partial"
      contains: "ai-toolbar"
    - path: "static/js/components/ai-toolbar.js"
      provides: "Toolbar controller"
      contains: "AIToolbar"
  key_links:
    - from: "static/js/components/ai-toolbar.js"
      to: "/api/edit/suggest"
      via: "fetch"
      pattern: "fetch.*api/edit"
---

<objective>
Build the floating AI toolbar for inline text editing.

Purpose: Enable users to select text and access AI editing actions via a floating toolbar (EDIT-01, EDIT-05, EDIT-07). Core UI for inline AI editing experience.
Output: Floating toolbar with action buttons, suggestion preview, and undo/redo integration.
</objective>

<execution_context>
@C:\Users\gpt30\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\gpt30\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/12-ai-interactive-features/12-RESEARCH.md

# Existing studio page for integration
@templates/studio.html
@static/js/pages/studio.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create floating toolbar partial and styles</name>
  <files>
    templates/partials/ai-toolbar.html
    static/css/components/ai-toolbar.css
  </files>
  <action>
1. Create `templates/partials/ai-toolbar.html`:
   - Floating container div with id="ai-toolbar"
   - Quick action buttons row:
     - Improve (wand icon)
     - Expand (arrows-out icon)
     - Simplify (compress icon)
     - Rewrite (refresh icon)
     - More (dropdown with additional actions)

   - Dropdown for extended actions:
     - Fix Grammar
     - Make Academic
     - Make Conversational
     - Add Examples
     - Summarize
     - Change Tone (sub-menu: Formal, Friendly, Professional)
     - Translate (placeholder)

   - Custom prompt input:
     - Text input always visible per CONTEXT.md
     - Send button

   - Preview area (hidden by default):
     - Shows suggestion diff
     - Accept/Reject buttons
     - Regenerate button

   - Undo/Redo buttons at end

   - Bloom's level indicator badge

   Use Unicode icons or simple text labels (no external icon library per Phase 11 pattern)

2. Create `static/css/components/ai-toolbar.css`:
   - Floating positioning with z-index 1000
   - Dark theme: #16213e background, white text
   - Shadow for floating effect
   - Button hover states with accent color
   - Dropdown menu styling
   - Preview pane with diff highlighting:
     - Green for additions
     - Red for deletions
   - Animation for show/hide
   - Responsive width (min 300px, max 500px)
  </action>
  <verify>
    python -c "from flask import Flask; app = Flask(__name__, template_folder='templates'); app.jinja_env.get_template('partials/ai-toolbar.html'); print('Template OK')"
  </verify>
  <done>
    Toolbar partial and styles ready for integration
  </done>
</task>

<task type="auto">
  <name>Task 2: Create toolbar JavaScript controller</name>
  <files>
    static/js/components/ai-toolbar.js
    templates/studio.html
  </files>
  <action>
1. Create `static/js/components/ai-toolbar.js`:
   - AIToolbar class:
     - constructor(options) - configure behavior
     - attach(containerEl) - attach to editable container
     - show(selection, rect) - position and show toolbar
     - hide() - hide toolbar
     - handleAction(action) - dispatch to API

   - Selection detection:
     - Listen for selectionchange event
     - Show toolbar when selection length > 0
     - Position above selection using getBoundingClientRect()
     - Hide on click outside or escape key

   - API integration:
     - callSuggest(text, action) - POST /api/edit/suggest
     - streamSuggest(text, action) - POST /api/edit/suggest/stream with SSE
     - Show loading state during API call

   - Preview display:
     - Show diff between original and suggestion
     - Inline diff with <ins>/<del> tags
     - Accept: replace selection with suggestion, push to history
     - Reject: close preview
     - Regenerate: call API again

   - History integration:
     - Push EditCommand on accept
     - Call /api/edit/history/push
     - Enable undo/redo buttons based on can_undo/can_redo

   - Keyboard shortcuts:
     - Ctrl+Shift+I: Improve
     - Ctrl+Shift+E: Expand
     - Ctrl+Shift+S: Simplify
     - Ctrl+Z: Undo
     - Ctrl+Shift+Z: Redo

2. Update `templates/studio.html`:
   - Include ai-toolbar.html partial
   - Include ai-toolbar.js script
   - Initialize AIToolbar on content editable areas
   - Pass context (learning outcomes, content type) to toolbar
  </action>
  <verify>
    python -c "import os; assert os.path.exists('static/js/components/ai-toolbar.js')"
  </verify>
  <done>
    AI toolbar controller handles all actions with history
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Floating AI toolbar with suggestion preview and undo/redo</what-built>
  <how-to-verify>
    1. Run `python app.py`
    2. Navigate to Studio page with a course/activity
    3. Select some text in the content area
    4. Verify toolbar appears above selection
    5. Click "Improve" - see loading, then suggestion diff
    6. Click Accept - verify content updated
    7. Click Undo - verify content reverted
    8. Test custom prompt input
    9. Test keyboard shortcuts (Ctrl+Shift+I)
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues</resume-signal>
</task>

</tasks>

<verification>
- Toolbar appears on text selection
- All action buttons trigger API calls
- Suggestion preview shows diff
- Accept replaces selected text
- Undo/redo work correctly
- Keyboard shortcuts functional
</verification>

<success_criteria>
- Floating toolbar positions correctly above selection
- All 10+ action types work
- Diff preview clearly shows changes
- History integration enables undo/redo
- Keyboard shortcuts trigger actions
- Human verification passes
</success_criteria>

<output>
After completion, create `.planning/phases/12-ai-interactive-features/12-11-SUMMARY.md`
</output>
