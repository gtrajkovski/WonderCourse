---
phase: 12-ai-interactive-features
plan: 05
type: execute
wave: 1
depends_on: []
files_modified:
  - src/editing/__init__.py
  - src/editing/suggestions.py
  - src/editing/diff_generator.py
  - src/api/edit_bp.py
  - app.py
  - tests/test_editing_suggestions.py
autonomous: true

must_haves:
  truths:
    - "User can request AI suggestions for selected text"
    - "System provides improve, expand, simplify, and rewrite options"
    - "Suggestions include diff showing changes"
    - "Multiple suggestion types available in single request"
  artifacts:
    - path: "src/editing/suggestions.py"
      provides: "AI suggestion generation"
      exports: ["SuggestionEngine"]
    - path: "src/editing/diff_generator.py"
      provides: "Text diff visualization"
      exports: ["DiffGenerator"]
    - path: "src/api/edit_bp.py"
      provides: "Editing API endpoints"
      exports: ["init_edit_bp"]
  key_links:
    - from: "src/api/edit_bp.py"
      to: "SuggestionEngine"
      via: "import and call"
      pattern: "engine\\.suggest"
    - from: "src/editing/suggestions.py"
      to: "Claude API"
      via: "streaming"
      pattern: "client\\.messages\\.stream"
---

<objective>
Build the AI suggestion engine for inline text editing with multiple action types.

Purpose: Enable users to select text and get AI-powered suggestions for improvement (EDIT-01, EDIT-03, EDIT-05, EDIT-07). Core backend for the floating toolbar.
Output: SuggestionEngine with support for improve, expand, simplify, rewrite, and custom prompts.
</objective>

<execution_context>
@C:\Users\gpt30\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\gpt30\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/12-ai-interactive-features/12-RESEARCH.md

# Existing AI patterns
@src/ai/client.py
@src/generators/base_generator.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create SuggestionEngine and DiffGenerator</name>
  <files>
    src/editing/__init__.py
    src/editing/suggestions.py
    src/editing/diff_generator.py
  </files>
  <action>
1. Create `src/editing/__init__.py` - package init

2. Create `src/editing/diff_generator.py`:
   - DiffGenerator class with:
     - generate_diff(original: str, modified: str) -> DiffResult
     - Uses Python difflib for unified diff
     - Returns DiffResult dataclass:
       - original: str
       - modified: str
       - unified_diff: str (unified diff format)
       - html_diff: str (HTML table diff for side-by-side)
       - changes: List[dict] (structured changes with line numbers)
     - generate_inline_diff(original, modified) -> str
       - Returns HTML with <ins> and <del> tags for inline display

3. Create `src/editing/suggestions.py`:
   - SuggestionEngine class with:
     - __init__(model: str = Config.MODEL)
     - suggest(text: str, action: str, context: dict = None) -> Suggestion
     - stream_suggest(text: str, action: str, context: dict = None) -> Iterator[str]

   - Suggestion dataclass:
     - original: str
     - suggestion: str
     - action: str
     - diff: DiffResult
     - explanation: str (why this change was made)

   - Action types with specific prompts:
     - "improve" - Enhance clarity and flow without changing meaning
     - "expand" - Add detail, examples, or elaboration
     - "simplify" - Reduce complexity, shorter sentences
     - "rewrite" - Complete rewrite maintaining meaning
     - "fix_grammar" - Fix grammatical errors only
     - "make_academic" - More formal, scholarly tone
     - "make_conversational" - Casual, friendly tone
     - "summarize" - Condense to key points
     - "add_examples" - Insert concrete examples
     - "custom" - Use context['prompt'] for custom instruction

   - Context dict supports:
     - learning_outcomes: List[str] - for alignment
     - content_type: str - video_script, reading, etc.
     - bloom_level: str - target cognitive level
     - tone: str - tone preset
     - prompt: str - custom prompt for 'custom' action

   - stream_suggest uses Claude streaming for real-time response
  </action>
  <verify>
    python -c "from src.editing import SuggestionEngine, DiffGenerator; print('Imports OK')"
  </verify>
  <done>
    SuggestionEngine and DiffGenerator importable with all action types
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Edit API Blueprint with tests</name>
  <files>
    src/api/edit_bp.py
    app.py
    tests/test_editing_suggestions.py
  </files>
  <action>
1. Create `src/api/edit_bp.py`:
   - init_edit_bp() -> Blueprint

   POST /api/edit/suggest
   - Accepts: JSON with {text: str, action: str, context?: dict}
   - Returns: {original, suggestion, diff, explanation}
   - Non-streaming for simple requests

   POST /api/edit/suggest/stream
   - Accepts: JSON with {text: str, action: str, context?: dict}
   - Returns: Server-Sent Events stream
   - Events: {type: 'chunk', text: str} and {type: 'done', suggestion: full_text}
   - Uses Flask Response with text/event-stream mimetype

   POST /api/edit/diff
   - Accepts: JSON with {original: str, modified: str}
   - Returns: {unified_diff, html_diff, changes}

   GET /api/edit/actions
   - Returns: List of available actions with descriptions

2. Register blueprint in app.py

3. Create `tests/test_editing_suggestions.py`:
   - Test each action type (improve, expand, simplify, etc.)
   - Test diff generation
   - Test context awareness (learning outcomes, bloom level)
   - Test custom prompt action
   - Test streaming endpoint (check SSE format)
   - Mock Claude API for all tests
  </action>
  <verify>
    pytest tests/test_editing_suggestions.py -v
  </verify>
  <done>
    Edit API endpoints work with all action types and streaming
  </done>
</task>

</tasks>

<verification>
- SuggestionEngine supports all 10 action types
- DiffGenerator produces unified and HTML diffs
- Streaming endpoint returns valid SSE format
- Context (learning outcomes, bloom level) affects suggestions
- All tests pass (target: 15+ tests)
</verification>

<success_criteria>
- POST /api/edit/suggest returns suggestion with diff
- POST /api/edit/suggest/stream returns SSE stream
- All action types produce appropriate transformations
- Custom prompt action uses provided prompt
- Context improves suggestion relevance
- All tests pass with mocked AI
</success_criteria>

<output>
After completion, create `.planning/phases/12-ai-interactive-features/12-05-SUMMARY.md`
</output>
