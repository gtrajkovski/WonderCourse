---
phase: 12-ai-interactive-features
plan: 12
type: execute
wave: 3
depends_on: [12-08, 12-09]
files_modified:
  - templates/coach.html
  - templates/partials/coach-chat.html
  - static/js/pages/coach.js
  - static/css/components/coach.css
autonomous: false

must_haves:
  truths:
    - "Student can type messages and receive AI responses"
    - "Coach responses stream in real-time"
    - "Evaluation displays after each response"
    - "Session summary shows at conversation end"
  artifacts:
    - path: "templates/coach.html"
      provides: "Coach chat page"
      contains: "coach-container"
    - path: "static/js/pages/coach.js"
      provides: "Coach UI controller"
      contains: "CoachController"
  key_links:
    - from: "static/js/pages/coach.js"
      to: "/api/coach/chat/stream"
      via: "EventSource"
      pattern: "new EventSource"
---

<objective>
Build the Interactive Coach chat UI for student-AI conversations.

Purpose: Enable students to interact with an AI coach through a chat interface with real-time responses (COACH-01, COACH-05, COACH-08). Student-facing component of interactive coaching.
Output: Chat interface with message display, input, streaming responses, and evaluation feedback.
</objective>

<execution_context>
@C:\Users\gpt30\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\gpt30\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/12-ai-interactive-features/12-CONTEXT.md

# Existing UI patterns
@templates/base.html
@static/css/main.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create coach chat page and styles</name>
  <files>
    templates/coach.html
    templates/partials/coach-chat.html
    static/css/components/coach.css
  </files>
  <action>
1. Create `templates/coach.html`:
   - Extends base.html (show_sidebar=false for focused experience)
   - Full-height chat layout:
     a) Header: Coach name/avatar, activity title, progress indicator
     b) Messages area: Scrollable message list
     c) Input area: Text input with send button

   - Header section:
     - Coach avatar (placeholder icon)
     - Coach name from persona
     - Activity/topic title
     - Coverage progress bar (% of dialogue sections covered)
     - End Session button

   - Evaluation sidebar (toggleable):
     - Current level indicator (developing/proficient/exemplary)
     - Strengths list
     - Areas for improvement
     - Hints toggle (if enabled)

2. Create `templates/partials/coach-chat.html`:
   - Message template for both user and coach messages:
     - Avatar (user icon vs coach icon)
     - Message content with markdown support
     - Timestamp
     - Evaluation badge for coach responses (optional)

   - Typing indicator for streaming responses

   - Session summary card (shown at end):
     - Overall evaluation
     - Key insights
     - Recommendations
     - Continue/New Session buttons

3. Create `static/css/components/coach.css`:
   - Chat bubble styling:
     - User messages: right-aligned, accent color background
     - Coach messages: left-aligned, darker background
   - Avatar styling with circular clips
   - Input area with dark theme
   - Streaming text animation (cursor blink)
   - Evaluation badge colors:
     - Developing: orange
     - Proficient: blue
     - Exemplary: green
   - Progress bar styling
   - Summary card styling with gradient border
  </action>
  <verify>
    python -c "from flask import Flask; app = Flask(__name__, template_folder='templates'); app.jinja_env.get_template('coach.html'); print('Template OK')"
  </verify>
  <done>
    Coach chat templates and styles ready
  </done>
</task>

<task type="auto">
  <name>Task 2: Create coach JavaScript controller</name>
  <files>
    static/js/pages/coach.js
    app.py
  </files>
  <action>
1. Create `static/js/pages/coach.js`:
   - CoachController class:
     - constructor(courseId, activityId) - initialize with IDs
     - startSession() - POST /coach/start, store session_id
     - sendMessage(text) - send user message
     - receiveStream() - handle SSE response
     - endSession() - POST /coach/end, show summary
     - continueSession(transcriptId) - resume previous

   - Message handling:
     - Add user message immediately to UI
     - Start SSE stream for coach response
     - Append chunks as they arrive
     - Show evaluation when complete

   - SSE handling per RESEARCH.md:
     - Create EventSource with session context
     - Handle 'chunk' events: append to current message
     - Handle 'evaluation' events: display badge
     - Handle 'done' events: finalize message
     - Reconnection on error with retry

   - Evaluation display:
     - Update sidebar with current level
     - Show strengths/improvements list
     - Animate progress bar on coverage change

   - Session management:
     - Store session_id in sessionStorage
     - Prompt to continue if previous session exists
     - Clear on End Session

   - Keyboard shortcuts:
     - Enter: Send message
     - Shift+Enter: New line

2. Add routes in app.py:
   - GET /courses/<id>/activities/<aid>/coach - renders coach.html
   - GET /coach/preview/<course_id>/<activity_id> - instructor preview mode

3. Ensure proper context passed to template (course, activity, persona)
  </action>
  <verify>
    python -c "import os; assert os.path.exists('static/js/pages/coach.js')"
  </verify>
  <done>
    Coach JavaScript controller handles streaming and evaluation
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Interactive coach chat with streaming and evaluation</what-built>
  <how-to-verify>
    1. Run `python app.py`
    2. Create a coach dialogue activity via Studio
    3. Navigate to /courses/{id}/activities/{aid}/coach
    4. Verify welcome message from coach
    5. Type a message and send
    6. Watch coach response stream in real-time
    7. Check evaluation appears (developing/proficient/exemplary)
    8. Send a few more messages
    9. Click End Session
    10. Verify summary displays with recommendations
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues</resume-signal>
</task>

</tasks>

<verification>
- Chat page loads with coach persona
- Messages display correctly (user right, coach left)
- Coach responses stream in real-time
- Evaluation badge appears after responses
- Progress bar updates with coverage
- Session summary displays on end
</verification>

<success_criteria>
- Real-time streaming chat works
- Evaluation displays for each response
- Coverage progress tracks dialogue sections
- Session end shows comprehensive summary
- Continue session resumes previous conversation
- Human verification passes
</success_criteria>

<output>
After completion, create `.planning/phases/12-ai-interactive-features/12-12-SUMMARY.md`
</output>
