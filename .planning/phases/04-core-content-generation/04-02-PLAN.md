---
phase: 04-core-content-generation
plan: 02
type: tdd
wave: 2
depends_on: ["04-01"]
files_modified:
  - src/generators/video_script_generator.py
  - tests/test_video_script_generator.py
autonomous: true

must_haves:
  truths:
    - "VideoScriptGenerator produces WWHAA-structured video scripts with all 6 sections"
    - "Generated scripts include hook, objective, content, IVQ, summary, and CTA sections"
    - "Metadata includes word_count and estimated_duration_minutes based on 150 WPM"
  artifacts:
    - path: "src/generators/video_script_generator.py"
      provides: "VideoScriptGenerator extending BaseGenerator"
      contains: "class VideoScriptGenerator"
    - path: "tests/test_video_script_generator.py"
      provides: "Tests with mocked Anthropic API"
      contains: "def test_"
  key_links:
    - from: "src/generators/video_script_generator.py"
      to: "src/generators/base_generator.py"
      via: "extends BaseGenerator"
      pattern: "class VideoScriptGenerator\\(BaseGenerator"
    - from: "src/generators/video_script_generator.py"
      to: "src/generators/schemas/video_script.py"
      via: "uses VideoScriptSchema"
      pattern: "from src.generators.schemas.video_script import"
---

<objective>
Implement VideoScriptGenerator using TDD, producing WWHAA-structured video scripts with Hook (10%), Objective (10%), Content (60%), IVQ (5%), Summary (10%), CTA (5%) sections.

Purpose: Enable video script generation - the most common content type in Coursera courses (~30% of content).
Output: Working VideoScriptGenerator with full test coverage via mocked API.
</objective>

<execution_context>
@C:\Users\gpt30\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\gpt30\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/04-core-content-generation/04-RESEARCH.md
@.planning/phases/04-core-content-generation/04-01-SUMMARY.md
@src/generators/base_generator.py
@src/generators/schemas/video_script.py
@src/utils/content_metadata.py
@src/config.py
</context>

<feature>
  <name>VideoScriptGenerator with WWHAA structure</name>
  <files>src/generators/video_script_generator.py, tests/test_video_script_generator.py</files>
  <behavior>
    VideoScriptGenerator extends BaseGenerator[VideoScriptSchema].

    Input: learning_objective (str), topic (str), audience_level (str), duration_minutes (int, default 8)
    Output: (VideoScriptSchema, metadata_dict) tuple

    Behavior cases:
    - generate(schema=VideoScriptSchema, learning_objective="...", topic="...", audience_level="intermediate") -> returns VideoScriptSchema with all 6 WWHAA sections populated
    - Each section has phase, title, script_text, speaker_notes fields
    - extract_metadata() returns {"word_count": N, "estimated_duration_minutes": M, "section_word_counts": {...}}
    - Word count sums script_text from all 6 sections
    - Duration calculated at 150 WPM using ContentMetadata
    - system_prompt includes WWHAA structure with proportions (Hook 10%, Objective 10%, Content 60%, IVQ 5%, Summary 10%, CTA 5%)
    - build_user_prompt() includes learning_objective, topic, audience_level, target duration

    Error case:
    - API raises anthropic.APIError -> propagates (no swallowing)
  </behavior>
  <implementation>
    Create VideoScriptGenerator class:
    - system_prompt property: Expert instructional video scriptwriter, WWHAA structure with percentage guidelines, Coursera conventions
    - build_user_prompt(): Takes learning_objective, topic, audience_level, duration_minutes. Formats as CONTEXT/TASK structure matching BlueprintGenerator pattern
    - extract_metadata(): Uses ContentMetadata.count_words() on concatenated script_text from all sections. Uses ContentMetadata.estimate_video_duration(). Includes per-section word counts.
    - Convenience method generate_script(learning_objective, topic, audience_level, duration_minutes) that calls self.generate(VideoScriptSchema, ...) for cleaner API

    Tests (use pytest-mock to mock anthropic.Anthropic):
    1. test_generate_returns_valid_schema - Mock API returns valid VideoScriptSchema JSON, verify all 6 sections present
    2. test_system_prompt_contains_wwhaa - Verify system_prompt mentions WWHAA sections and percentages
    3. test_build_user_prompt_includes_params - Verify learning_objective, topic, audience_level appear in prompt
    4. test_extract_metadata_calculates_correctly - Create VideoScriptSchema manually, verify word count and duration
    5. test_metadata_includes_section_word_counts - Verify section_word_counts dict in metadata
    6. test_api_called_with_output_config - Verify messages.create called with output_config.format.type="json_schema"

    Mock pattern (follow Phase 3 test_blueprint_api.py):
    ```python
    mock_response = MagicMock()
    mock_response.content = [MagicMock(text='{"title": "...", "hook": {...}, ...}')]
    mocker.patch("src.generators.video_script_generator.Anthropic").return_value.messages.create.return_value = mock_response
    ```
  </implementation>
</feature>

<verification>
1. `python -m pytest tests/test_video_script_generator.py -v` - All tests pass
2. `python -m pytest tests/ -v` - No regressions
</verification>

<success_criteria>
- VideoScriptGenerator extends BaseGenerator and generates WWHAA video scripts
- 6+ tests passing with mocked API
- Metadata includes word_count, estimated_duration_minutes, section_word_counts
- System prompt specifies WWHAA proportions
- No regressions in existing tests
</success_criteria>

<output>
After completion, create `.planning/phases/04-core-content-generation/04-02-SUMMARY.md`
</output>
