---
phase: 04-core-content-generation
plan: 07
type: execute
wave: 4
depends_on: ["04-06"]
files_modified:
  - src/api/build_state.py
  - tests/test_build_state_api.py
  - app.py
autonomous: true

must_haves:
  truths:
    - "User can view build progress for a course showing per-activity build state"
    - "User can update build state for any activity (e.g., mark as reviewed or approved)"
    - "Progress endpoint shows aggregate counts by build state"
  artifacts:
    - path: "src/api/build_state.py"
      provides: "Build state API Blueprint with progress and state update endpoints"
      contains: "build_state_bp = Blueprint"
    - path: "tests/test_build_state_api.py"
      provides: "API tests for build state tracking"
      contains: "def test_"
  key_links:
    - from: "src/api/build_state.py"
      to: "src/core/models.py"
      via: "uses BuildState enum and Activity model"
      pattern: "from src.core.models import.*BuildState"
    - from: "app.py"
      to: "src/api/build_state.py"
      via: "registers build_state_bp Blueprint"
      pattern: "init_build_state_bp"
---

<objective>
Create build state tracking API endpoints that let users view content generation progress across a course and update individual activity build states through the review/approve workflow.

Purpose: Enable the review workflow (GENERATED -> REVIEWED -> APPROVED) and provide a progress dashboard view showing how much content is complete.
Output: Build state API Blueprint with progress and state update endpoints, registered in app.py, with tests.
</objective>

<execution_context>
@C:\Users\gpt30\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\gpt30\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/04-core-content-generation/04-RESEARCH.md
@.planning/phases/04-core-content-generation/04-06-SUMMARY.md
@src/api/content.py
@src/core/models.py
@app.py
@tests/conftest.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create build state API Blueprint with progress endpoint</name>
  <files>
    src/api/build_state.py
    app.py
  </files>
  <action>
Create `src/api/build_state.py` as a Flask Blueprint following the established pattern:

```python
build_state_bp = Blueprint('build_state', __name__)
_project_store = None

def init_build_state_bp(project_store):
    global _project_store
    _project_store = project_store
```

Endpoints:

**GET /api/courses/<course_id>/progress**
- Returns aggregate build state progress for all activities in the course
- Logic:
  1. Load course
  2. Traverse all modules -> lessons -> activities
  3. Count activities per BuildState value
  4. Calculate completion percentage (APPROVED + PUBLISHED) / total
  5. Return JSON:
  ```json
  {
    "total_activities": 15,
    "by_state": {
      "draft": 3,
      "generating": 0,
      "generated": 5,
      "reviewed": 4,
      "approved": 3,
      "published": 0
    },
    "completion_percentage": 20.0,
    "activities": [
      {"id": "act_xxx", "title": "...", "content_type": "video", "build_state": "generated", "word_count": 450}
    ]
  }
  ```
  - The `activities` list provides per-activity detail for the progress dashboard
- Error: 404 if course not found

**PUT /api/courses/<course_id>/activities/<activity_id>/state**
- Request JSON: `{"build_state": "reviewed"}`
- Logic:
  1. Load course, find activity
  2. Validate state transition is allowed:
     - DRAFT -> GENERATING (only via generate endpoint, not manual)
     - GENERATING -> GENERATED (only via generate endpoint)
     - GENERATED -> REVIEWED (manual)
     - REVIEWED -> APPROVED (manual)
     - APPROVED -> PUBLISHED (manual)
     - GENERATED -> DRAFT (allow reverting to regenerate)
     - REVIEWED -> GENERATED (allow reverting)
     - APPROVED -> REVIEWED (allow reverting)
  3. If transition not allowed, return 400 with allowed transitions
  4. Update activity.build_state, save, return updated activity
- Error: 404 if course/activity not found, 400 if invalid transition

**POST /api/courses/<course_id>/activities/<activity_id>/approve**
- Convenience endpoint: Sets build_state to APPROVED
- Only allowed from REVIEWED state
- Returns updated activity
- Error: 400 if not in REVIEWED state, 404 if not found

Register in `app.py`: Import init_build_state_bp, call with project_store, register build_state_bp.
  </action>
  <verify>Run `python -c "from src.api.build_state import build_state_bp, init_build_state_bp; print('Build state API importable')"` to verify.</verify>
  <done>Build state API Blueprint created with progress, state update, and approve endpoints. Registered in app.py.</done>
</task>

<task type="auto">
  <name>Task 2: Create build state API tests</name>
  <files>
    tests/test_build_state_api.py
  </files>
  <action>
Create `tests/test_build_state_api.py` with tests using the `client` fixture from conftest.py.

Test helper: Create a course with 2 modules, 2 lessons each, with activities in various build states. Set build_state by directly modifying the course data via ProjectStore (access through app_module.project_store).

Tests:
1. test_progress_empty_course - GET progress for course with no modules, verify total_activities=0
2. test_progress_counts_by_state - Create activities with different build states, verify by_state counts
3. test_progress_completion_percentage - Create 10 activities (3 approved), verify completion_percentage=30.0
4. test_progress_includes_activity_list - Verify activities array in response with id, title, content_type, build_state
5. test_progress_404_course_not_found - GET progress with bad course_id, verify 404
6. test_update_state_generated_to_reviewed - PUT state "reviewed" on GENERATED activity, verify 200
7. test_update_state_reviewed_to_approved - PUT state "approved" on REVIEWED activity, verify 200
8. test_update_state_invalid_transition - PUT state "approved" on DRAFT activity, verify 400
9. test_update_state_revert_generated_to_draft - PUT state "draft" on GENERATED activity, verify 200
10. test_approve_endpoint_from_reviewed - POST approve on REVIEWED activity, verify 200 with approved state
11. test_approve_endpoint_from_wrong_state - POST approve on DRAFT activity, verify 400
12. test_update_state_404_activity - PUT state with bad activity_id, verify 404

To set build states directly in tests, use the pattern:
```python
# Create course and activity via API, then modify build_state directly
import app as app_module
course = app_module.project_store.load(course_id)
# Find and modify activity
for m in course.modules:
    for l in m.lessons:
        for a in l.activities:
            if a.id == activity_id:
                a.build_state = BuildState.GENERATED
app_module.project_store.save(course)
```
  </action>
  <verify>Run `python -m pytest tests/test_build_state_api.py -v` and confirm all 12 tests pass.</verify>
  <done>12 build state API tests passing, covering progress reporting, state transitions, revert paths, and error cases.</done>
</task>

</tasks>

<verification>
1. `python -m pytest tests/test_build_state_api.py -v` - All 12 tests pass
2. `python -m pytest tests/ -v` - No regressions, all tests pass
3. `python -c "from app import app; print([r.rule for r in app.url_map.iter_rules() if 'progress' in r.rule or 'state' in r.rule or 'approve' in r.rule])"` - Verify endpoints registered
</verification>

<success_criteria>
- Build state API Blueprint registered in app.py with progress, state update, and approve endpoints
- 12+ tests passing
- Progress endpoint shows aggregate counts and per-activity detail
- State transitions validated (invalid transitions return 400)
- Revert paths work (GENERATED -> DRAFT, REVIEWED -> GENERATED, etc.)
- No regressions
</success_criteria>

<output>
After completion, create `.planning/phases/04-core-content-generation/04-07-SUMMARY.md`
</output>
