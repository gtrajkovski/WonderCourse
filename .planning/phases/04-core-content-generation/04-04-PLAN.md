---
phase: 04-core-content-generation
plan: 04
type: tdd
wave: 2
depends_on: ["04-01"]
files_modified:
  - src/generators/quiz_generator.py
  - tests/test_quiz_generator.py
autonomous: true

must_haves:
  truths:
    - "QuizGenerator produces MCQ quizzes with option-level feedback and balanced answer distribution"
    - "Each question has 3-4 options with exactly 1 correct and 2-3 plausible distractors"
    - "Metadata includes word_count, estimated_duration_minutes (1.5 min/question), and question_count"
  artifacts:
    - path: "src/generators/quiz_generator.py"
      provides: "QuizGenerator extending BaseGenerator"
      contains: "class QuizGenerator"
    - path: "tests/test_quiz_generator.py"
      provides: "Tests with mocked Anthropic API"
      contains: "def test_"
  key_links:
    - from: "src/generators/quiz_generator.py"
      to: "src/generators/base_generator.py"
      via: "extends BaseGenerator"
      pattern: "class QuizGenerator\\(BaseGenerator"
    - from: "src/generators/quiz_generator.py"
      to: "src/generators/schemas/quiz.py"
      via: "uses QuizSchema"
      pattern: "from src.generators.schemas.quiz import"
---

<objective>
Implement QuizGenerator using TDD, producing graded MCQ quizzes with plausible distractors, option-level feedback, and balanced answer distribution.

Purpose: Enable quiz generation for graded assessments - critical for learner evaluation covering ~20% of course content.
Output: Working QuizGenerator with full test coverage via mocked API.
</objective>

<execution_context>
@C:\Users\gpt30\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\gpt30\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/04-core-content-generation/04-RESEARCH.md
@.planning/phases/04-core-content-generation/04-01-SUMMARY.md
@src/generators/base_generator.py
@src/generators/schemas/quiz.py
@src/utils/content_metadata.py
@src/config.py
</context>

<feature>
  <name>QuizGenerator with distractor quality checks</name>
  <files>src/generators/quiz_generator.py, tests/test_quiz_generator.py</files>
  <behavior>
    QuizGenerator extends BaseGenerator[QuizSchema].

    Input: learning_objective (str), topic (str), bloom_level (str), num_questions (int, default 5), difficulty (str, default "intermediate")
    Output: (QuizSchema, metadata_dict) tuple

    Behavior cases:
    - generate(schema=QuizSchema, ...) -> returns QuizSchema with 3-10 QuizQuestion items
    - Each QuizQuestion has question_text, options (3-4 QuizOption items), bloom_level, explanation
    - Each QuizOption has text, is_correct (bool), feedback (str)
    - Exactly 1 option per question has is_correct=True
    - extract_metadata() returns {"word_count": N, "estimated_duration_minutes": M, "question_count": Q}
    - Duration = num_questions * 1.5 minutes (using ContentMetadata.estimate_quiz_duration)
    - Word count sums all question_text + all option text
    - system_prompt includes distractor quality guidelines (plausible, common misconceptions, similar length)
    - build_user_prompt() includes learning_objective, topic, bloom_level, num_questions, difficulty

    Validation helper (static method on QuizGenerator):
    - validate_answer_distribution(quiz: QuizSchema) -> dict: Checks that correct answer position varies across questions. Returns {"balanced": bool, "distribution": {position: count}}
  </behavior>
  <implementation>
    Create QuizGenerator class:
    - system_prompt property: Expert assessment designer, MCQ best practices, distractor guidelines (plausible, represent misconceptions, similar length/complexity, avoid "all/none of the above"), option-level feedback requirements
    - build_user_prompt(): Takes learning_objective, topic, bloom_level, num_questions, difficulty. Format as CONTEXT/TASK. Include "Each question must have exactly 1 correct answer and 2-3 plausible distractors with individual feedback"
    - extract_metadata(): Count words in all question_text + option texts. Duration = ContentMetadata.estimate_quiz_duration(len(quiz.questions)). Include question_count.
    - validate_answer_distribution(quiz): For each question, find index of correct option. Check no position > 50% of total questions. Return balanced flag and distribution dict.
    - Convenience method generate_quiz(learning_objective, topic, bloom_level, num_questions, difficulty) that calls self.generate(QuizSchema, ...)

    Tests (use pytest-mock):
    1. test_generate_returns_valid_schema - Mock API returns valid QuizSchema JSON with 3 questions, verify structure
    2. test_each_question_has_one_correct - Verify exactly 1 is_correct=True per question in mock response
    3. test_system_prompt_contains_distractor_guidelines - Verify system_prompt mentions plausible distractors and misconceptions
    4. test_build_user_prompt_includes_bloom_level - Verify bloom_level and num_questions in prompt
    5. test_extract_metadata_calculates_duration - Create QuizSchema with 5 questions, verify duration=7.5
    6. test_validate_answer_distribution_balanced - Create quiz with varied correct positions, verify balanced=True
    7. test_validate_answer_distribution_biased - Create quiz where all correct are position 0, verify balanced=False
    8. test_api_called_with_output_config - Verify messages.create uses output_config parameter

    Mock JSON response should include 3 questions each with 3 options (1 correct, 2 distractors) with feedback.
  </implementation>
</feature>

<verification>
1. `python -m pytest tests/test_quiz_generator.py -v` - All tests pass
2. `python -m pytest tests/ -v` - No regressions
</verification>

<success_criteria>
- QuizGenerator extends BaseGenerator and generates MCQ quizzes
- 8+ tests passing with mocked API
- Each question has exactly 1 correct answer with option-level feedback
- validate_answer_distribution detects biased answer keys
- Duration calculated at 1.5 min per question
- No regressions in existing tests
</success_criteria>

<output>
After completion, create `.planning/phases/04-core-content-generation/04-04-SUMMARY.md`
</output>
