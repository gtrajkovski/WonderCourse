---
phase: 04-core-content-generation
plan: 03
type: tdd
wave: 2
depends_on: ["04-01"]
files_modified:
  - src/generators/reading_generator.py
  - tests/test_reading_generator.py
autonomous: true

must_haves:
  truths:
    - "ReadingGenerator produces structured readings with introduction, sections, conclusion, and APA 7 references"
    - "Metadata includes word_count and estimated_duration_minutes based on 238 WPM"
    - "Readings are prompted for max 1200 words with structured sections"
  artifacts:
    - path: "src/generators/reading_generator.py"
      provides: "ReadingGenerator extending BaseGenerator"
      contains: "class ReadingGenerator"
    - path: "tests/test_reading_generator.py"
      provides: "Tests with mocked Anthropic API"
      contains: "def test_"
  key_links:
    - from: "src/generators/reading_generator.py"
      to: "src/generators/base_generator.py"
      via: "extends BaseGenerator"
      pattern: "class ReadingGenerator\\(BaseGenerator"
    - from: "src/generators/reading_generator.py"
      to: "src/generators/schemas/reading.py"
      via: "uses ReadingSchema"
      pattern: "from src.generators.schemas.reading import"
---

<objective>
Implement ReadingGenerator using TDD, producing structured readings with introduction, body sections, conclusion, and APA 7 formatted references.

Purpose: Enable reading material generation - the second most common content type covering ~20% of course content.
Output: Working ReadingGenerator with full test coverage via mocked API.
</objective>

<execution_context>
@C:\Users\gpt30\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\gpt30\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/04-core-content-generation/04-RESEARCH.md
@.planning/phases/04-core-content-generation/04-01-SUMMARY.md
@src/generators/base_generator.py
@src/generators/schemas/reading.py
@src/utils/content_metadata.py
@src/config.py
</context>

<feature>
  <name>ReadingGenerator with APA 7 citations</name>
  <files>src/generators/reading_generator.py, tests/test_reading_generator.py</files>
  <behavior>
    ReadingGenerator extends BaseGenerator[ReadingSchema].

    Input: learning_objective (str), topic (str), audience_level (str), max_words (int, default 1200)
    Output: (ReadingSchema, metadata_dict) tuple

    Behavior cases:
    - generate(schema=ReadingSchema, learning_objective="...", topic="...", audience_level="intermediate") -> returns ReadingSchema with introduction, sections, conclusion, references
    - sections list has 2-6 ReadingSection items each with heading and body
    - references list has 1-5 Reference items with APA 7 formatted citations
    - extract_metadata() returns {"word_count": N, "estimated_duration_minutes": M}
    - Word count sums introduction + all section bodies + conclusion
    - Duration calculated at 238 WPM using ContentMetadata
    - system_prompt includes APA 7 citation format examples and 1200-word max guideline
    - build_user_prompt() includes learning_objective, topic, audience_level, max_words
  </behavior>
  <implementation>
    Create ReadingGenerator class:
    - system_prompt property: Expert educational content writer, academic reading conventions, APA 7 reference format (include example: "Author, A. A. (Year). Title of work. Publisher. https://doi.org/xxx"), 1200-word guideline, structured sections with clear headings
    - build_user_prompt(): Takes learning_objective, topic, audience_level, max_words. Format as CONTEXT/TASK. Include "Maximum word count: {max_words}" and "Include 2-5 APA 7 formatted references"
    - extract_metadata(): Concatenates introduction + all section bodies + conclusion, uses ContentMetadata.count_words() and ContentMetadata.estimate_reading_duration()
    - Convenience method generate_reading(learning_objective, topic, audience_level, max_words) that calls self.generate(ReadingSchema, ...)

    Tests (use pytest-mock):
    1. test_generate_returns_valid_schema - Mock API returns valid ReadingSchema JSON, verify introduction, sections, conclusion, references present
    2. test_system_prompt_contains_apa7 - Verify system_prompt mentions APA 7 and includes citation example
    3. test_build_user_prompt_includes_max_words - Verify max_words appears in prompt
    4. test_extract_metadata_calculates_correctly - Create ReadingSchema manually with known word counts, verify metadata
    5. test_metadata_duration_uses_238_wpm - Verify 238 WPM rate for reading duration
    6. test_api_called_with_output_config - Verify messages.create uses output_config parameter

    Mock pattern: Same as Plan 02 but with ReadingSchema JSON response containing introduction, sections array, conclusion, references array.
  </implementation>
</feature>

<verification>
1. `python -m pytest tests/test_reading_generator.py -v` - All tests pass
2. `python -m pytest tests/ -v` - No regressions
</verification>

<success_criteria>
- ReadingGenerator extends BaseGenerator and generates structured readings
- 6+ tests passing with mocked API
- System prompt includes APA 7 citation format and examples
- Metadata uses 238 WPM for duration calculation
- No regressions in existing tests
</success_criteria>

<output>
After completion, create `.planning/phases/04-core-content-generation/04-03-SUMMARY.md`
</output>
