---
phase: 06-textbook-generation
plan: 04
type: tdd
wave: 2
depends_on: ["06-01"]
files_modified:
  - src/utils/coherence_validator.py
  - tests/test_coherence_validator.py
autonomous: true

must_haves:
  truths:
    - "CoherenceValidator checks for contradictions between sections using LLM"
    - "CoherenceValidator checks glossary term consistency (terms used in text)"
    - "CoherenceValidator checks for redundant content between sections"
    - "Validator returns list of issue strings (empty list = no issues)"
    - "Validator uses Anthropic client for LLM-based contradiction checking"
  artifacts:
    - path: "src/utils/coherence_validator.py"
      provides: "Post-generation coherence validation"
      exports: ["CoherenceValidator"]
      min_lines: 60
    - path: "tests/test_coherence_validator.py"
      provides: "Coherence validator tests with mocked API"
      min_lines: 60
  key_links:
    - from: "src/utils/coherence_validator.py"
      to: "src/generators/schemas/textbook.py"
      via: "imports TextbookSectionSchema and GlossaryTerm"
      pattern: "from src\\.generators\\.schemas\\.textbook import"
---

<objective>
Build the CoherenceValidator that performs post-generation quality checks on textbook chapters: contradiction detection (LLM-based), glossary term consistency, and redundancy detection.

Purpose: Long-form content generated section-by-section can have contradictions, inconsistent terminology, and redundant passages. The validator catches these issues before returning the chapter to the user.
Output: Working CoherenceValidator with 3 check types, tested with mocked API.
</objective>

<execution_context>
@C:\Users\gpt30\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\gpt30\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/generators/schemas/textbook.py
@src/generators/base_generator.py
@src/config.py
</context>

<feature>
  <name>CoherenceValidator for Textbook Chapters</name>
  <files>src/utils/coherence_validator.py, tests/test_coherence_validator.py</files>
  <behavior>
  CoherenceValidator performs 3 types of checks on generated chapter content:

  **__init__(api_key=None, model=None):**
  - Creates Anthropic client (same pattern as BaseGenerator.__init__)
  - Stores model (default Config.MODEL)

  **check_consistency(sections: List[TextbookSectionSchema], glossary_terms: List[GlossaryTerm]) -> List[str]:**
  - Runs all 3 checks, returns combined list of issue strings
  - Empty list = no issues found

  **_check_contradictions(sections: List[TextbookSectionSchema]) -> List[str]:**
  - Uses LLM to check for contradictory statements across sections
  - Sends all section content to Claude with prompt asking to identify contradictions
  - Parses response for contradiction descriptions
  - Returns list of contradiction descriptions (or empty list)

  **_check_term_consistency(sections: List[TextbookSectionSchema], glossary_terms: List[GlossaryTerm]) -> List[str]:**
  - For each glossary term, checks if the term appears in at least one section's content (case-insensitive)
  - Returns list of issues like "Glossary term 'X' not found in chapter text"
  - Pure Python check, no LLM call needed

  **_check_redundancy(sections: List[TextbookSectionSchema]) -> List[str]:**
  - Simple check: if any two sections share the same heading, flag it
  - Check if any section's content appears substantially in another section (>50% word overlap)
  - Returns list of redundancy warnings
  - Pure Python check for Phase 6 (sentence embeddings deferred to future)

  Test cases:
  - check_consistency returns empty list for non-contradictory content
  - _check_term_consistency flags missing glossary terms
  - _check_term_consistency passes when all terms found in text
  - _check_redundancy flags duplicate headings
  - _check_contradictions calls LLM with all section content
  - check_consistency combines results from all 3 checks
  </behavior>
  <implementation>
  The validator is NOT a generator (doesn't extend BaseGenerator). It's a utility class that:
  1. Takes already-generated sections and glossary terms as input
  2. Performs automated text checks (term consistency, redundancy)
  3. Uses one LLM call for contradiction detection

  For contradiction checking, send a prompt like:
  "Review these textbook sections for factual contradictions. List any contradictory statements. If none found, respond with 'NO_CONTRADICTIONS'."

  Parse the response: if it contains "NO_CONTRADICTIONS", return empty list. Otherwise, split by newlines and return non-empty lines as issues.

  For testing: mock `src.utils.coherence_validator.Anthropic` (same pattern as generator tests). Create TextbookSectionSchema and GlossaryTerm instances directly for test data.
  </implementation>
</feature>

<verification>
- CoherenceValidator importable from `src.utils.coherence_validator`
- All tests pass with mocked Anthropic API
- Term consistency check works without LLM
- Contradiction check uses LLM call
- Existing tests still pass: `python -m pytest` (300+ tests)
</verification>

<success_criteria>
- CoherenceValidator performs 3 types of quality checks
- LLM-based contradiction detection with fallback parsing
- Pure Python term consistency and redundancy checks
- Returns list of issue strings (empty = no issues)
- All tests pass with mocked API
</success_criteria>

<output>
After completion, create `.planning/phases/06-textbook-generation/06-04-SUMMARY.md`
</output>
