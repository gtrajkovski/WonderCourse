---
phase: 01-foundation-infrastructure
plan: 04
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - src/ai/client.py
  - src/utils/ai_client.py
  - tests/test_ai_client.py
autonomous: true

must_haves:
  truths:
    - "AIClient.chat() sends message with conversation history and returns response text"
    - "AIClient.chat() accumulates messages in conversation_history"
    - "AIClient.generate() sends one-shot request without polluting history"
    - "AIClient.clear_history() resets conversation_history to empty list"
    - "OneShot generate() sends system+user prompt and returns response text"
    - "Both clients handle missing API key gracefully"
    - "Both clients use Config.MODEL and Config.MAX_TOKENS"
  artifacts:
    - path: "src/ai/client.py"
      provides: "Conversational AI client with history management"
      contains: "class AIClient"
      min_lines: 50
    - path: "src/utils/ai_client.py"
      provides: "One-shot AI client for batch generation"
      contains: "def generate"
      min_lines: 20
    - path: "tests/test_ai_client.py"
      provides: "Tests with mocked Anthropic API"
      contains: "test_chat_accumulates_history"
      min_lines: 60
  key_links:
    - from: "src/ai/client.py"
      to: "src/config.py"
      via: "Config.ANTHROPIC_API_KEY and Config.MODEL"
      pattern: "Config\\.ANTHROPIC_API_KEY|Config\\.MODEL"
---

<objective>
Create dual AI client abstraction -- conversational client for interactive features and one-shot client for batch generation.

Purpose: AI clients are needed by Flask routes for content generation, improvement, and validation. The conversational client maintains history for multi-turn interactions; the one-shot client is stateless for batch operations.
Output: src/ai/client.py (conversational), src/utils/ai_client.py (one-shot), tests/test_ai_client.py
</objective>

<execution_context>
@C:\Users\gpt30\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\gpt30\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

Reference patterns from ScreenCast Studio:
@C:\ScreencastHelper\src\ai\client.py
@C:\ScreencastHelper\src\utils\ai_client.py

Depends on Plan 01-01 output:
@.planning/phases/01-foundation-infrastructure/01-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create conversational AI client</name>
  <files>src/ai/client.py</files>
  <action>
    Create `src/ai/client.py` following ScreenCast Studio's pattern (C:\ScreencastHelper\src\ai\client.py):

    ```python
    class AIClient:
        def __init__(self):
            self.client = anthropic.Anthropic(api_key=Config.ANTHROPIC_API_KEY)
            self.model = Config.MODEL
            self.max_tokens = Config.MAX_TOKENS
            self.conversation_history: List[Dict[str, str]] = []

        def chat(self, user_message: str, system_prompt: str = None) -> str:
            """Send message with conversation history, return response."""
            # Append user message to history
            # Call API with full history
            # Append assistant response to history
            # Return response text

        def chat_stream(self, user_message: str, system_prompt: str = None) -> Generator[str, None, None]:
            """Streaming version of chat, yields text chunks."""
            # Same history management as chat
            # Use client.messages.stream() context manager
            # Yield text deltas

        def generate(self, system_prompt: str, user_prompt: str, max_tokens: int = None) -> str:
            """One-shot generation without history pollution."""
            # DO NOT modify conversation_history
            # Single API call with [{"role": "user", "content": user_prompt}]

        def clear_history(self):
            """Reset conversation history."""
            self.conversation_history = []
    ```

    Default system prompt: "You are a helpful course authoring assistant specializing in Coursera short course development."

    Error handling: Catch `anthropic.APIError`, `anthropic.APIConnectionError`, `anthropic.RateLimitError`. Raise with clear messages. Do NOT silently swallow errors.

    If ANTHROPIC_API_KEY is None/empty, raise ValueError on __init__ with message "ANTHROPIC_API_KEY not set. Copy .env.example to .env and add your key."
  </action>
  <verify>
    `py -3 -c "from src.ai.client import AIClient; print('AIClient imported')"` succeeds
  </verify>
  <done>AIClient class with chat, chat_stream, generate, clear_history methods</done>
</task>

<task type="auto">
  <name>Task 2: Create one-shot AI client and tests for both</name>
  <files>
    src/utils/ai_client.py
    tests/test_ai_client.py
  </files>
  <action>
    Create `src/utils/ai_client.py` -- simple stateless wrapper:

    ```python
    def generate(system_prompt: str, user_prompt: str, max_tokens: int = None, temperature: float = 0.3) -> str:
        """One-shot AI generation. Stateless, no history."""
        client = anthropic.Anthropic(api_key=Config.ANTHROPIC_API_KEY)
        response = client.messages.create(
            model=Config.MODEL,
            max_tokens=max_tokens or Config.MAX_TOKENS,
            temperature=temperature,
            system=system_prompt,
            messages=[{"role": "user", "content": user_prompt}]
        )
        return response.content[0].text
    ```

    Create `tests/test_ai_client.py` with MOCKED API tests (use pytest-mock):

    **Conversational client tests:**
    - test_chat_returns_response: mock API, verify response text returned
    - test_chat_accumulates_history: call chat twice, verify conversation_history has 4 entries (2 user + 2 assistant)
    - test_chat_sends_system_prompt: verify system param passed to API
    - test_generate_no_history_pollution: call generate, verify conversation_history unchanged
    - test_clear_history: add messages then clear, verify empty
    - test_missing_api_key_raises: monkeypatch Config.ANTHROPIC_API_KEY=None, verify ValueError on init

    **One-shot client tests:**
    - test_oneshot_generate: mock API, verify response text returned
    - test_oneshot_uses_temperature: verify temperature parameter passed
    - test_oneshot_default_max_tokens: verify Config.MAX_TOKENS used when not specified

    **Mocking pattern:**
    ```python
    @pytest.fixture
    def mock_anthropic(mocker):
        mock_client = mocker.MagicMock()
        mock_response = mocker.MagicMock()
        mock_response.content = [mocker.MagicMock(text="AI response text")]
        mock_client.messages.create.return_value = mock_response
        mocker.patch("anthropic.Anthropic", return_value=mock_client)
        return mock_client
    ```
  </action>
  <verify>
    `py -3 -m pytest tests/test_ai_client.py -v` -- all tests pass
  </verify>
  <done>One-shot client works, all AI client tests pass with mocked API, no real API calls made during tests</done>
</task>

</tasks>

<verification>
1. `py -3 -m pytest tests/test_ai_client.py -v` -- all tests pass
2. `py -3 -c "from src.ai.client import AIClient"` -- imports without error
3. `py -3 -c "from src.utils.ai_client import generate"` -- imports without error
4. No real API calls in tests (all mocked)
</verification>

<success_criteria>
- AIClient.chat() sends messages with history and returns response
- AIClient.generate() works without polluting conversation history
- AIClient.clear_history() resets history
- One-shot generate() is stateless
- Missing API key raises clear error
- All tests pass with mocked Anthropic API
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-infrastructure/01-04-SUMMARY.md`
</output>
