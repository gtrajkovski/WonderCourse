---
phase: 01-foundation-infrastructure
plan: 05
type: execute
wave: 3
depends_on: ["01-01", "01-02", "01-03", "01-04"]
files_modified:
  - app.py
  - templates/base.html
  - templates/dashboard.html
  - static/css/main.css
  - tests/conftest.py
  - tests/test_app.py
autonomous: true

must_haves:
  truths:
    - "Flask app starts on port 5003 without errors"
    - "GET / redirects to /dashboard"
    - "GET /dashboard renders HTML page listing courses"
    - "GET /api/courses returns JSON array of courses"
    - "POST /api/courses creates new course and returns 201"
    - "GET /api/courses/<id> returns course JSON"
    - "PUT /api/courses/<id> updates course and returns 200"
    - "DELETE /api/courses/<id> removes course and returns 200"
    - "GET /api/system/health returns 200 with status ok"
  artifacts:
    - path: "app.py"
      provides: "Flask application with page routes and API endpoints"
      contains: "app = Flask"
      min_lines: 80
    - path: "templates/base.html"
      provides: "Base HTML layout template"
      contains: "<!DOCTYPE html>"
    - path: "templates/dashboard.html"
      provides: "Dashboard page listing courses"
      contains: "{% extends"
    - path: "static/css/main.css"
      provides: "Basic dark theme styles"
      min_lines: 30
    - path: "tests/conftest.py"
      provides: "Shared test fixtures (client, tmp store)"
      contains: "def client"
    - path: "tests/test_app.py"
      provides: "Flask endpoint integration tests"
      contains: "test_create_course"
      min_lines: 60
  key_links:
    - from: "app.py"
      to: "src/core/project_store.py"
      via: "Module-level ProjectStore singleton"
      pattern: "project_store = ProjectStore"
    - from: "app.py"
      to: "src/core/models.py"
      via: "Course import for create/update"
      pattern: "from src.core.models import Course"
    - from: "app.py"
      to: "src/ai/client.py"
      via: "Module-level AIClient singleton"
      pattern: "ai_client = AIClient"
    - from: "templates/dashboard.html"
      to: "templates/base.html"
      via: "Jinja2 template inheritance"
      pattern: "extends.*base"
---

<objective>
Create Flask application skeleton with page routes, CRUD API endpoints, templates, and integration tests.

Purpose: This is the application entry point that ties together models, persistence, and AI client into a running web service. Users interact with the system through this Flask app.
Output: app.py, templates/base.html, templates/dashboard.html, static/css/main.css, tests/conftest.py, tests/test_app.py
</objective>

<execution_context>
@C:\Users\gpt30\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\gpt30\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

Reference from ScreenCast Studio:
@C:\ScreencastHelper\app_v5.py (first 150 lines for structure)

Depends on all prior plans:
@.planning/phases/01-foundation-infrastructure/01-01-SUMMARY.md
@.planning/phases/01-foundation-infrastructure/01-02-SUMMARY.md
@.planning/phases/01-foundation-infrastructure/01-03-SUMMARY.md
@.planning/phases/01-foundation-infrastructure/01-04-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Flask app with routes and API endpoints</name>
  <files>
    app.py
  </files>
  <action>
    Create `app.py` following ScreenCast Studio's app_v5.py structure:

    **Module-level singletons:**
    ```python
    from pathlib import Path
    from flask import Flask, render_template, jsonify, request, redirect, url_for
    from src.config import Config
    from src.core.models import Course
    from src.core.project_store import ProjectStore

    app = Flask(__name__, template_folder='templates', static_folder='static', static_url_path='/static')

    Config.ensure_dirs()
    project_store = ProjectStore(Config.PROJECTS_DIR)
    ```

    Note: Do NOT instantiate AIClient at module level (it raises ValueError if no API key). Import it lazily in routes that need it, or wrap in try/except at module level with a None fallback.

    **Page routes:**
    - `GET /` -> redirect to /dashboard
    - `GET /dashboard` -> render dashboard.html with courses=project_store.list_courses()

    **API endpoints:**
    - `GET /api/courses` -> jsonify list of courses
    - `POST /api/courses` -> create Course from request JSON (title, description, audience_level, target_duration_minutes, modality), save, return 201
    - `GET /api/courses/<id>` -> load course, return JSON or 404
    - `PUT /api/courses/<id>` -> load course, update fields from request JSON, save, return 200 or 404
    - `DELETE /api/courses/<id>` -> delete course, return 200 or 404
    - `GET /api/system/health` -> return {"status": "ok", "version": "1.0.0"}

    **Error handling:**
    - 404 for missing courses: `return jsonify({"error": "Course not found"}), 404`
    - 400 for invalid input: `return jsonify({"error": "..."}), 400`
    - Wrap all API endpoints in try/except for unexpected errors, return 500

    **Main block:**
    ```python
    if __name__ == '__main__':
        import os
        port = int(os.getenv('PORT', 5003))
        app.run(host='127.0.0.1', port=port, debug=True)
    ```
  </action>
  <verify>
    `py -3 -c "from app import app; print(app.url_map)"` shows all registered routes
  </verify>
  <done>Flask app has all page routes and CRUD API endpoints defined</done>
</task>

<task type="auto">
  <name>Task 2: Create templates, static assets, and tests</name>
  <files>
    templates/base.html
    templates/dashboard.html
    static/css/main.css
    tests/conftest.py
    tests/test_app.py
  </files>
  <action>
    **templates/base.html:** Minimal dark-theme base layout:
    - DOCTYPE html, charset utf-8, viewport meta
    - Title block: `{% block title %}Course Builder Studio{% endblock %}`
    - Link to /static/css/main.css
    - Navigation header with "Course Builder Studio" brand and link to /dashboard
    - Content block: `{% block content %}{% endblock %}`
    - Footer with version info

    **templates/dashboard.html:** Extends base.html:
    - H1: "Courses"
    - "New Course" button (links to JavaScript or POST /api/courses)
    - Course list: loop over `courses` variable, display title, description, module count, updated_at
    - Each course card links to a future workspace page (href="#" for now)
    - Empty state: "No courses yet. Create your first course!"

    **static/css/main.css:** Dark theme basics:
    - Body: background #1a1a2e, color #e0e0e0, font-family system-ui
    - Headers: color #fff
    - Links: color #4da6ff
    - Cards: background #16213e, border-radius 8px, padding 1rem
    - Buttons: background #4da6ff, color #fff, border-radius 4px
    - Nav: background #0f3460, padding 1rem
    - Minimal responsive layout (max-width 1200px, margin auto)

    **tests/conftest.py:** Shared fixtures:
    ```python
    import pytest
    from pathlib import Path
    import app as flask_app
    from src.core.project_store import ProjectStore

    @pytest.fixture
    def client(tmp_path):
        flask_app.project_store = ProjectStore(tmp_path)
        flask_app.app.config["TESTING"] = True
        with flask_app.app.test_client() as client:
            yield client
    ```

    **tests/test_app.py:** Integration tests:
    - test_index_redirects_to_dashboard: GET / returns 302 to /dashboard
    - test_dashboard_renders: GET /dashboard returns 200 with HTML
    - test_health_check: GET /api/system/health returns {"status": "ok"}
    - test_list_courses_empty: GET /api/courses returns []
    - test_create_course: POST /api/courses with JSON returns 201 with course data
    - test_create_course_with_title: POST with {"title": "My Course"} returns course with that title
    - test_get_course: create then GET /api/courses/<id> returns course
    - test_get_course_not_found: GET /api/courses/fake returns 404
    - test_update_course: create, PUT with new title, verify updated
    - test_update_course_not_found: PUT /api/courses/fake returns 404
    - test_delete_course: create, DELETE, verify gone
    - test_delete_course_not_found: DELETE /api/courses/fake returns 404
    - test_create_course_returns_id: verify response includes id field
    - test_list_courses_after_create: create 2 courses, list returns 2
  </action>
  <verify>
    `py -3 -m pytest tests/test_app.py -v` -- all tests pass
  </verify>
  <done>Templates render, dark theme CSS works, all endpoint tests pass with temporary ProjectStore</done>
</task>

</tasks>

<verification>
1. `py -3 -m pytest tests/test_app.py -v` -- all tests pass
2. `py -3 -m pytest tests/ -v` -- ALL project tests pass (models + store + AI + app)
3. Start app manually: `py -3 app.py` -- starts on port 5003 without errors
4. Visit http://127.0.0.1:5003/dashboard in browser -- renders dark theme page
5. `curl http://127.0.0.1:5003/api/system/health` -- returns {"status": "ok"}
</verification>

<success_criteria>
- Flask app starts on port 5003
- GET / redirects to /dashboard
- /dashboard renders course list HTML
- Full CRUD API works (create, read, update, delete courses)
- /api/system/health returns ok
- Dark theme base template renders
- All tests pass (models, store, AI client, app endpoints)
- Total test count: 40+
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-infrastructure/01-05-SUMMARY.md`
</output>
