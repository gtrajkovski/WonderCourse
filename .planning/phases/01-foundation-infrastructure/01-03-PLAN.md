---
phase: 01-foundation-infrastructure
plan: 03
type: tdd
wave: 2
depends_on: ["01-02"]
files_modified:
  - src/core/project_store.py
  - tests/test_project_store.py
autonomous: true

must_haves:
  truths:
    - "ProjectStore.save() writes course_data.json to projects/{id}/ directory"
    - "ProjectStore.load() reads course_data.json and returns Course object"
    - "ProjectStore.list_courses() returns metadata for all saved courses"
    - "ProjectStore.delete() removes project directory tree"
    - "Path traversal attempts (../, /, \\) are blocked by _sanitize_id"
    - "Concurrent writes do not corrupt JSON files (file locking)"
    - "save() auto-creates exports/ and textbook/ subdirectories"
  artifacts:
    - path: "src/core/project_store.py"
      provides: "Disk persistence with file locking and path safety"
      contains: "class ProjectStore"
      min_lines: 80
    - path: "tests/test_project_store.py"
      provides: "Save/load/list/delete tests plus security and concurrency tests"
      contains: "test_save_and_load"
      min_lines: 80
  key_links:
    - from: "src/core/project_store.py"
      to: "src/core/models.py"
      via: "Course.to_dict() for save, Course.from_dict() for load"
      pattern: "Course\\.from_dict|course\\.to_dict"
---

<objective>
Implement ProjectStore for disk persistence with platform-specific file locking and path traversal protection.

Purpose: All course data must survive app restarts. File locking prevents corruption from concurrent Flask requests. Path safety prevents directory traversal attacks.
Output: src/core/project_store.py with file locking, tests/test_project_store.py
</objective>

<execution_context>
@C:\Users\gpt30\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\gpt30\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

Reference from ScreenCast Studio:
@C:\ScreencastHelper\src\core\project_store.py

Depends on Plan 01-02 output:
@.planning/phases/01-foundation-infrastructure/01-02-SUMMARY.md
</context>

<feature>
  <name>ProjectStore with File Locking</name>
  <files>src/core/project_store.py, tests/test_project_store.py</files>
  <behavior>
    ProjectStore manages disk persistence for Course objects in `projects/{id}/course_data.json`.

    **Methods:**
    - `__init__(base_dir: Path)` -- creates base directory
    - `save(course: Course) -> Path` -- serialize to JSON with file locking, auto-update updated_at, create subdirs
    - `load(course_id: str) -> Optional[Course]` -- deserialize from JSON with file locking on read
    - `list_courses() -> List[dict]` -- return metadata dicts (id, title, description, module_count, updated_at) sorted by updated_at desc
    - `delete(course_id: str) -> bool` -- remove directory tree via shutil.rmtree
    - `_sanitize_id(course_id: str) -> str` -- strip `/`, `\`, `..`; raise ValueError if empty after sanitization
    - `_course_dir(course_id: str) -> Path` -- base_dir / sanitized_id
    - `_course_file(course_id: str) -> Path` -- course_dir / "course_data.json"

    **File locking implementation:**
    ```python
    import sys

    def _write_json(self, path: Path, data: dict):
        if sys.platform == "win32":
            import msvcrt
            with open(path, "w", encoding="utf-8") as f:
                msvcrt.locking(f.fileno(), msvcrt.LK_LOCK, 1)
                try:
                    json.dump(data, f, indent=2, ensure_ascii=False)
                finally:
                    msvcrt.locking(f.fileno(), msvcrt.LK_UNLCK, 1)
        else:
            import fcntl
            with open(path, "w", encoding="utf-8") as f:
                fcntl.flock(f.fileno(), fcntl.LOCK_EX)
                try:
                    json.dump(data, f, indent=2, ensure_ascii=False)
                finally:
                    fcntl.flock(f.fileno(), fcntl.LOCK_UN)

    def _read_json(self, path: Path) -> dict:
        if sys.platform == "win32":
            import msvcrt
            with open(path, "r", encoding="utf-8") as f:
                msvcrt.locking(f.fileno(), msvcrt.LK_LOCK, 1)
                try:
                    return json.load(f)
                finally:
                    msvcrt.locking(f.fileno(), msvcrt.LK_UNLCK, 1)
        else:
            import fcntl
            with open(path, "r", encoding="utf-8") as f:
                fcntl.flock(f.fileno(), fcntl.LOCK_SH)
                try:
                    return json.load(f)
                finally:
                    fcntl.flock(f.fileno(), fcntl.LOCK_UN)
    ```

    **Subdirectories created on save:** `exports/`, `textbook/` (parallel to ScreenCast Studio's audio/, video/, data/)

    **Test cases (RED phase):**
    - test_save_and_load: create Course, save, load, verify fields match
    - test_save_creates_subdirectories: exports/ and textbook/ exist after save
    - test_save_updates_timestamp: updated_at changes on save
    - test_load_nonexistent_returns_none: load("fake_id") returns None
    - test_list_courses_empty: empty store returns []
    - test_list_courses_multiple: save 3 courses, list returns 3 items with correct metadata
    - test_list_courses_sorted_by_updated: most recent first
    - test_delete_existing: save then delete, directory gone
    - test_delete_nonexistent_returns_false: delete("fake") returns False
    - test_sanitize_id_strips_path_traversal: "../hack" -> "hack"
    - test_sanitize_id_strips_slashes: "a/b\\c" -> "abc"
    - test_sanitize_id_empty_raises: "" raises ValueError after sanitization
    - test_sanitize_id_dots_only_raises: ".." raises ValueError
    - test_concurrent_writes_no_corruption: two threads write simultaneously, final JSON is valid
    - test_course_file_path: verify correct path structure projects/{id}/course_data.json
  </behavior>
  <implementation>
    Copy ScreenCast Studio's ProjectStore pattern (C:\ScreencastHelper\src\core\project_store.py) and add:
    1. File locking via _write_json/_read_json helper methods
    2. Platform detection (sys.platform == "win32" for msvcrt vs fcntl)
    3. Subdirectories: exports/, textbook/ instead of audio/, video/, data/
    4. list_courses returns module_count instead of segment_count
    5. File name: course_data.json instead of project.json
  </implementation>
</feature>

<verification>
1. `py -3 -m pytest tests/test_project_store.py -v` -- all tests pass
2. `py -3 -c "from src.core.project_store import ProjectStore; from src.core.models import Course; from pathlib import Path; s = ProjectStore(Path('test_tmp')); c = Course(title='Test'); s.save(c); print(s.load(c.id).title)"` prints "Test"
3. Verify path traversal: `_sanitize_id('../etc/passwd')` raises or strips dangerous chars
</verification>

<success_criteria>
- save/load round-trip preserves all Course data including nested modules/lessons/activities
- list_courses returns sorted metadata for all saved courses
- delete removes directory tree completely
- _sanitize_id blocks path traversal (/, \, ..)
- File locking used on both read and write operations
- Concurrent write test does not produce corrupted JSON
- All tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-infrastructure/01-03-SUMMARY.md`
</output>
