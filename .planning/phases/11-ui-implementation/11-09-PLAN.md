---
phase: 11-ui-implementation
plan: 09
type: execute
wave: 5
depends_on: ["11-03", "11-04", "11-05", "11-06", "11-07", "11-08"]
files_modified:
  - templates/partials/collab-modal.html
  - templates/partials/comments-panel.html
  - templates/partials/activity-feed.html
  - static/css/components/collaboration.css
  - static/js/components/collaboration.js
  - templates/base.html
autonomous: true

must_haves:
  truths:
    - "User can open invite modal from any course page"
    - "User can invite collaborators by email"
    - "User can view and add comments on content"
    - "User can view activity feed showing recent changes"
    - "Comments support threading and mentions"
  artifacts:
    - path: "templates/partials/collab-modal.html"
      provides: "Collaboration invite modal"
      contains: "invite-form"
    - path: "templates/partials/comments-panel.html"
      provides: "Comments panel component"
      contains: "comment-list"
    - path: "static/js/components/collaboration.js"
      provides: "Collaboration UI controller"
      contains: "CollaborationController"
  key_links:
    - from: "static/js/components/collaboration.js"
      to: "/api/courses/{id}/invitations"
      via: "fetch API"
      pattern: "api.*invitations"
    - from: "static/js/components/collaboration.js"
      to: "/api/courses/{id}/comments"
      via: "fetch API"
      pattern: "api.*comments"
---

<objective>
Create the collaboration UI components: invite modal, comments panel, and activity feed sidebar.

Purpose: Collaboration features need UI for inviting team members, commenting on content, and viewing recent activity. These components integrate into existing pages.

Output: Reusable collaboration partials (invite modal, comments panel, activity feed) and JavaScript controller for collaboration actions.
</objective>

<execution_context>
@C:\Users\gpt30\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\gpt30\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/11-ui-implementation/11-CONTEXT.md
@.planning/phases/11-ui-implementation/11-03-SUMMARY.md
@src/api/collab.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Invite Modal Component</name>
  <files>
    templates/partials/collab-modal.html
    static/css/components/collaboration.css
    static/js/components/collaboration.js
  </files>
  <action>
Create invite modal partial:

**templates/partials/collab-modal.html:**
Modal structure:
- Header: "Invite Collaborator"
- Form:
  - Email input (required)
  - Role dropdown: Designer, Reviewer, SME (not Owner)
  - Optional message textarea
  - Expiry: dropdown (7 days, 30 days, Never)
- Or: Generate shareable link section
  - "Create Shareable Link" button
  - Link display with copy button
  - Link role selection
- Current collaborators list:
  - Shows existing collaborators with roles
  - Edit role button (for owner only)
  - Remove button (for owner only)
- Pending invitations list:
  - Shows pending invites
  - Revoke button
- Footer: Send Invite and Cancel buttons

**static/css/components/collaboration.css:**
- .collab-modal: modal specific styles
- .invite-form: form layout
- .role-select: dropdown styling
- .shareable-link: link display with copy button
- .collaborator-list: existing collaborators
- .collaborator-item: row with avatar, name, role
- .pending-list: pending invitations
- .pending-item: invitation row

**static/js/components/collaboration.js:**

CollaborationController class:

**Invite Modal:**
- inviteModal: Modal instance
- showInviteModal():
  - Load current collaborators
  - Load pending invitations
  - Open modal

- handleSendInvite():
  - Get email, role, message, expiry
  - POST /api/courses/{id}/invitations
  - Toast on success
  - Add to pending list

- handleCreateShareableLink():
  - POST /api/courses/{id}/invitations with email=null
  - Display link
  - Enable copy button

- handleCopyLink():
  - Copy to clipboard
  - Toast "Link copied"

- handleRevokeInvite(inviteId):
  - DELETE /api/courses/{id}/invitations/{iid}
  - Remove from list

- handleUpdateRole(collabId, newRole):
  - PUT /api/courses/{id}/collaborators/{cid}
  - Update display

- handleRemoveCollab(collabId):
  - Confirmation modal
  - DELETE /api/courses/{id}/collaborators/{cid}
  - Remove from list
  </action>
  <verify>
On any course page:
- Click invite button -> modal opens
- Enter email, select role, send -> success toast
- Create shareable link -> link displays
- Copy link -> clipboard contains link
- Revoke pending invitation -> removed from list
  </verify>
  <done>
Invite modal works with email invites, shareable links, and collaborator management.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Comments Panel Component</name>
  <files>
    templates/partials/comments-panel.html
    static/css/components/collaboration.css
    static/js/components/collaboration.js
  </files>
  <action>
Create comments panel partial:

**templates/partials/comments-panel.html:**
Collapsible side panel:
- Header: "Comments" + badge with count + collapse toggle
- Filter: All / Unresolved / My mentions
- Comment list:
  - Each comment shows:
    - Author avatar + name
    - Timestamp
    - Comment text (with @mentions highlighted)
    - Reply button
    - Resolve button (if author or owner)
    - Edit/Delete (if author)
  - Threaded replies indented
- Add comment form at bottom:
  - Textarea with @mention autocomplete
  - Submit button

**Add to static/css/components/collaboration.css:**
- .comments-panel: side panel styling
- .comments-header: header with count badge
- .comments-filter: filter buttons
- .comment-list: scrollable list
- .comment-item: individual comment
- .comment-author: avatar and name
- .comment-text: text with mentions
- .mention: @username styling
- .comment-replies: indented replies
- .comment-actions: reply, resolve buttons
- .add-comment: form at bottom
- .collapsed: panel collapsed state

**Add to static/js/components/collaboration.js:**

**Comments Panel:**
- commentsPanel: element reference
- comments: array of comments
- currentFilter: 'all' | 'unresolved' | 'mentions'
- activityId: currently viewing activity

- loadComments(activityId):
  - GET /api/courses/{id}/activities/{aid}/comments
  - Store in comments
  - Render list

- renderComments(comments, filter):
  - Filter based on currentFilter
  - Build HTML for each comment
  - Include replies (threaded)

- handleAddComment():
  - Get text from textarea
  - Parse @mentions
  - POST /api/courses/{id}/activities/{aid}/comments
  - Clear textarea
  - Prepend to list

- handleReply(commentId):
  - Show reply form under comment
  - POST with parent_id

- handleResolve(commentId):
  - POST /api/courses/{id}/comments/{cid}/resolve
  - Update UI (grey out or remove from unresolved filter)

- handleMentionAutocomplete(query):
  - GET collaborators for course
  - Filter by name matching query
  - Show dropdown

- parseMentions(text):
  - Find @username patterns
  - Extract user IDs

- toggleCommentsPanel():
  - Add/remove .collapsed class
  - Save state to localStorage
  </action>
  <verify>
On studio page with activity selected:
- Comments panel shows on side
- Existing comments display with author and time
- Add comment -> appears in list
- Reply -> creates threaded response
- Resolve -> comment marked as resolved
- @mention shows autocomplete
  </verify>
  <done>
Comments panel works with threading, @mentions, and resolution. Filtering works.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create Activity Feed Component</name>
  <files>
    templates/partials/activity-feed.html
    static/css/components/collaboration.css
    static/js/components/collaboration.js
    templates/base.html
  </files>
  <action>
Create activity feed partial:

**templates/partials/activity-feed.html:**
Dropdown or slide-out panel from header:
- Header: "Recent Activity" + close button
- Filter: All / Today / This Week
- Activity list:
  - Each entry shows:
    - User avatar
    - Action description (e.g., "Generated video script for Lesson 2")
    - Timestamp (relative: "2 hours ago")
    - Link to affected item
- "Load More" button at bottom
- Empty state if no activity

**Add to static/css/components/collaboration.css:**
- .activity-feed: dropdown/panel styling
- .activity-feed-header: header with close
- .activity-filter: filter buttons
- .activity-list: scrollable list
- .activity-item: individual entry
- .activity-user: avatar
- .activity-action: description text
- .activity-time: timestamp
- .activity-link: link styling

**Add to static/js/components/collaboration.js:**

**Activity Feed:**
- activityFeed: element reference
- activities: array of activity entries
- currentPage: pagination

- toggleActivityFeed():
  - Show/hide feed panel
  - Load if not loaded

- loadActivityFeed(page=1):
  - GET /api/courses/{id}/activity?limit=20&offset={offset}
  - Append to activities
  - Render list
  - Show/hide load more based on has_more

- renderActivityFeed():
  - Build HTML for each activity
  - Format action description
  - Format relative timestamp

- formatRelativeTime(timestamp):
  - Convert to "X minutes ago", "Y hours ago", etc.

- handleLoadMore():
  - Increment currentPage
  - Call loadActivityFeed

**Update templates/base.html:**
- Include collab-modal.html partial
- Include activity-feed.html partial
- Add activity feed trigger to header (bell icon or button)
- Add invite trigger to header (when course context exists)
- Include collaboration.js script
- Initialize CollaborationController on pages with course context
  </action>
  <verify>
On any course page:
- Click activity icon in header -> feed dropdown opens
- Shows recent changes with user and timestamp
- Click entry -> navigates to affected item
- Load more -> fetches additional entries
- Close button hides feed
  </verify>
  <done>
Activity feed works with pagination. Integrates into header. Shows recent course changes.
  </done>
</task>

</tasks>

<verification>
- Invite modal opens and functions correctly
- Can send email invitations
- Can create shareable links
- Comments panel shows on content pages
- Can add comments with @mentions
- Threading works for replies
- Activity feed shows recent changes
- Load more pagination works
- All components styled consistently
- No JavaScript console errors
</verification>

<success_criteria>
1. Invite modal accessible from course pages
2. Email invitations send successfully
3. Shareable links can be created and copied
4. Comments panel shows for content items
5. @mentions autocomplete works
6. Threading and resolution work
7. Activity feed shows recent changes
8. Pagination works for activity feed
9. Components integrate into existing pages
</success_criteria>

<output>
After completion, create `.planning/phases/11-ui-implementation/11-09-SUMMARY.md`
</output>
