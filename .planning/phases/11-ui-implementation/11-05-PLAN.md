---
phase: 11-ui-implementation
plan: 05
type: execute
wave: 3
depends_on: ["11-03"]
files_modified:
  - templates/builder.html
  - static/css/pages/builder.css
  - static/js/pages/builder.js
  - static/js/components/tree.js
  - app.py
autonomous: true

must_haves:
  truths:
    - "User can view hierarchical tree at /courses/{id}/builder"
    - "User can expand/collapse tree nodes"
    - "User can drag and drop to reorder items"
    - "User can add modules, lessons, and activities"
    - "User can select an item to view details in side panel"
  artifacts:
    - path: "templates/builder.html"
      provides: "Course structure tree editor"
      contains: "tree-container"
    - path: "static/js/components/tree.js"
      provides: "Hierarchical tree with drag-drop"
      contains: "HierarchicalTree"
    - path: "static/js/pages/builder.js"
      provides: "Builder page controller"
      contains: "BuilderController"
  key_links:
    - from: "static/js/pages/builder.js"
      to: "/api/courses/{id}/modules"
      via: "fetch API"
      pattern: "api.*modules"
    - from: "static/js/components/tree.js"
      to: "static/js/pages/builder.js"
      via: "import or global"
      pattern: "HierarchicalTree"
---

<objective>
Create the Builder page with a hierarchical tree editor for modules, lessons, and activities with drag-drop reordering.

Purpose: The Builder is where users organize their course structure. It needs intuitive tree navigation with drag-drop for reordering and a detail panel for viewing/editing selected items.

Output: Builder template with two-column layout (tree + detail panel), hierarchical tree component with drag-drop, CRUD for all structure levels.
</objective>

<execution_context>
@C:\Users\gpt30\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\gpt30\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/11-ui-implementation/11-CONTEXT.md
@.planning/phases/11-ui-implementation/11-RESEARCH.md
@.planning/phases/11-ui-implementation/11-03-SUMMARY.md
@src/api/modules.py
@src/api/lessons.py
@src/api/activities.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Hierarchical Tree Component</name>
  <files>
    static/js/components/tree.js
  </files>
  <action>
Create reusable tree component following research patterns:

**static/js/components/tree.js:**

HierarchicalTree class:

Constructor(containerId, options):
- options: onSelect, onReorder, onAdd, onDelete callbacks
- Initialize drag state variables
- Load expand state from localStorage

Core tree structure:
- Nested ul/li elements with data attributes
- data-node-id, data-node-type (module/lesson/activity), data-parent-id
- Expand/collapse toggles on nodes with children

Methods:

**Expand/Collapse:**
- toggleNode(nodeId): add/remove 'expanded' class
- saveExpandState(): save expanded node IDs to localStorage
- restoreExpandState(): apply saved expand state on init

**Selection:**
- selectNode(nodeId): add 'selected' class, call onSelect callback
- clearSelection(): remove 'selected' from all nodes

**Drag and Drop:**
- initDragHandlers(): attach dragstart, dragover, drop, dragend to all items
- onDragStart(e): set draggedItem, add 'dragging' class, set dataTransfer
- onDragOver(e): preventDefault, calculate drop position, show indicator
- onDrop(e): validate drop, call onReorder callback with old/new positions
- onDragEnd(e): clean up dragging class, hide indicators
- getDragAfterElement(container, y): find element to insert before
- isValidDrop(dragged, target): prevent dropping parent into child
- showDropIndicator(target, position): visual feedback for drop location

**Tree Rendering:**
- render(data): build HTML from course data structure
- renderModule(module): li with lessons nested
- renderLesson(lesson): li with activities nested
- renderActivity(activity): li leaf node

**Helper:**
- createDragImage(element): custom drag ghost (shallow clone)
  </action>
  <verify>
In browser console with test HTML:
- Create tree instance: `new HierarchicalTree('test-tree', {...})`
- Click toggle expands/collapses nodes
- Drag item shows visual feedback
- Drop reorders and calls callback
  </verify>
  <done>
Hierarchical tree component created with expand/collapse, drag-drop reordering, and selection support. State persisted to localStorage.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Builder Page Template and Styles</name>
  <files>
    templates/builder.html
    static/css/pages/builder.css
    app.py
  </files>
  <action>
Create Builder page layout:

**templates/builder.html:**
Extend base.html with course context.

Two-column layout:
- Left (60%): Tree panel
- Right (40%): Detail panel

**Tree Panel:**
- Header: "Course Structure" + Add Module button
- Tree container div with id="course-tree"
- Empty state if no modules

**Detail Panel:**
- Header: "Details" (changes based on selection)
- Empty state: "Select an item to view details"
- Module view:
  - Title (inline editable via double-click)
  - Description textarea
  - Add Lesson button
  - Delete Module button
- Lesson view:
  - Title (inline editable)
  - Duration display
  - Add Activity button
  - Delete Lesson button
- Activity view:
  - Title (inline editable)
  - Content Type display
  - Activity Type dropdown
  - WWHAA Phase dropdown
  - Build State badge (color-coded)
  - "Generate Content" button (links to Studio)
  - Delete Activity button

**Add Item Modals:**
- Add Module modal: title field
- Add Lesson modal: title field, parent module shown
- Add Activity modal: title, content_type dropdown, activity_type dropdown

**static/css/pages/builder.css:**
- .builder-container: flex row
- .tree-panel: left column with overflow scroll
- .detail-panel: right column
- .tree-item: item styling with icons
- .tree-item.expanded > .tree-children: visible
- .tree-item.collapsed > .tree-children: hidden
- .tree-item.selected: highlight background
- .tree-item.dragging: opacity reduced
- .drop-indicator: line showing drop position
- .detail-section: sections in detail panel
- .inline-editable: styling for editable text

**app.py:**
Add route:
```python
@app.route('/courses/<course_id>/builder')
@login_required
def builder(course_id):
    course = project_store.load(course_id)
    if not course:
        return redirect(url_for('dashboard'))
    return render_template('builder.html',
                         course=course,
                         active_page='builder',
                         breadcrumb=[
                           {'title': 'Dashboard', 'url': '/dashboard'},
                           {'title': course.title, 'url': f'/courses/{course_id}/planner'},
                           {'title': 'Builder', 'url': f'/courses/{course_id}/builder'}
                         ])
```
  </action>
  <verify>
Visit /courses/{id}/builder:
- Two-column layout displays
- Tree shows course structure (modules -> lessons -> activities)
- Detail panel shows "Select an item"
- Add Module button visible
- Sidebar shows Builder as active
  </verify>
  <done>
Builder template created with two-column layout. Route added. Page loads with course structure.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add Builder Page JavaScript Controller</name>
  <files>
    static/js/pages/builder.js
    templates/builder.html
  </files>
  <action>
Create controller to wire tree and CRUD operations:

**static/js/pages/builder.js:**

BuilderController class with courseId:

**Initialization:**
- tree: HierarchicalTree instance
- detailPanel: element reference
- modals: add module, add lesson, add activity
- selectedItem: {type, id, data}

- init():
  - Fetch course structure from API
  - Create HierarchicalTree with callbacks
  - Bind modal events
  - Initialize inline edit handlers

**Tree Callbacks:**
- handleSelect(nodeId, nodeType):
  - Fetch item details from appropriate API
  - Store in selectedItem
  - Render detail panel

- handleReorder(itemId, itemType, newIndex, parentId):
  - Determine which reorder endpoint to call
  - PUT to /api/courses/{id}/modules/reorder (for modules)
  - PUT to /api/courses/{id}/modules/{mid}/lessons/reorder (for lessons)
  - PUT to /api/courses/{id}/lessons/{lid}/activities/reorder (for activities)
  - Refresh tree on success

**CRUD Operations:**
- showAddModuleModal()
- handleAddModule(): POST, refresh tree
- showAddLessonModal(moduleId)
- handleAddLesson(moduleId): POST, refresh tree
- showAddActivityModal(lessonId)
- handleAddActivity(lessonId): POST, refresh tree
- handleDeleteItem(): based on selectedItem type, call DELETE, refresh tree

**Detail Panel:**
- renderDetailPanel(item, type):
  - Clear panel
  - Render appropriate view based on type
  - Bind inline edit handlers
  - Bind action buttons

- handleInlineEdit(field, value):
  - PUT to appropriate endpoint
  - Toast feedback

- navigateToStudio():
  - Navigate to /courses/{id}/studio?activity={selectedItem.id}

**Update templates/builder.html:**
- Include tree.js and builder.js
- Modal markup for add operations
- Initialize BuilderController on DOMContentLoaded
  </action>
  <verify>
On builder page:
- Click module -> detail panel shows module info
- Double-click title -> inline edit, blur saves
- Drag module to reorder -> order persists (refresh confirms)
- Add Module -> modal, fill, save -> appears in tree
- Add Lesson under module -> appears nested
- Add Activity under lesson -> appears nested
- Delete works with confirmation
- Tree expand/collapse state persists across refresh
  </verify>
  <done>
Builder controller wired with tree component. All CRUD operations work. Drag-drop reordering persists. Detail panel shows selected item.
  </done>
</task>

</tasks>

<verification>
- Builder page loads at /courses/{id}/builder
- Tree displays course hierarchy correctly
- Expand/collapse works and persists
- Selection updates detail panel
- Drag-drop reordering works within levels
- Add module/lesson/activity all work
- Delete operations work with confirmation
- Inline editing saves changes
- Navigation to Studio works
- No JavaScript console errors
</verification>

<success_criteria>
1. Hierarchical tree displays modules > lessons > activities
2. Expand/collapse state persists in localStorage
3. Drag-drop reordering works within same level
4. Selection shows details in right panel
5. Inline editing updates item title on blur
6. Add operations use modal dialogs
7. Delete requires confirmation
8. "Generate Content" links to Studio page
9. All operations show toast feedback
</success_criteria>

<output>
After completion, create `.planning/phases/11-ui-implementation/11-05-SUMMARY.md`
</output>
