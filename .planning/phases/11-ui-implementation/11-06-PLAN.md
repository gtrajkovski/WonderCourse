---
phase: 11-ui-implementation
plan: 06
type: execute
wave: 4
depends_on: ["11-04", "11-05"]
files_modified:
  - templates/studio.html
  - static/css/pages/studio.css
  - static/js/pages/studio.js
  - src/api/content.py
  - app.py
autonomous: true

must_haves:
  truths:
    - "User can view content generation interface at /courses/{id}/studio"
    - "User can select an activity and generate content"
    - "Generated content streams in real-time"
    - "User can edit generated content inline"
    - "User can regenerate with feedback"
  artifacts:
    - path: "templates/studio.html"
      provides: "Content generation interface"
      contains: "preview-pane"
    - path: "static/js/pages/studio.js"
      provides: "Studio page controller with streaming"
      contains: "EventSource"
  key_links:
    - from: "static/js/pages/studio.js"
      to: "/api/courses/{id}/activities/{aid}/generate"
      via: "fetch or SSE"
      pattern: "generate"
    - from: "templates/studio.html"
      to: "static/js/pages/studio.js"
      via: "script include"
      pattern: "studio\\.js"
---

<objective>
Create the Studio page for content generation with real-time streaming preview and inline editing capabilities.

Purpose: The Studio is where users generate and refine content for each activity. It needs to show streaming output as content is generated and allow quick edits without leaving the page.

Output: Studio template with activity selector, content preview with streaming, inline editing, and regeneration workflow.
</objective>

<execution_context>
@C:\Users\gpt30\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\gpt30\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/11-ui-implementation/11-CONTEXT.md
@.planning/phases/11-ui-implementation/11-RESEARCH.md
@.planning/phases/11-ui-implementation/11-05-SUMMARY.md
@src/api/content.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Studio Page Template</name>
  <files>
    templates/studio.html
    static/css/pages/studio.css
    app.py
  </files>
  <action>
Create Studio page layout:

**templates/studio.html:**
Extend base.html with course context.

Three-panel layout:
- Left sidebar (narrow): Activity list/tree
- Center: Content preview pane
- Right (collapsible): Generation controls

**Left Panel - Activity Selector:**
- Compact tree/list of activities grouped by lesson
- Shows build state indicator (draft, generating, generated, approved)
- Click selects activity
- Selected activity highlighted

**Center Panel - Content Preview:**
- Header: Activity title + content type badge
- Main area:
  - If DRAFT: "No content yet. Click Generate to create."
  - If GENERATING: Streaming text appearing in real-time
  - If GENERATED: Full content displayed
- Footer: Word count, estimated duration, Bloom's level

**Right Panel - Controls:**
- Generate button (if DRAFT or GENERATED)
- Regenerate with feedback textarea (if GENERATED)
- Bulk generate checkbox list (select multiple activities)
- Bulk "Generate All Selected" button
- State transition buttons: Mark Reviewed, Approve, etc.

**Content Display:**
Content type-specific rendering:
- VIDEO_SCRIPT: Show WWHAA sections with headers
- READING: Show formatted sections with references
- QUIZ: Show questions with options (correct hidden or marked)
- RUBRIC: Show criteria table
- (Simplified views for other types)

**static/css/pages/studio.css:**
- .studio-container: three-panel flex layout
- .activity-list: narrow left panel
- .activity-item: compact item styling
- .activity-item.selected: highlight
- .preview-pane: center content area
- .preview-header, .preview-body, .preview-footer
- .controls-panel: right panel
- .streaming-text: monospace, cursor animation
- Content type specific: .video-section, .reading-section, .quiz-question

**app.py:**
Add route:
```python
@app.route('/courses/<course_id>/studio')
@login_required
def studio(course_id):
    course = project_store.load(course_id)
    if not course:
        return redirect(url_for('dashboard'))
    # Get activity_id from query param if provided
    selected_activity_id = request.args.get('activity')
    return render_template('studio.html',
                         course=course,
                         selected_activity_id=selected_activity_id,
                         active_page='studio',
                         breadcrumb=[...])
```
  </action>
  <verify>
Visit /courses/{id}/studio:
- Three-panel layout displays
- Activity list shows all activities with states
- Empty preview shows guidance message
- Controls panel visible with Generate button disabled (no selection)
  </verify>
  <done>
Studio template created with three-panel layout. Route added. Page loads with activity list.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add Streaming Content Generation</name>
  <files>
    static/js/pages/studio.js
    src/api/content.py
  </files>
  <action>
Implement streaming generation with SSE:

**First, add SSE endpoint to src/api/content.py:**

```python
from flask import Response, stream_with_context
import json

@content_bp.route('/api/courses/<course_id>/activities/<activity_id>/generate/stream')
@login_required
def generate_content_stream(course_id, activity_id):
    """Stream content generation via Server-Sent Events."""
    # Validate course and activity exist
    course = _project_store.load(course_id)
    if not course:
        return jsonify({"error": "Course not found"}), 404

    activity = _find_activity(course, activity_id)
    if not activity:
        return jsonify({"error": "Activity not found"}), 404

    def generate():
        try:
            # Get appropriate generator
            generator = _get_generator(activity.content_type, activity.activity_type)

            # Stream chunks (using generator's streaming capability if available)
            # For now, generate full content and simulate streaming
            content = generator.generate(activity, course)

            # Send content in chunks
            text = json.dumps(content) if isinstance(content, dict) else str(content)
            chunk_size = 50  # characters per chunk
            for i in range(0, len(text), chunk_size):
                chunk = text[i:i+chunk_size]
                yield f"data: {json.dumps({'type': 'chunk', 'content': chunk})}\n\n"

            yield f"data: {json.dumps({'type': 'complete', 'content': content})}\n\n"
        except Exception as e:
            yield f"data: {json.dumps({'type': 'error', 'message': str(e)})}\n\n"

    return Response(stream_with_context(generate()),
                   mimetype='text/event-stream',
                   headers={'Cache-Control': 'no-cache'})
```

**static/js/pages/studio.js:**

StudioController class:

**Initialization:**
- activityList: element references
- previewPane: element reference
- controlsPanel: element reference
- selectedActivityId: current selection
- currentEventSource: SSE connection (for cleanup)

**Activity Selection:**
- handleActivitySelect(activityId):
  - Update selectedActivityId
  - Highlight in list
  - Fetch activity details from /api/courses/{id}/activities/{aid}
  - Render preview (existing content or empty state)
  - Enable/disable Generate button based on state

**Content Generation with Streaming:**
- handleGenerate():
  - Close any existing EventSource
  - Clear preview, show "Generating..." indicator
  - Create EventSource to /api/.../generate/stream
  - eventSource.onmessage: handle chunk/complete/error
  - On chunk: append to preview
  - On complete: save full content, update state, enable controls
  - On error: show error, re-enable generate button

- closeEventSource():
  - If currentEventSource exists, close it
  - Set to null

- window.addEventListener('beforeunload', closeEventSource)

**Preview Rendering:**
- renderPreview(activity, content):
  - Based on content_type, render appropriate view
  - VIDEO_SCRIPT: sections with headers
  - READING: formatted text with references
  - QUIZ: questions and options
  - Show metadata footer

**Regeneration:**
- handleRegenerate():
  - Get feedback from textarea
  - POST to /api/.../regenerate with feedback
  - Same streaming flow
  </action>
  <verify>
On studio page:
- Select activity -> preview shows content or empty state
- Click Generate -> loading indicator, then text streams in
- Content appears progressively (not all at once)
- On complete, controls re-enable
- Navigation away closes SSE connection (check Network tab)
  </verify>
  <done>
Streaming generation works via SSE. Content appears progressively. Connection cleaned up on navigation.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add Inline Editing and Regeneration</name>
  <files>
    static/js/pages/studio.js
    templates/studio.html
  </files>
  <action>
Add editing capabilities:

**Add to static/js/pages/studio.js:**

**Inline Editing:**
- enableInlineEdit():
  - Add contenteditable to preview sections
  - Bind blur handlers to save
  - Add "Edit" button that toggles edit mode

- handleContentEdit(section, newValue):
  - Build updated content object
  - PUT to /api/courses/{id}/activities/{aid}/content
  - Toast on save
  - Update word count

- toggleEditMode():
  - Add/remove 'editing' class to preview
  - Change button text Edit/Done
  - When done, save all changes

**Full Editor Modal:**
- showFullEditor():
  - Open modal with textarea for full content
  - Larger editing area for major changes
  - Save and Cancel buttons

**Regeneration with Feedback:**
- handleRegenerateWithFeedback():
  - Get feedback text from textarea
  - Validate not empty
  - POST to /api/.../regenerate with {feedback}
  - Stream new content (same as generate)
  - Show diff option (optional enhancement)

**State Transitions:**
- handleMarkReviewed(): PUT state to REVIEWED
- handleApprove(): PUT state to APPROVED
- handlePublish(): PUT state to PUBLISHED

**Bulk Generation (simplified):**
- selectedForBulk: Set of activity IDs
- toggleBulkSelect(activityId): add/remove from set
- handleBulkGenerate():
  - For each selected activity, call generate endpoint sequentially
  - Update progress indicator
  - Show completion summary

**Update templates/studio.html:**
- Add edit mode toggle button
- Add feedback textarea for regeneration
- Add state transition buttons
- Add bulk selection checkboxes
- Full editor modal markup
  </action>
  <verify>
On studio page:
- Click Edit -> preview becomes editable, blur saves changes
- Word count updates after edit
- Click Regenerate with feedback -> new content generates
- State buttons work (Mark Reviewed, Approve)
- Full editor modal opens for major edits
  </verify>
  <done>
Inline editing works with auto-save. Regeneration with feedback works. State transitions update activity state.
  </done>
</task>

</tasks>

<verification>
- Studio page loads at /courses/{id}/studio
- Activity list shows all activities with state badges
- Selecting activity shows preview or empty state
- Generate streams content in real-time
- Inline editing saves on blur
- Regenerate with feedback produces new content
- State transition buttons update state
- SSE connection closes on navigation
- No JavaScript console errors
</verification>

<success_criteria>
1. Three-panel layout with activity list, preview, controls
2. Activity selection loads content or empty state
3. Generate shows streaming content progressively
4. Content type-specific preview rendering
5. Inline editing saves changes automatically
6. Regeneration with feedback works
7. State transitions (review, approve) work
8. Metadata footer shows word count and duration
9. SSE connection properly managed (cleanup)
</success_criteria>

<output>
After completion, create `.planning/phases/11-ui-implementation/11-06-SUMMARY.md`
</output>
