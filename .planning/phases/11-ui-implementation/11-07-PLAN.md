---
phase: 11-ui-implementation
plan: 07
type: execute
wave: 4
depends_on: ["11-03"]
files_modified:
  - templates/textbook.html
  - static/css/pages/textbook.css
  - static/js/pages/textbook.js
  - app.py
autonomous: true

must_haves:
  truths:
    - "User can view textbook page at /courses/{id}/textbook"
    - "User can see list of chapters (one per learning outcome)"
    - "User can generate individual chapters"
    - "User can view chapter preview with sections"
    - "User can edit glossary terms"
  artifacts:
    - path: "templates/textbook.html"
      provides: "Textbook management interface"
      contains: "chapter-list"
    - path: "static/js/pages/textbook.js"
      provides: "Textbook page controller"
      contains: "generateChapter"
  key_links:
    - from: "static/js/pages/textbook.js"
      to: "/api/courses/{id}/textbook"
      via: "fetch API"
      pattern: "api.*textbook"
---

<objective>
Create the Textbook page for chapter generation, glossary management, and textbook preview.

Purpose: The Textbook page allows users to generate comprehensive textbook chapters for each learning outcome, manage the glossary, and preview the complete textbook.

Output: Textbook template with chapter list, generation controls, preview panel, and glossary editor.
</objective>

<execution_context>
@C:\Users\gpt30\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\gpt30\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/11-ui-implementation/11-CONTEXT.md
@.planning/phases/11-ui-implementation/11-03-SUMMARY.md
@src/api/textbook.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Textbook Page Template</name>
  <files>
    templates/textbook.html
    static/css/pages/textbook.css
    app.py
  </files>
  <action>
Create Textbook page layout:

**templates/textbook.html:**
Extend base.html with course context.

Two-panel layout with tabs:

**Left Panel - Chapter List & Controls:**
Tab 1: Chapters
- List of chapters (one per learning outcome)
- Each chapter shows:
  - Chapter number
  - Title (from learning outcome)
  - Status: Not Generated / Generating / Generated
  - Word count (if generated)
  - Generate button (per chapter)
- "Generate All Chapters" button at bottom
- Progress indicator for bulk generation

Tab 2: Glossary
- List of glossary terms (from all chapters)
- Each term: term text, definition, chapter source
- Add term button
- Edit/Delete buttons per term
- Terms sortable alphabetically

Tab 3: Settings
- Textbook title input
- Author/course info
- Export format preferences

**Right Panel - Preview:**
Header: "Preview" + currently selected chapter or "Full Textbook"
- If chapter selected: show chapter content
  - Title, introduction, sections, conclusion
  - Image placeholders with captions
  - Glossary terms highlighted
  - References at bottom
- If full textbook: show table of contents + all chapters
- Empty state if nothing generated yet

**static/css/pages/textbook.css:**
- .textbook-container: two-panel layout
- .chapter-list: left panel
- .chapter-item: chapter row styling
- .chapter-item.generating: loading state
- .chapter-item.generated: success state
- .glossary-list: term list styling
- .glossary-term: term row
- .preview-panel: right panel
- .chapter-preview: formatted chapter display
- .section-heading, .section-content
- .image-placeholder: styled placeholder
- .glossary-highlight: term highlighting
- .reference-list: references styling

**app.py:**
Add route:
```python
@app.route('/courses/<course_id>/textbook')
@login_required
def textbook(course_id):
    course = project_store.load(course_id)
    if not course:
        return redirect(url_for('dashboard'))
    return render_template('textbook.html',
                         course=course,
                         active_page='textbook',
                         breadcrumb=[...])
```
  </action>
  <verify>
Visit /courses/{id}/textbook:
- Two-panel layout displays
- Chapter list shows one entry per learning outcome
- Tabs switch between Chapters, Glossary, Settings
- Preview panel shows empty state or "Select a chapter"
  </verify>
  <done>
Textbook template created with chapter list, glossary tab, and preview panel. Route added.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add Chapter Generation and Preview</name>
  <files>
    static/js/pages/textbook.js
    templates/textbook.html
  </files>
  <action>
Add JavaScript for chapter generation:

**static/js/pages/textbook.js:**

TextbookController class:

**Initialization:**
- chapterList: element reference
- previewPanel: element reference
- glossaryList: element reference
- chapters: array of chapter data
- selectedChapterId: current selection

**Chapter List:**
- loadChapters():
  - Fetch from /api/courses/{id}/textbook/chapters
  - Render chapter list with status indicators
- renderChapterList(chapters):
  - Build HTML for each chapter
  - Show generate button if not generated
  - Show status badge

**Chapter Selection:**
- handleChapterSelect(chapterId):
  - Set selectedChapterId
  - Highlight in list
  - If generated: show preview
  - If not: show "Not yet generated" message

**Generation:**
- handleGenerateChapter(chapterId):
  - Show loading state on chapter item
  - POST to /api/courses/{id}/textbook/chapters/{cid}/generate
  - Poll job status (textbook generation is async)
  - On complete: update chapter data, show preview
  - Toast feedback

- handleGenerateAll():
  - POST to /api/courses/{id}/textbook/generate
  - Show progress (N of M chapters)
  - Poll job status for overall progress
  - Update chapter list as each completes

- pollJobStatus(jobId, callback):
  - GET /api/courses/{id}/textbook/jobs/{jobId}
  - If pending/running: setTimeout and poll again
  - If completed: call callback with result
  - If failed: show error

**Preview Rendering:**
- renderChapterPreview(chapter):
  - Title
  - Introduction
  - Sections with headings and content
  - Image placeholders
  - Glossary terms (highlighted)
  - References
- renderFullTextbook():
  - Table of contents
  - All chapters in order

**Update templates/textbook.html:**
- Include textbook.js
- Wire up chapter click handlers
- Generate button onclick handlers
- Initialize TextbookController
  </action>
  <verify>
On textbook page:
- Click chapter -> preview shows content or empty message
- Click Generate on chapter -> loading state, then content appears
- Preview shows formatted chapter with sections
- Click Generate All -> progress shown, chapters update as completed
  </verify>
  <done>
Chapter generation works with async polling. Preview displays generated chapters. Bulk generation tracks progress.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add Glossary Management</name>
  <files>
    static/js/pages/textbook.js
    templates/textbook.html
  </files>
  <action>
Add glossary CRUD operations:

**Add to static/js/pages/textbook.js:**

**Glossary Tab:**
- glossaryModal: Modal instance
- currentTermId: null for add, ID for edit

- loadGlossary():
  - Fetch all glossary terms from chapters
  - Aggregate unique terms
  - Sort alphabetically
  - Render glossary list

- renderGlossaryList(terms):
  - Group by first letter (optional)
  - Each term shows: term, definition, source chapter
  - Edit and Delete buttons

**CRUD Operations:**
- showAddTerm():
  - Open modal with empty form
  - Term input, Definition textarea
  - Associate with chapter dropdown

- showEditTerm(termId):
  - Find term in data
  - Populate modal
  - Open modal

- handleTermSave():
  - Get form values
  - If currentTermId: update existing
  - Else: add new
  - Save to chapter data
  - Refresh list

- handleTermDelete(termId):
  - Confirmation modal
  - Remove from chapter data
  - Refresh list

Note: Glossary terms are stored within chapter.glossary_terms array. Updates need to be saved back to the chapter.

**Glossary in Preview:**
- highlightGlossaryTerms(content, terms):
  - Find term occurrences in content
  - Wrap with span.glossary-term
  - Add tooltip with definition

**Update templates/textbook.html:**
- Glossary tab content
- Add term button
- Term edit modal
- Glossary list container
  </action>
  <verify>
On textbook page, Glossary tab:
- Existing terms display alphabetically
- Click Add Term -> modal opens
- Fill and save -> term appears in list
- Click Edit -> modal with data, save updates
- Click Delete -> confirmation, term removed
- In preview, glossary terms are highlighted
  </verify>
  <done>
Glossary CRUD works. Terms display in list. Terms highlighted in chapter preview.
  </done>
</task>

</tasks>

<verification>
- Textbook page loads at /courses/{id}/textbook
- Chapter list shows one per learning outcome
- Generation works (single and bulk)
- Preview displays formatted chapters
- Glossary tab shows terms
- Term CRUD operations work
- Terms highlighted in preview
- No JavaScript console errors
</verification>

<success_criteria>
1. Two-panel layout with tabs (Chapters, Glossary, Settings)
2. Chapter list shows status for each chapter
3. Single chapter generation with progress
4. Bulk generation with overall progress
5. Chapter preview shows formatted content
6. Glossary displays all terms alphabetically
7. Glossary CRUD works with modal dialogs
8. Glossary terms highlighted in preview
</success_criteria>

<output>
After completion, create `.planning/phases/11-ui-implementation/11-07-SUMMARY.md`
</output>
