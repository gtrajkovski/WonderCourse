---
phase: 10-collaboration-roles
plan: 08
type: execute
wave: 4
depends_on: ["10-03", "10-05", "10-06", "10-07"]
files_modified:
  - src/api/modules.py
  - src/api/lessons.py
  - src/api/activities.py
  - src/api/content.py
  - src/api/build_state.py
  - src/api/blueprint.py
  - src/api/export.py
  - tests/test_collab_integration.py
autonomous: true

must_haves:
  truths:
    - "All existing API endpoints check permissions before operations"
    - "Content changes are logged to audit trail"
    - "Structure changes are logged to audit trail"
    - "Approval workflow enforces approve_content permission"
  artifacts:
    - path: "tests/test_collab_integration.py"
      provides: "End-to-end collaboration tests"
      min_lines: 200
  key_links:
    - from: "src/api/content.py"
      to: "src/collab/audit.py"
      via: "Audit logging for content changes"
      pattern: "from src.collab.audit import log_audit_entry"
    - from: "src/api/modules.py"
      to: "src/collab/decorators.py"
      via: "Permission enforcement"
      pattern: "from src.collab.decorators import require_permission"
---

<objective>
Wire permission checks and audit logging into all existing API endpoints.

Purpose: Complete the collaboration integration by enforcing permissions and tracking changes
Output: All API endpoints protected with role-based permissions and changes logged to audit trail
</objective>

<execution_context>
@C:\Users\gpt30\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\gpt30\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-collaboration-roles/10-03-SUMMARY.md
@.planning/phases/10-collaboration-roles/10-05-SUMMARY.md
@.planning/phases/10-collaboration-roles/10-06-SUMMARY.md
@.planning/phases/10-collaboration-roles/10-07-SUMMARY.md
@src/api/modules.py
@src/api/content.py
@src/api/build_state.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add permission decorators to structure endpoints</name>
  <files>src/api/modules.py, src/api/lessons.py, src/api/activities.py, src/api/learning_outcomes.py</files>
  <action>
Add permission decorators to structure management endpoints. Each file needs:

Import additions:
```python
from src.collab.decorators import require_permission
from src.collab.audit import log_audit_entry, ACTION_STRUCTURE_ADDED, ACTION_STRUCTURE_UPDATED, ACTION_STRUCTURE_DELETED, ACTION_STRUCTURE_REORDERED
```

Permission mapping for modules.py:
- GET /api/courses/<course_id>/modules: @require_permission('view_content')
- POST /api/courses/<course_id>/modules: @require_permission('add_structure')
  - Log audit: ACTION_STRUCTURE_ADDED, entity_type='module'
- PUT /api/courses/<course_id>/modules/<mid>: @require_permission('add_structure')
  - Log audit: ACTION_STRUCTURE_UPDATED with before/after
- DELETE /api/courses/<course_id>/modules/<mid>: @require_permission('delete_structure')
  - Log audit: ACTION_STRUCTURE_DELETED
- PUT /api/courses/<course_id>/modules/reorder: @require_permission('reorder_structure')
  - Log audit: ACTION_STRUCTURE_REORDERED

Same pattern for lessons.py and activities.py:
- GET: view_content
- POST: add_structure (with audit log)
- PUT: add_structure (with audit log)
- DELETE: delete_structure (with audit log)
- reorder: reorder_structure (with audit log)

For learning_outcomes.py:
- All endpoints: @require_permission('manage_outcomes')
- Log audit for add/update/delete/map/unmap operations

Note: Decorators go AFTER @login_required, e.g.:
```python
@bp.route('...')
@login_required
@require_permission('add_structure')
def create_module(course_id):
    ...
```
  </action>
  <verify>python -c "from src.api.modules import modules_bp; print('Modules has permission checks')"</verify>
  <done>Structure endpoints protected with permissions and audit logging</done>
</task>

<task type="auto">
  <name>Task 2: Add permission decorators to content endpoints</name>
  <files>src/api/content.py, src/api/build_state.py, src/api/blueprint.py, src/api/export.py</files>
  <action>
Add permission decorators to content and workflow endpoints:

Import additions for all files:
```python
from src.collab.decorators import require_permission
from src.collab.audit import log_audit_entry, ACTION_CONTENT_GENERATED, ACTION_CONTENT_UPDATED, ACTION_CONTENT_APPROVED, ACTION_COURSE_EXPORTED
```

content.py:
- POST /generate: @require_permission('generate_content')
  - Log: ACTION_CONTENT_GENERATED
- POST /regenerate: @require_permission('generate_content')
  - Log: ACTION_CONTENT_UPDATED with before/after
- PUT /content: @require_permission('edit_content')
  - Log: ACTION_CONTENT_UPDATED with before/after

build_state.py:
- GET /progress: @require_permission('view_content')
- PUT /state: @require_permission('edit_content') for most transitions
  - Special case: APPROVED transition requires @require_permission('approve_content')
  - Log: state change in audit
- POST /approve: @require_permission('approve_content')
  - Log: ACTION_CONTENT_APPROVED

blueprint.py:
- POST /generate: @require_permission('generate_content')
- POST /accept: @require_permission('add_structure')
- POST /refine: @require_permission('generate_content')

export.py:
- GET /preview: @require_permission('export_course')
- GET /instructor, /lms, /docx, /scorm: @require_permission('export_course')
  - Log: ACTION_COURSE_EXPORTED

For build_state.py, implement special approval permission check:
```python
# In state transition endpoint
if new_state == BuildState.APPROVED:
    if not has_permission(current_user.id, course_id, 'approve_content'):
        return jsonify({"error": "Approval requires approve_content permission"}), 403
```
  </action>
  <verify>python -c "from src.api.content import content_bp; print('Content has permission checks')"</verify>
  <done>Content and workflow endpoints protected with permissions and audit logging</done>
</task>

<task type="auto">
  <name>Task 3: Create collaboration integration tests</name>
  <files>tests/test_collab_integration.py</files>
  <action>
Create tests/test_collab_integration.py with end-to-end collaboration scenarios:

1. Test fixtures:
   - test_app with all blueprints registered
   - test_db with permissions seeded
   - owner_user - Course creator with Owner role
   - designer_user - Invited as Designer
   - reviewer_user - Invited as Reviewer
   - sme_user - Invited as SME
   - test_course - Course with all users as collaborators

2. Permission hierarchy tests:
   - test_owner_has_all_permissions - Can do everything
   - test_designer_can_edit_not_approve - Edit works, approve fails
   - test_reviewer_can_approve_not_edit - Approve works, edit fails
   - test_sme_can_view_only - View works, all mutations fail

3. Structure permission tests:
   - test_designer_can_add_module - add_structure works
   - test_sme_cannot_add_module - Returns 403
   - test_owner_can_delete_module - delete_structure works
   - test_designer_cannot_delete_module - Returns 403

4. Content workflow tests:
   - test_designer_can_generate_content - generate_content works
   - test_designer_can_edit_content - edit_content works
   - test_designer_cannot_approve - approve_content denied
   - test_reviewer_can_approve - approve_content works
   - test_sme_cannot_generate - Returns 403

5. Audit trail tests:
   - test_module_creation_logged - Audit entry created
   - test_content_update_logged_with_diff - Changes captured
   - test_approval_logged_with_user - User attribution correct
   - test_activity_feed_shows_all_actions - Full history visible

6. Collaboration flow tests:
   - test_full_collaboration_workflow:
     1. Owner creates course (auto-owner)
     2. Owner invites Designer
     3. Designer creates module
     4. Designer generates content
     5. Reviewer approves content
     6. All actions in audit trail
   - test_revoked_collaborator_loses_access - After removal, 403 returned

7. Edge cases:
   - test_owner_cannot_remove_self_if_only_owner - Returns 400
   - test_role_change_takes_effect_immediately - No stale cache
   - test_deleted_user_shows_in_audit - "[Deleted User]" displayed
  </action>
  <verify>pytest tests/test_collab_integration.py -v</verify>
  <done>25+ integration tests covering full collaboration workflows</done>
</task>

</tasks>

<verification>
1. All structure endpoints have permission decorators
2. All content endpoints have permission decorators
3. Approval workflow enforces approve_content permission
4. All changes logged to audit trail with diffs
5. Permission changes take effect immediately
6. Integration tests cover full collaboration scenarios
7. All tests pass (existing + new)
</verification>

<success_criteria>
- [ ] modules/lessons/activities endpoints check permissions
- [ ] content/build_state endpoints check permissions
- [ ] export endpoints check export_course permission
- [ ] Approval requires approve_content specifically
- [ ] Structure changes logged to audit trail
- [ ] Content changes logged with before/after diffs
- [ ] Owner > Designer > Reviewer > SME hierarchy enforced
- [ ] 25+ integration tests pass
- [ ] All existing tests still pass
</success_criteria>

<output>
After completion, create `.planning/phases/10-collaboration-roles/10-08-SUMMARY.md`
</output>
