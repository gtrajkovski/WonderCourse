---
phase: 10-collaboration-roles
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - instance/schema.sql
  - src/collab/invitations.py
  - src/collab/__init__.py
autonomous: true

must_haves:
  truths:
    - "Email invitations can be created with configurable expiry"
    - "Shareable links can be created without email"
    - "Tokens can be validated considering expiry and revocation"
    - "Invitations can be revoked independently"
  artifacts:
    - path: "src/collab/invitations.py"
      provides: "Invitation model with token generation and validation"
      exports: ["Invitation", "generate_invitation_token", "validate_invitation_token"]
    - path: "instance/schema.sql"
      provides: "invitation table"
      contains: "CREATE TABLE invitation"
  key_links:
    - from: "src/collab/invitations.py"
      to: "src/auth/db.py"
      via: "get_db for database operations"
      pattern: "from src.auth.db import get_db"
---

<objective>
Create the invitation system for email and shareable link invitations.

Purpose: Enable course owners to invite collaborators via email or shareable links with configurable expiry
Output: Invitation model with token generation, validation, and revocation
</objective>

<execution_context>
@C:\Users\gpt30\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\gpt30\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-collaboration-roles/10-CONTEXT.md
@.planning/phases/10-collaboration-roles/10-RESEARCH.md
@src/auth/db.py
@src/auth/tokens.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add invitation table to schema</name>
  <files>instance/schema.sql</files>
  <action>
Add invitation table after the collaborator table in schema.sql:

```sql
CREATE TABLE IF NOT EXISTS invitation (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    token TEXT UNIQUE NOT NULL,
    course_id TEXT NOT NULL,
    role_id INTEGER NOT NULL,
    invited_by INTEGER NOT NULL,
    email TEXT,                        -- NULL for shareable links
    expires_at TIMESTAMP,              -- NULL for no expiry
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    revoked INTEGER DEFAULT 0,
    FOREIGN KEY (role_id) REFERENCES course_role(id),
    FOREIGN KEY (invited_by) REFERENCES user(id)
);

CREATE INDEX IF NOT EXISTS idx_invitation_token ON invitation(token);
CREATE INDEX IF NOT EXISTS idx_invitation_course ON invitation(course_id);
```

The token field stores a unique URL-safe token for each invitation.
Email is NULL for shareable links that anyone can use.
expires_at is NULL when no expiry is set (link never expires).
revoked flag allows revoking without deleting (preserves audit trail).
  </action>
  <verify>sqlite3 -init instance/schema.sql :memory: ".schema invitation" shows all columns</verify>
  <done>Invitation table with token, expiry, and revocation support</done>
</task>

<task type="auto">
  <name>Task 2: Create Invitation model and token utilities</name>
  <files>src/collab/invitations.py, src/collab/__init__.py</files>
  <action>
Create src/collab/invitations.py with:

1. Constants:
   - DEFAULT_EXPIRY_SECONDS = 604800  # 7 days
   - INVITATION_TOKEN_LENGTH = 32

2. Token generation function:
   - `generate_invitation_token()` - Use secrets.token_urlsafe(32) for unique tokens

3. Invitation class:
   - Properties: id, token, course_id, role_id, invited_by, email, expires_at, created_at, revoked
   - Class methods:
     - `create(course_id, role_id, invited_by, email=None, expires_in=DEFAULT_EXPIRY_SECONDS)`:
       - Generate unique token
       - Calculate expires_at if expires_in provided (datetime.now() + timedelta(seconds=expires_in))
       - Insert into database
       - Return Invitation instance
     - `create_shareable_link(course_id, role_id, invited_by, expires_in=None)`:
       - Wrapper for create() with email=None
       - expires_in=None means no expiry
     - `get_by_token(token)` - Load invitation by token
     - `get_for_course(course_id, include_revoked=False)` - List invitations for course
     - `revoke(invitation_id)` - Set revoked=1
     - `delete(invitation_id)` - Hard delete (for cleanup)
   - Instance methods:
     - `to_dict()` - Serialize for API (exclude internal fields like id)
     - `is_valid()` - Check not revoked and not expired

4. Validation function:
   - `validate_invitation_token(token)`:
     - Look up invitation by token
     - Check revoked == 0
     - Check expires_at is None or > datetime.now()
     - Return (course_id, role_id) tuple if valid, None if invalid

5. Accept function:
   - `accept_invitation(token, user_id)`:
     - Validate token
     - Check user not already collaborator on course
     - Create collaborator entry
     - Return collaborator or None with error message

Update src/collab/__init__.py to export Invitation, generate_invitation_token, validate_invitation_token, accept_invitation.
  </action>
  <verify>python -c "from src.collab.invitations import Invitation, validate_invitation_token; print('Invitations loaded')"</verify>
  <done>Invitation model with email and shareable link support, validation, and acceptance</done>
</task>

<task type="auto">
  <name>Task 3: Add invitation tests</name>
  <files>tests/test_invitations.py</files>
  <action>
Create tests/test_invitations.py with comprehensive tests:

1. Test fixtures:
   - `test_app` - Flask app with test database
   - `test_db` - Fresh database for each test
   - `test_user` - User who creates invitations
   - `test_course_role` - Role to assign in invitations

2. Token generation tests:
   - test_generate_invitation_token_is_unique - Generate multiple tokens, all unique
   - test_generate_invitation_token_is_url_safe - Token contains only URL-safe chars

3. Email invitation tests:
   - test_create_email_invitation - Creates with email, returns Invitation
   - test_email_invitation_has_expiry - Default 7-day expiry set
   - test_email_invitation_custom_expiry - Custom expiry respected

4. Shareable link tests:
   - test_create_shareable_link_no_email - email is None
   - test_shareable_link_no_expiry - expires_at is None when no expiry
   - test_shareable_link_with_expiry - Can set custom expiry on links

5. Validation tests:
   - test_validate_valid_token - Returns (course_id, role_id)
   - test_validate_revoked_token - Returns None
   - test_validate_expired_token - Returns None
   - test_validate_nonexistent_token - Returns None
   - test_validate_no_expiry_always_valid - Never expires if expires_at is None

6. Revocation tests:
   - test_revoke_invitation - Sets revoked=1
   - test_revoked_invitation_invalid - is_valid() returns False

7. Accept tests:
   - test_accept_invitation_creates_collaborator - User becomes collaborator
   - test_accept_invitation_already_collaborator - Returns error, no duplicate
   - test_accept_revoked_invitation_fails - Returns None

Use pytest fixtures with Flask test client pattern from test_auth_models.py.
  </action>
  <verify>pytest tests/test_invitations.py -v</verify>
  <done>18+ tests covering invitation creation, validation, revocation, and acceptance</done>
</task>

</tasks>

<verification>
1. Invitation table has all required columns and indexes
2. Token generation produces unique URL-safe tokens
3. Email invitations have configurable expiry (default 7 days)
4. Shareable links work with or without expiry
5. Validation checks both revocation and expiry
6. Acceptance creates collaborator and handles duplicates
7. All tests pass
</verification>

<success_criteria>
- [ ] invitation table created with token, email, expires_at, revoked columns
- [ ] Invitation.create() generates unique tokens
- [ ] Invitation.create_shareable_link() works without email
- [ ] validate_invitation_token() rejects revoked tokens
- [ ] validate_invitation_token() rejects expired tokens
- [ ] accept_invitation() creates collaborator entry
- [ ] accept_invitation() prevents duplicate collaborators
- [ ] 18+ tests pass in test_invitations.py
</success_criteria>

<output>
After completion, create `.planning/phases/10-collaboration-roles/10-02-SUMMARY.md`
</output>
