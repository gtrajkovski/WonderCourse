---
phase: 10-collaboration-roles
plan: 06
type: execute
wave: 3
depends_on: ["10-01", "10-02", "10-03"]
files_modified:
  - src/api/collab.py
  - app.py
  - tests/test_collab_api.py
autonomous: true

must_haves:
  truths:
    - "Course owner can invite collaborators via API"
    - "Invitations can be accepted, listed, and revoked"
    - "Collaborator list shows all users with their roles"
    - "Roles can be created and managed per-course"
  artifacts:
    - path: "src/api/collab.py"
      provides: "Collaboration API Blueprint with invitation and role endpoints"
      exports: ["collab_bp", "init_collab_bp"]
  key_links:
    - from: "src/api/collab.py"
      to: "src/collab/invitations.py"
      via: "invitation CRUD operations"
      pattern: "from src.collab.invitations import"
    - from: "app.py"
      to: "src/api/collab.py"
      via: "Blueprint registration"
      pattern: "app.register_blueprint(collab_bp)"
---

<objective>
Create the Collaboration API Blueprint for invitation and role management.

Purpose: Expose invitation, collaborator, and role management via REST API
Output: Flask Blueprint with endpoints for inviting users, managing roles, and listing collaborators
</objective>

<execution_context>
@C:\Users\gpt30\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\gpt30\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-collaboration-roles/10-CONTEXT.md
@.planning/phases/10-collaboration-roles/10-01-SUMMARY.md
@.planning/phases/10-collaboration-roles/10-02-SUMMARY.md
@.planning/phases/10-collaboration-roles/10-03-SUMMARY.md
@src/api/modules.py
@app.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Collaboration API Blueprint</name>
  <files>src/api/collab.py</files>
  <action>
Create src/api/collab.py with Flask Blueprint:

1. Blueprint setup:
   ```python
   from flask import Blueprint, request, jsonify, g
   from flask_login import login_required, current_user
   from src.collab.decorators import require_permission
   from src.collab.models import Role, Collaborator
   from src.collab.invitations import Invitation, accept_invitation, validate_invitation_token
   from src.collab.permissions import PERMISSIONS, ROLE_TEMPLATES, seed_permissions

   collab_bp = Blueprint('collab', __name__)
   _project_store = None

   def init_collab_bp(project_store):
       global _project_store
       _project_store = project_store
   ```

2. Role endpoints:
   - GET /api/courses/<course_id>/roles - List roles for course
     - @login_required, @require_permission('view_content')
     - Returns list of roles with permissions
   - POST /api/courses/<course_id>/roles - Create custom role
     - @login_required, @require_permission('invite_collaborators')
     - Body: {"name": "...", "permissions": ["edit_content", ...]}
     - Returns created role
   - POST /api/courses/<course_id>/roles/from-template - Create from template
     - @login_required, @require_permission('invite_collaborators')
     - Body: {"template": "Designer"}
     - Returns created role
   - DELETE /api/courses/<course_id>/roles/<role_id> - Delete role
     - @login_required, @require_permission('invite_collaborators')
     - Returns 204 on success, 400 if role in use

3. Invitation endpoints:
   - POST /api/courses/<course_id>/invitations - Create invitation
     - @login_required, @require_permission('invite_collaborators')
     - Body: {"role_id": N, "email": "...", "expires_in": 604800} (email optional for link)
     - Returns invitation with token
   - GET /api/courses/<course_id>/invitations - List pending invitations
     - @login_required, @require_permission('invite_collaborators')
     - Returns list of invitations
   - DELETE /api/courses/<course_id>/invitations/<invitation_id> - Revoke
     - @login_required, @require_permission('invite_collaborators')
     - Returns 204 on success

4. Accept invitation (public-ish endpoint):
   - POST /api/invitations/<token>/accept - Accept invitation
     - @login_required (must be logged in, but any user can accept their invitation)
     - Validates token, creates collaborator
     - Returns collaborator info or 400 if invalid/expired/revoked

5. Collaborator endpoints:
   - GET /api/courses/<course_id>/collaborators - List collaborators
     - @login_required, @require_permission('view_content')
     - Returns list with user info and role names
   - PUT /api/courses/<course_id>/collaborators/<collaborator_id> - Update role
     - @login_required, @require_permission('invite_collaborators')
     - Body: {"role_id": N}
     - Returns updated collaborator
   - DELETE /api/courses/<course_id>/collaborators/<collaborator_id> - Remove
     - @login_required, @require_permission('invite_collaborators')
     - Cannot remove self if only owner
     - Returns 204 on success

6. Permission info endpoint:
   - GET /api/permissions - List all available permissions
     - Public (for UI to display permission picker)
     - Returns PERMISSIONS dict

7. Role template info endpoint:
   - GET /api/role-templates - List available templates
     - Public (for UI to display template options)
     - Returns ROLE_TEMPLATES dict
  </action>
  <verify>python -c "from src.api.collab import collab_bp; print('Collab API loaded')"</verify>
  <done>Collaboration API Blueprint with role, invitation, and collaborator endpoints</done>
</task>

<task type="auto">
  <name>Task 2: Register Blueprint and update course creation</name>
  <files>app.py</files>
  <action>
Update app.py to:

1. Import and register collab_bp:
   ```python
   from src.api.collab import collab_bp, init_collab_bp

   # In app creation after other blueprints:
   init_collab_bp(project_store)
   app.register_blueprint(collab_bp)
   ```

2. Update POST /api/courses to make creator the owner:
   ```python
   from src.collab.decorators import ensure_owner_collaborator
   from src.collab.permissions import seed_permissions

   # In POST /api/courses handler, after creating course:
   course = Course(...)
   project_store.save(current_user.id, course)

   # Make creator the owner
   seed_permissions(get_db())  # Ensure permissions exist (idempotent)
   ensure_owner_collaborator(course.id, current_user.id)

   return jsonify(course.to_dict()), 201
   ```

3. Call seed_permissions in app initialization:
   - Ensures permission table populated on first run
   - Use with app.app_context() if needed

Note: seed_permissions is idempotent (INSERT OR IGNORE) so safe to call multiple times.
  </action>
  <verify>python -c "from app import app; print('App loads with collab_bp')"</verify>
  <done>Collaboration Blueprint registered and course creation makes owners</done>
</task>

<task type="auto">
  <name>Task 3: Create collaboration API tests</name>
  <files>tests/test_collab_api.py</files>
  <action>
Create tests/test_collab_api.py with:

1. Test fixtures:
   - test_app with collab_bp registered
   - test_db with permissions seeded
   - test_user, test_client for auth
   - test_course with test_user as owner

2. Role endpoint tests:
   - test_list_roles_returns_owner_role - Course has Owner role
   - test_create_role_with_permissions - Custom role created
   - test_create_role_from_template - Template cloned correctly
   - test_delete_role_not_in_use - Deletes successfully
   - test_delete_role_in_use_fails - Returns 400 if collaborators have role

3. Invitation endpoint tests:
   - test_create_email_invitation - Returns token
   - test_create_shareable_link - email=null in response
   - test_list_invitations - Shows pending invitations
   - test_revoke_invitation - Sets revoked, removed from list

4. Accept invitation tests:
   - test_accept_invitation_creates_collaborator - User becomes collaborator
   - test_accept_invitation_invalid_token - Returns 400
   - test_accept_invitation_expired - Returns 400
   - test_accept_invitation_already_collaborator - Returns 400

5. Collaborator endpoint tests:
   - test_list_collaborators - Shows owner
   - test_update_collaborator_role - Role changed
   - test_remove_collaborator - User removed
   - test_cannot_remove_only_owner - Returns 400

6. Permission enforcement tests:
   - test_non_collaborator_cannot_list_roles - Returns 403
   - test_viewer_cannot_invite - SME role gets 403 on invite
   - test_owner_can_invite - Owner succeeds

7. New course makes owner tests:
   - test_create_course_makes_owner - Creator is collaborator with Owner role
  </action>
  <verify>pytest tests/test_collab_api.py -v</verify>
  <done>20+ tests covering collaboration API endpoints</done>
</task>

</tasks>

<verification>
1. Role CRUD endpoints work with proper permissions
2. Invitation endpoints create and manage invitations
3. Accept endpoint validates and creates collaborators
4. Collaborator endpoints list and manage team members
5. Course creation automatically makes creator the owner
6. Permission checks enforced on all protected endpoints
7. All tests pass
</verification>

<success_criteria>
- [ ] GET /api/courses/<id>/roles returns role list
- [ ] POST /api/courses/<id>/invitations creates invitation
- [ ] POST /api/invitations/<token>/accept adds collaborator
- [ ] GET /api/courses/<id>/collaborators lists team
- [ ] Course creation calls ensure_owner_collaborator
- [ ] Permission checks return 403 for unauthorized users
- [ ] 20+ API tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/10-collaboration-roles/10-06-SUMMARY.md`
</output>
