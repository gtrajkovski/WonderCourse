---
phase: 10-collaboration-roles
plan: 07
type: execute
wave: 3
depends_on: ["10-04", "10-05"]
files_modified:
  - src/api/collab.py
  - tests/test_collab_api.py
autonomous: true

must_haves:
  truths:
    - "Comments can be added, replied to, and resolved via API"
    - "Activity feed returns recent changes with user attribution"
    - "Mentions create notifications retrievable via API"
    - "Audit entries logged for comment actions"
  artifacts:
    - path: "src/api/collab.py"
      provides: "Comment and activity feed endpoints"
      contains: "def get_comments"
  key_links:
    - from: "src/api/collab.py"
      to: "src/collab/comments.py"
      via: "Comment CRUD operations"
      pattern: "from src.collab.comments import Comment"
    - from: "src/api/collab.py"
      to: "src/collab/audit.py"
      via: "Activity feed queries"
      pattern: "from src.collab.audit import get_activity_feed"
---

<objective>
Add comment and activity feed endpoints to the Collaboration API.

Purpose: Complete the collaboration API with commenting and activity history
Output: REST endpoints for comments, mentions, and activity feed
</objective>

<execution_context>
@C:\Users\gpt30\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\gpt30\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-collaboration-roles/10-04-SUMMARY.md
@.planning/phases/10-collaboration-roles/10-05-SUMMARY.md
@.planning/phases/10-collaboration-roles/10-06-SUMMARY.md
@src/api/collab.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add comment endpoints to collab API</name>
  <files>src/api/collab.py</files>
  <action>
Add comment endpoints to src/api/collab.py:

Import additions:
```python
from src.collab.comments import Comment, Mention
from src.collab.audit import log_audit_entry, ACTION_CONTENT_UPDATED
```

1. Course-level comments:
   - GET /api/courses/<course_id>/comments - List course-level comments
     - @login_required, @require_permission('view_content')
     - Query params: include_resolved=false
     - Returns comments with replies
   - POST /api/courses/<course_id>/comments - Add course-level comment
     - @login_required, @require_permission('view_content')
     - Body: {"content": "...", "parent_id": null}
     - Returns created comment
     - Logs audit entry

2. Activity-level comments:
   - GET /api/courses/<course_id>/activities/<activity_id>/comments
     - @login_required, @require_permission('view_content')
     - Query params: include_resolved=false
     - Returns comments with replies for specific activity
   - POST /api/courses/<course_id>/activities/<activity_id>/comments
     - @login_required, @require_permission('view_content')
     - Body: {"content": "...", "parent_id": null}
     - Returns created comment

3. Comment management:
   - PUT /api/courses/<course_id>/comments/<comment_id> - Update comment
     - @login_required
     - Only comment author or owner can update
     - Body: {"content": "..."}
     - Returns updated comment
   - POST /api/courses/<course_id>/comments/<comment_id>/resolve - Resolve
     - @login_required, @require_permission('view_content')
     - Any collaborator can resolve
     - Returns {"status": "resolved"}
   - POST /api/courses/<course_id>/comments/<comment_id>/unresolve - Unresolve
     - @login_required, @require_permission('view_content')
     - Returns {"status": "unresolved"}
   - DELETE /api/courses/<course_id>/comments/<comment_id> - Delete
     - @login_required
     - Only comment author or owner can delete
     - Returns 204

4. Mention/notification endpoints:
   - GET /api/notifications - Get current user's unread mentions
     - @login_required (no course_id needed)
     - Returns list of unread mentions with comment context
   - POST /api/notifications/<mention_id>/read - Mark mention read
     - @login_required
     - Returns 204
   - POST /api/notifications/read-all - Mark all read
     - @login_required
     - Returns {"marked_read": count}
  </action>
  <verify>python -c "from src.api.collab import collab_bp; print('Comment endpoints added')"</verify>
  <done>Comment and mention endpoints added to collab API</done>
</task>

<task type="auto">
  <name>Task 2: Add activity feed endpoint</name>
  <files>src/api/collab.py</files>
  <action>
Add activity feed endpoint to src/api/collab.py:

Import addition:
```python
from src.collab.audit import get_activity_feed, AuditEntry
```

Activity feed endpoint:
- GET /api/courses/<course_id>/activity - Get activity feed
  - @login_required, @require_permission('view_content')
  - Query params: limit=50, offset=0
  - Returns list of activity entries with:
    - action (e.g., "content_updated")
    - entity_type (e.g., "activity")
    - entity_id
    - user_name (or "[Deleted User]")
    - summary (human-readable description)
    - created_at (ISO timestamp)

Example response:
```json
{
  "feed": [
    {
      "action": "content_updated",
      "entity_type": "activity",
      "entity_id": "act_123",
      "user_name": "Alice Smith",
      "summary": "Updated activity content",
      "created_at": "2026-02-09T14:30:00Z"
    }
  ],
  "limit": 50,
  "offset": 0,
  "has_more": true
}
```

Also add helper to log audit entries from other endpoints:
- When comment created: log "comment_added" action
- When comment resolved: log "comment_resolved" action
- When collaborator added: log "collaborator_joined" action
  </action>
  <verify>python -c "from src.api.collab import collab_bp; print('Activity feed endpoint added')"</verify>
  <done>Activity feed endpoint returns paginated change history</done>
</task>

<task type="auto">
  <name>Task 3: Add comment and feed API tests</name>
  <files>tests/test_collab_api.py</files>
  <action>
Add tests to tests/test_collab_api.py for comments and activity feed:

1. Course-level comment tests:
   - test_create_course_comment - Comment created successfully
   - test_list_course_comments - Returns comments with replies
   - test_reply_to_comment - Reply created with parent_id
   - test_cannot_reply_to_reply - Returns 400

2. Activity-level comment tests:
   - test_create_activity_comment - Comment attached to activity
   - test_list_activity_comments - Filtered to specific activity

3. Comment management tests:
   - test_update_own_comment - Author can update
   - test_cannot_update_others_comment - Returns 403
   - test_resolve_comment - Comment hidden from default list
   - test_unresolve_comment - Comment visible again
   - test_delete_comment - Removed with replies

4. Mention tests:
   - test_comment_with_mention_creates_notification - Mention record created
   - test_get_notifications - Returns unread mentions
   - test_mark_notification_read - Sets read flag
   - test_mark_all_read - All notifications cleared

5. Activity feed tests:
   - test_activity_feed_returns_entries - Recent activity shown
   - test_activity_feed_pagination - limit/offset work
   - test_activity_feed_includes_user_name - Attribution shown
   - test_activity_logs_comment_actions - Comments appear in feed

6. Permission tests:
   - test_non_collaborator_cannot_comment - Returns 403
   - test_non_collaborator_cannot_view_feed - Returns 403
  </action>
  <verify>pytest tests/test_collab_api.py -v -k "comment or feed or notification"</verify>
  <done>20+ additional tests for comments and activity feed</done>
</task>

</tasks>

<verification>
1. Comment CRUD endpoints work correctly
2. Reply threading enforced (single-level only)
3. Resolution hides comments by default
4. Mentions create notification records
5. Activity feed shows recent changes with pagination
6. Audit entries logged for comment actions
7. All tests pass
</verification>

<success_criteria>
- [ ] POST /api/courses/<id>/comments creates comment
- [ ] GET /api/courses/<id>/activities/<aid>/comments returns activity comments
- [ ] POST /api/courses/<id>/comments/<cid>/resolve hides comment
- [ ] GET /api/notifications returns unread mentions
- [ ] GET /api/courses/<id>/activity returns paginated feed
- [ ] Comment actions logged to audit trail
- [ ] 20+ additional tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/10-collaboration-roles/10-07-SUMMARY.md`
</output>
