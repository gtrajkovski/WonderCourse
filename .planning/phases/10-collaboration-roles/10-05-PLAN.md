---
phase: 10-collaboration-roles
plan: 05
type: execute
wave: 2
depends_on: ["10-01"]
files_modified:
  - instance/schema.sql
  - src/collab/audit.py
  - src/collab/__init__.py
  - tests/test_audit.py
autonomous: true

must_haves:
  truths:
    - "All content changes are tracked with user attribution"
    - "Audit entries store before/after diffs, not full documents"
    - "Audit trail includes structure, collaborator, and state changes"
    - "All collaborators can view the audit trail"
  artifacts:
    - path: "src/collab/audit.py"
      provides: "AuditEntry model and logging utilities"
      exports: ["AuditEntry", "log_audit_entry", "get_activity_feed"]
    - path: "instance/schema.sql"
      provides: "audit_entry table"
      contains: "CREATE TABLE audit_entry"
  key_links:
    - from: "src/collab/audit.py"
      to: "jsondiff"
      via: "diff calculation for efficient storage"
      pattern: "import jsondiff"
---

<objective>
Create the audit trail system for tracking all course changes with efficient diff storage.

Purpose: Maintain comprehensive history of all changes with user attribution for accountability
Output: AuditEntry model with diff-based storage and activity feed queries
</objective>

<execution_context>
@C:\Users\gpt30\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\gpt30\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-collaboration-roles/10-CONTEXT.md
@.planning/phases/10-collaboration-roles/10-RESEARCH.md
@.planning/phases/10-collaboration-roles/10-01-SUMMARY.md
@src/auth/db.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add audit_entry table to schema</name>
  <files>instance/schema.sql</files>
  <action>
Add audit_entry table to schema.sql:

```sql
-- Audit trail for all changes
CREATE TABLE IF NOT EXISTS audit_entry (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    course_id TEXT NOT NULL,
    user_id INTEGER NOT NULL,
    action TEXT NOT NULL,                  -- "content_updated", "structure_changed", etc.
    entity_type TEXT NOT NULL,             -- "activity", "module", "lesson", "collaborator", "course"
    entity_id TEXT,                        -- ID of affected entity
    changes TEXT,                          -- JSON diff (only changed fields)
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES user(id)
);

CREATE INDEX IF NOT EXISTS idx_audit_course ON audit_entry(course_id);
CREATE INDEX IF NOT EXISTS idx_audit_created ON audit_entry(created_at DESC);
```

Note: We use LEFT JOIN in queries so audit entries remain even if user is deleted.
The user_id references user but deleted users show as "[Deleted User]" in feed.
  </action>
  <verify>sqlite3 -init instance/schema.sql :memory: ".schema audit_entry" shows all columns</verify>
  <done>Audit entry table with efficient indexing for feed queries</done>
</task>

<task type="auto">
  <name>Task 2: Create AuditEntry model and utilities</name>
  <files>src/collab/audit.py</files>
  <action>
Create src/collab/audit.py with:

1. Action constants (for consistency):
   ```python
   # Content actions
   ACTION_CONTENT_CREATED = "content_created"
   ACTION_CONTENT_UPDATED = "content_updated"
   ACTION_CONTENT_DELETED = "content_deleted"
   ACTION_CONTENT_GENERATED = "content_generated"
   ACTION_CONTENT_APPROVED = "content_approved"

   # Structure actions
   ACTION_STRUCTURE_ADDED = "structure_added"
   ACTION_STRUCTURE_UPDATED = "structure_updated"
   ACTION_STRUCTURE_DELETED = "structure_deleted"
   ACTION_STRUCTURE_REORDERED = "structure_reordered"

   # Collaborator actions
   ACTION_COLLABORATOR_INVITED = "collaborator_invited"
   ACTION_COLLABORATOR_JOINED = "collaborator_joined"
   ACTION_COLLABORATOR_REMOVED = "collaborator_removed"
   ACTION_COLLABORATOR_ROLE_CHANGED = "collaborator_role_changed"

   # Course actions
   ACTION_COURSE_CREATED = "course_created"
   ACTION_COURSE_UPDATED = "course_updated"
   ACTION_COURSE_EXPORTED = "course_exported"
   ACTION_COURSE_PUBLISHED = "course_published"
   ```

2. log_audit_entry(course_id, user_id, action, entity_type, entity_id=None, before=None, after=None):
   - Calculate diff using jsondiff if before and after provided
   - Store only the diff, not full documents
   - Insert into audit_entry table
   - Return AuditEntry instance

3. AuditEntry class:
   - Properties: id, course_id, user_id, action, entity_type, entity_id, changes, created_at
   - Additional properties for display: user_name, user_email (from JOIN)
   - Class methods:
     - `get_for_course(course_id, limit=50, offset=0)` - Paginated feed
     - `get_for_entity(course_id, entity_type, entity_id)` - History for specific entity
     - `get_by_user(course_id, user_id)` - Filter by user
   - Instance method: `to_dict()` - Serialize for API

4. get_activity_feed(course_id, limit=50, offset=0) function:
   - Fetch audit entries with user info via LEFT JOIN
   - Return list of dicts with:
     - action, entity_type, entity_id, created_at
     - user_name (or "[Deleted User]" if user gone)
     - summary (human-readable description from summarize_changes)

5. summarize_changes(action, entity_type, changes_dict) function:
   - Generate human-readable summary
   - Examples:
     - "Updated activity content and state"
     - "Added module 'Introduction'"
     - "Changed role for alice@example.com from Reviewer to Designer"
  </action>
  <verify>python -c "from src.collab.audit import log_audit_entry, get_activity_feed; print('Audit loaded')"</verify>
  <done>AuditEntry model with diff storage and activity feed</done>
</task>

<task type="auto">
  <name>Task 3: Create audit trail tests</name>
  <files>tests/test_audit.py, src/collab/__init__.py</files>
  <action>
Update src/collab/__init__.py to export AuditEntry, log_audit_entry, get_activity_feed, and action constants.

Create tests/test_audit.py with:

1. Test fixtures:
   - test_app, test_db, test_user from conftest pattern
   - test_course - Course for audit entries

2. Logging tests:
   - test_log_audit_entry_basic - Creates entry with action and entity
   - test_log_audit_entry_with_diff - before/after creates changes JSON
   - test_log_audit_entry_no_diff - No before/after means NULL changes

3. Diff efficiency tests:
   - test_diff_stores_only_changes - Full docs in, only diff stored
   - test_diff_handles_nested_objects - Nested changes captured
   - test_diff_handles_arrays - Array additions/removals captured

4. Query tests:
   - test_get_for_course_paginated - limit and offset work
   - test_get_for_course_ordered_by_newest - Most recent first
   - test_get_for_entity_filters - Only matching entity returned
   - test_get_by_user_filters - Only matching user returned

5. Activity feed tests:
   - test_activity_feed_includes_user_info - user_name populated
   - test_activity_feed_deleted_user - Shows "[Deleted User]"
   - test_activity_feed_has_summary - Human-readable summary

6. Summary generation tests:
   - test_summarize_content_update - Lists changed fields
   - test_summarize_structure_add - Shows entity name
   - test_summarize_collaborator_change - Shows user and role

7. Action constants tests:
   - test_all_action_constants_unique - No duplicates
  </action>
  <verify>pytest tests/test_audit.py -v</verify>
  <done>18+ tests covering audit logging, diff storage, and activity feed</done>
</task>

</tasks>

<verification>
1. Audit entry table has correct columns and indexes
2. Diffs stored efficiently using jsondiff
3. Activity feed queries return paginated results
4. Deleted users show as "[Deleted User]" in feed
5. Human-readable summaries generated for all action types
6. All tests pass
</verification>

<success_criteria>
- [ ] audit_entry table created with changes column for diffs
- [ ] log_audit_entry uses jsondiff for efficient storage
- [ ] get_activity_feed returns paginated results with user info
- [ ] Deleted user handling works (LEFT JOIN + fallback name)
- [ ] summarize_changes generates readable descriptions
- [ ] Action constants defined for all tracked operations
- [ ] 18+ tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/10-collaboration-roles/10-05-SUMMARY.md`
</output>
