---
phase: 10-collaboration-roles
plan: 04
type: execute
wave: 2
depends_on: ["10-01"]
files_modified:
  - instance/schema.sql
  - src/collab/comments.py
  - src/collab/__init__.py
  - tests/test_comments.py
autonomous: true

must_haves:
  truths:
    - "Comments can be added to activities or at course level"
    - "Comments support single-level threading (replies to comments, not replies to replies)"
    - "Comments can be resolved without being deleted"
    - "@mentions are parsed and stored as notifications"
  artifacts:
    - path: "src/collab/comments.py"
      provides: "Comment and Mention models with threading support"
      exports: ["Comment", "Mention", "parse_mentions"]
    - path: "instance/schema.sql"
      provides: "comment and mention tables"
      contains: "CREATE TABLE comment"
  key_links:
    - from: "src/collab/comments.py"
      to: "src/collab/models.py"
      via: "Collaborator for mention validation"
      pattern: "from src.collab.models import Collaborator"
---

<objective>
Create the commenting system with single-level threading and @mention notifications.

Purpose: Enable collaborators to discuss content items with threaded comments and mentions
Output: Comment and Mention models with threading, resolution, and notification support
</objective>

<execution_context>
@C:\Users\gpt30\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\gpt30\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-collaboration-roles/10-CONTEXT.md
@.planning/phases/10-collaboration-roles/10-RESEARCH.md
@.planning/phases/10-collaboration-roles/10-01-SUMMARY.md
@src/collab/models.py
@src/auth/db.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add comment and mention tables to schema</name>
  <files>instance/schema.sql</files>
  <action>
Add comment and mention tables to schema.sql:

```sql
-- Threaded comments (single-level threading)
CREATE TABLE IF NOT EXISTS comment (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    course_id TEXT NOT NULL,
    activity_id TEXT,                      -- NULL for course-level comments
    user_id INTEGER NOT NULL,
    parent_id INTEGER,                     -- NULL for top-level comments
    content TEXT NOT NULL,
    resolved INTEGER DEFAULT 0,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES user(id),
    FOREIGN KEY (parent_id) REFERENCES comment(id) ON DELETE CASCADE
);

CREATE INDEX IF NOT EXISTS idx_comment_course ON comment(course_id);
CREATE INDEX IF NOT EXISTS idx_comment_activity ON comment(activity_id);

-- Mention notifications
CREATE TABLE IF NOT EXISTS mention (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    comment_id INTEGER NOT NULL,
    user_id INTEGER NOT NULL,              -- Who was mentioned
    read INTEGER DEFAULT 0,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (comment_id) REFERENCES comment(id) ON DELETE CASCADE,
    FOREIGN KEY (user_id) REFERENCES user(id)
);

CREATE INDEX IF NOT EXISTS idx_mention_user ON mention(user_id);
```

Key design decisions:
- activity_id is NULL for course-level general discussion comments
- parent_id enables single-level replies (enforced in application code)
- resolved hides but doesn't delete comments
- Cascade delete on parent_id removes replies when parent deleted
  </action>
  <verify>sqlite3 -init instance/schema.sql :memory: ".schema comment" shows all columns</verify>
  <done>Comment and mention tables with proper foreign keys and indexes</done>
</task>

<task type="auto">
  <name>Task 2: Create Comment model with threading</name>
  <files>src/collab/comments.py</files>
  <action>
Create src/collab/comments.py with:

1. parse_mentions(text) function:
   - Regex pattern: r'@(?:"([^"]+)"|(\S+))'
   - Handles @username and @"User Name" formats
   - Returns list of mentioned strings (names or emails)

2. Comment class:
   - Properties: id, course_id, activity_id, user_id, parent_id, content, resolved, created_at, updated_at
   - Additional properties for display: author_name, author_email, replies (list)
   - Class methods:
     - `create(course_id, user_id, content, activity_id=None, parent_id=None)`:
       - Enforce single-level threading: if parent_id, check parent's parent_id is NULL
       - Raise ValueError("Cannot reply to a reply. Reply to the parent comment instead.") if trying to reply to reply
       - Insert comment, parse mentions, create Mention entries
       - Return Comment instance
     - `get_by_id(comment_id)` - Load single comment with author info
     - `get_for_course(course_id, include_resolved=False)` - Course-level comments only
     - `get_for_activity(course_id, activity_id, include_resolved=False)` - Activity comments
     - `get_with_replies(course_id, activity_id=None, include_resolved=False)`:
       - Fetch all comments for entity
       - Build hierarchy: top-level comments with 'replies' lists
       - Return list of top-level comments
     - `resolve(comment_id)` - Set resolved=1
     - `unresolve(comment_id)` - Set resolved=0
     - `update(comment_id, content)` - Update content and updated_at, re-parse mentions
     - `delete(comment_id)` - Hard delete (CASCADE removes replies)
   - Instance method: `to_dict()` - Serialize for API, includes replies if loaded

3. Mention class:
   - Properties: id, comment_id, user_id, read, created_at
   - Class methods:
     - `get_unread_for_user(user_id)` - All unread mentions for user
     - `mark_read(mention_id)` - Set read=1
     - `mark_all_read(user_id)` - Mark all mentions read for user
   - Instance method: `to_dict()` - Serialize for API

4. Helper function for Comment.create to handle mentions:
   - `_create_mentions(comment_id, course_id, author_id, content)`:
     - Parse mentions from content
     - Find collaborators on course matching mention strings (by name or email)
     - Exclude author (don't notify yourself)
     - Create Mention entries for each valid mention
  </action>
  <verify>python -c "from src.collab.comments import Comment, parse_mentions; print(parse_mentions('@alice @\"Bob Smith\"'))"</verify>
  <done>Comment model with single-level threading, resolution, and mention parsing</done>
</task>

<task type="auto">
  <name>Task 3: Create comment tests</name>
  <files>tests/test_comments.py, src/collab/__init__.py</files>
  <action>
Update src/collab/__init__.py to export Comment, Mention, parse_mentions.

Create tests/test_comments.py with:

1. Test fixtures:
   - test_app, test_db, test_user (from conftest pattern)
   - test_course - Course for comments
   - test_collaborator - User as collaborator on course
   - second_user, second_collaborator - Another user for mention tests

2. Mention parsing tests:
   - test_parse_mentions_simple - @alice extracts "alice"
   - test_parse_mentions_quoted - @"Alice Smith" extracts "Alice Smith"
   - test_parse_mentions_multiple - Multiple mentions parsed
   - test_parse_mentions_empty - No mentions returns empty list

3. Comment creation tests:
   - test_create_course_level_comment - activity_id=None works
   - test_create_activity_comment - activity_id specified
   - test_comment_has_author_info - author_name and author_email populated

4. Threading tests:
   - test_create_reply_to_comment - parent_id works for top-level comments
   - test_cannot_reply_to_reply - ValueError when parent has parent
   - test_get_with_replies_builds_hierarchy - Top-level with nested replies

5. Resolution tests:
   - test_resolve_comment - Sets resolved=1
   - test_get_excludes_resolved_by_default - Resolved comments hidden
   - test_get_includes_resolved_when_requested - include_resolved=True shows them

6. Mention notification tests:
   - test_comment_creates_mentions - Mention entries created for valid collaborators
   - test_mention_excludes_non_collaborators - Non-collaborators not notified
   - test_mention_excludes_self - Author not notified of own mention
   - test_get_unread_mentions - Returns only unread
   - test_mark_mention_read - Sets read=1

7. Update and delete tests:
   - test_update_comment_content - Content updated, updated_at changes
   - test_delete_comment_cascades_replies - Replies deleted with parent
  </action>
  <verify>pytest tests/test_comments.py -v</verify>
  <done>20+ tests covering comments, threading, resolution, and mentions</done>
</task>

</tasks>

<verification>
1. Comment table supports activity-level and course-level comments
2. Single-level threading enforced (replies to comments only)
3. Resolved comments hidden by default in queries
4. @mentions parsed from content text
5. Mentions create notifications for valid collaborators
6. Cascade delete removes replies with parent
7. All tests pass
</verification>

<success_criteria>
- [ ] comment table has activity_id, parent_id, resolved columns
- [ ] mention table links comments to mentioned users
- [ ] parse_mentions handles @name and @"Quoted Name" formats
- [ ] Comment.create enforces single-level threading
- [ ] Comment.get_with_replies builds correct hierarchy
- [ ] Mentions created only for course collaborators
- [ ] Author excluded from their own mention notifications
- [ ] 20+ tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/10-collaboration-roles/10-04-SUMMARY.md`
</output>
